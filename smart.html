<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
<title>SMART IoT Messaging</title>
<link rel="SHORTCUT ICON" href="https://idogwatch.com/iDogWatch.png" type="image/png" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://SemanticMarker.org/semanticStyle.css">

</head>

<style>
/* https://www.w3schools.com/css/css_tooltip.asp */
.tooltip .tooltiptext {
  top: -5px;
  left: 105%;
}

/* Tooltip container */
.tooltip {
  position: relative;
  display: inline-block;
}

/* Tooltip text */
.tooltip .tooltiptext {
  visibility: hidden;
  width: 160px;
  background-color: black;
  color: #fff;
  text-align: center;
  padding: 5px 0;
  border-radius: 6px;

  /* Position the tooltip text - see examples below! */
  position: absolute;
  z-index: 1;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
  visibility: visible;
}

</style>

<script>

//NOTE: splitting the iDogWatch.com from SemanticMarker.org .. 
//  6.11.23 the UserDB that node-red reads from is a COPY of the master if 
//  run seperately (split).

var _semanticMarkerFlowURL = "https://SemanticMarker.org/bot/";

// this is before moving to the new smart deck..
var _useOldSMARTDeck = true;

//var _semanticMarkerFlowURL = "http://localhost:1880/";
//var _semanticMarkerFlowURL = "http://localhost:2001/";

//! address of the rootBotURL (iDogwatch.com right now)
var _rootBotURL = "https://iDogWatch.com/bot";


// BELOW: defines var _rootBotURL = "https://iDogWatch.com/bot";
//   These are all the "messages"   vs localhost:1880 
// NOTE: these can modify the agent (but are done by the AWS instance)
//NOTE: 'addUser' and 'adddevice' could be sent to the SemanticMarker.org bot as well (a duplicate, or at least
// and in-sync version  (versus a duplicate)

// Change to TRUE on the final version.. AND uncomment out the _devicesJSON (since the JSON cannot use a " "
//let _useFinal = true;
let _useFinal = false;
var _username = null;
var _password = null;
var _word;
var _saveUserInfo;
var _devicesJSON =  [{"deviceName":"_GENERIC_"},{"deviceName":"ScoobyDoo"},{"deviceName":"PumpkinUno"},{"deviceName":"GreyGoose"},{"deviceName":"DukeGEN3"},{"deviceName":"HowieFeeder"}, {"deviceName":"M55"}, {"deviceName":"M5Rainier"}, {"deviceName":"LauraBabe"}, {"deviceName":"M522"}, {"deviceName":"M5Rainier"}, {"deviceName":"M5WRR"},{"deviceName":"MoonShot"},{"deviceName":"LacieUSBC"}];

//Array of: [uuid, deckname, deckcat, deckpassword, date]
var _smartDecks = [];

//! initialize when refreshing after logoff
function initGlobals()
{
  _smartDecks = [];
  _devicesJSON = [];
  _username = "";
  _password = "";
  _word = "";
  _UUIDNumbers = [];

  //clear out  the SMART Deck
  document.getElementById('_UUID_Select').innerHTML = "";
  document.getElementById('flowsSM').innerHTML = "";
}

// checks username password have values ..
function validUserInfo()
{
   if (_username && _username.length > 0 && 
	    _password && _password.length > 0)
		 return true;
	else 
	    return false;

}

if (_useFinal)
{
   _username = "{{req.params.NAME}}";
   _password = "{{req.params.PASSWORD}}";
   _word = "{{req.params.guestPassword}}";
	// userInfo == "super" or "normal"
   _saveUserInfo = "{{req.params.userinfo}}";

	// ***** manually uncommend out the following.. ****
    //_devicesJSON = {{{payload.devicenames}}};
	 //_smartDecks = {{{payload.smartDecksJSON}}};
}
else
{

    //_username = "scott@konacurrents.com";
    //_password = "pass";
    //_username = "test";
    //_password = "test";

    _word = "doggy";
     _devicesJSON =  [{"deviceName":"_GENERIC_"},{"deviceName":"ScoobyDoo"},{"deviceName":"PumpkinUno"},{"deviceName":"GreyGoose"},{"deviceName":"DukeGEN3"},{"deviceName":"HowieFeeder"}, {"deviceName":"M55"}, {"deviceName":"M5Rainier"}, {"deviceName":"LauraBabe"}, {"deviceName":"M522"}, {"deviceName":"M5Rainier"}, {"deviceName":"M5WRR"},{"deviceName":"MoonShot"},{"deviceName":"LacieUSBC"}];

	  //_smartDecks = [{"uuid":"OvdEK4Ks_j2Z","deckname":"marker1","deckcat":"LegacyMarkers","deckpassword":"darwin","date":1679955654862}];

}

//TODO: make it like the _flowJSON
var _UUIDNumbers = [];

// modified by Base64 or Pulldown
var _deviceName;
var _isSendToAll;
// This has to be in sync with mainModule.h
var _lastSMPage = "sm14";

//! variables (fixed right now) for the Semantic Marker parameters
//!@see https://github.com/konacurrents/KSQRAvatar/issues/54
//! This is returned when creating a SM user..
var _SemanticMarker_UUID = "soIZ1iH7FK";

// currently these are hardwired and must be lock step ([0] == username, and [0] == _username)
// eg.  [{"USERNAME":_username},{"PASSWORD",_password}]
var _SemanticMarkerParameters = ["USERNAME","PASSWORD"];
var _SemanticMarkerValues = [_username, _password];

//! called to set the values .. after they are known
function setSemanticMarkerUserPasswordValues()
{
  _SemanticMarkerValues = [_username, _password];
}

//! the delay in seconds
var _commandDelay;
//! last run number
var _nextRunCommand;
//! count of commands
var _maxRunCommands;

//! logout .. erases cookies
function logout()
{
    alert("This logs you out so next time you have to enter password and optionally a different username");
	 _username = "";
    _password = "";
	 saveCookies();
	// requestLoginWindow(true);

	document.getElementById("_Login").hidden = false;

	//initGlobals();

	// do a full page reload .. hopefully that clears the screen
   location.reload();
	//initWebPage();
}

//! login
function login()
{
   //requestLoginWindow(true);
   location.reload();
}

//! try a login. 
//! Cannot hide password yet: https://stackoverflow.com/questions/9554987/how-can-i-hide-the-password-entered-via-a-javascript-dialog-prompt
function requestLoginWindow(doReadCookies)
{
	if (doReadCookies)
	  readCookies();

	// basically is password is null then ask for both.. but reuse the username
	// but if username null do it too
   if (!validUserInfo())
	{
      let username = prompt("Please enter your username: ",_username);
	   _username = username;

	   let password = prompt("Please enter password","");
	   _password = password;
	}

	saveCookies();

   reloadUserAgent();

}

/* ******************************  End Globals ****************** */

// 3.27.23
// update the _UUID_Select with the options..
//   uses global _smartDecks  so that needs to be updated 
//   on a refresh on new SmartDeck and on "Get User SM Flows"
function parseSmartDecks(agentUUID)
{
      // update the selection ..
	   // _UUID_Select
	   var uuidSelect = document.getElementById('_UUUID_Select');
   
	   // Category
	   //    Name (UUID)
	   //    Name2 (UUID)
	   // Category 

		//!Try sorting by Category, then Num
		//! https://stackoverflow.com/questions/4833651/javascript-array-sort-and-unique
		//! First find the categories..
		var deckCategories = []; //deckCat
		var uuidNumbers = []; //UUID
		var deckNames = []; 

		// create a new smartDecks with the main agent included..
		var allDecks = _smartDecks;
		var mainAgentCategory = "Main Agent";

// this is created already in the conversion to SMUsers DB
if (_useOldSMARTDeck)
{
		var alreadyAdded = false;
		// see if already done...
		for (var i=0; i< allDecks.length; i++)
		{
		   if (allDecks[i].uuid == agentUUID)
		   {
				alreadyAdded = true;
			   break;
			}
		}

		if (!alreadyAdded)
		{

		  // add main deck.. at the front..
		  allDecks.push(
		      {
			    "uuid":agentUUID,
			    "deckcat": mainAgentCategory,
			    "deckname":"Root"
			    });
		}
}

		// the main agent isn't in the smart decks .. so add it..
	   for (var i=0; i< allDecks.length;i++)
	   {
	      var deck = allDecks[i];
		   var uuid = deck.uuid;
			var deckCategory = deck.deckcat;
			var deckName = deck.deckname;
			deckCategories.push(deckCategory);
			uuidNumbers.push(uuid);
			deckNames.push(deckName);
		}
		//!alphebet sort
		deckCategories.sort();

		//!alphebet sort
		deckNames.sort();

		//! sort numbers so 10 and 100 are in right order (Actually not used as the NAME is the sort)
		//! https://stackoverflow.com/questions/1063007/how-to-sort-an-array-of-integers-correctly
		uuidNumbers.sort(function(a,b) { return a-b; });

		// now make them unique (new Set) and back to an array
		deckCategories = Array.from(new Set(deckCategories));

		//sort
		deckCategories.sort();

		//how to make the Main one first?? TODO..
		// Will remove it.. then add to the front..
		var mainIndex = deckCategories.indexOf(mainAgentCategory);

		// remove
		deckCategories.splice(mainIndex, 1);

		// add to front 
		deckCategories.unshift(mainAgentCategory);
		
		uuidNumbers = Array.from(new Set(uuidNumbers));
		deckNames = Array.from(new Set(deckNames));


      flowsHTML = "";

		//! groups: https://stackoverflow.com/questions/17316540/make-some-options-in-a-select-menu-unselectable
		for (deckCategory of deckCategories)
		{
			flowsHTML += "<optgroup label='" + deckCategory + "'>" + "\n";

			for (deckName of deckNames)
			{
            for (var i =0; i< allDecks.length; i++)
		      {
			      var deck = allDecks[i];
					thisUUID = deck.uuid;
					thisDeckCat = deck.deckcat;
					thisDeckName = deck.deckname;

					// only continue if same deck category
					if (thisDeckCat.localeCompare(deckCategory) != 0)
					   continue;

					// only continue if same deck name
					if (thisDeckName.localeCompare(deckName) != 0)
					   continue;

					// now we are the correct deckCategory, and deckName
		         for (uuidNum of uuidNumbers)
				   {
						if (!thisUUID)
						   continue;

					   if (thisUUID.localeCompare(uuidNum) != 0)
						   continue;

						// Finally output an option  (name:UUID)
			         flowsHTML += "<option value='" + thisUUID + "'>" + thisDeckName + " (" + uuidNum + ")" + "</option>\n";
   
				   }
				}

			}
			flowsHTML += "</optgroup> \n";
		}

		//update the html select _UUID_Select
	   document.getElementById('_UUID_Select').innerHTML = flowsHTML;


		//5.6.23 
		// Store the _UUID's of this Agent. Then if we traverse to another Smart DECK
		// From a different user (such as through inheritance), it won't think is
		// can save (without cloning).
		// NOTE: if we clone, then it would be nice to fix the parent - to now point to this one..

		_UUIDNumbers = uuidNumbers;
}

// 2048 characters on the URL max..
//!invoke the urlID
function invokeURL(url)
{
	window.open(url);
}

//!invoke the urlID
function invokeURLid(urlID)
{

   var url = document.getElementById(urlID).value;
	//! use the web format
	url += "&format=web";
	window.open(url);
	//callGetCommand(url);
}
/* ******** START NOT USED 

//TODO.. get the RUN SemanticMarkers working...
//! make web get call
function callGetCommand(url)
{
   var xhttp = new XMLHttpRequest();

	//!https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/readystatechange_event
   xhttp.onreadystatechange = function() {
		// called when open is finished
      if (this.readyState == 4 && this.status == 200)
	   {
      }
   };
   //! shows the command at this element
   document.getElementById('_commandRunText').value = url;

   xhttp.open("GET", url, true);
   xhttp.send();
}

//! array of links for the flow
var _finalLinkArray;

//!runSemanticMarkers (recursive after the next delay) until max is hit
function runSemanticMarkers()
{
   _commandDelay = document.getElementById('_delayAmountId').value;

	if (_nextRunCommand >= _maxRunCommands)
	{
		alert("Finished running commands");
		_nextRunCommand = 0;
	   return;
	}

   // grab the next run command (from the select)
	var command = _finalLinkArray[_nextRunCommand];
	_nextRunCommand++;

	// call it..
   callGetCommand(command);

	//recurse
	var delayInMilliseconds = _commandDelay * 1000;
	setTimeout(function()
	{
	   runSemanticMarkers();
	}, delayInMilliseconds);
}


//!runSemanticMarker
//@param linkId == <select option array>
function runSemanticMarker(linkId)
{
   // this uses the parameters .. rep
	//var command = document.getElementById(linkId).value;
   //callGetCommand(command);

	//set default
	_nextRunCommand = 0;

	 // the array of commands
    _finalLinkArray = [];

	 // commands = option array
	 var commands = document.getElementById(linkId);

	 //! foreach arg.. replace the Parameter with the equilivent instance (eg. password -> _password)
	 for (var i=0; i< commands.length; i++)
	 {
        var command = commands[i].innerHTML;
		  _finalLinkArray.push(command);
	 }

	//set max
	_maxRunCommands = _finalLinkArray.length;

	//
	runSemanticMarkers();
}

********* END  not used ********/

//!invoke the urlID, but tack on the extraURL
function invokeURLid2(urlID, extraURL)
{

   var url = document.getElementById(urlID).value;
	url = url + extraURL;
	window.open(url);
	//callGetCommand(url);
}

//! gets and saves UUID
//! global:  _uuidStringText
function updateSemanticMarkerUUID()
{
  var uuid = document.getElementById('_uuidStringText').value;
   _SemanticMarker_UUID = uuid;
}

//! strips spaces, but supports numbers letters and _ 
function createValidDeviceName(deviceName)
{

	// replace NOT of these  NOTE: "_" is NOW allowed.  9.5.23
   var name = deviceName.replace(/[^a-zA-Z0-9_]/g, "");
	return name;
}

//!strip spaces (THis is wrong.. it only removes the start/end spaces
function stripSpaces(cmd)
{
   //cmd = cmd.trim();
	//! https://stackoverflow.com/questions/5963182/how-to-remove-spaces-from-a-string-using-javascript
	cmd = cmd.replace(/\s/g, '');
	return cmd;

}

//! strips spaces, but supports numbers letters and _ 
function createValidFlowName(flowName)
{

	// replace NOT of these 
   var name = flowName.replace(/[^a-zA-Z0-9_]/g, "");
	return name;
}

//! changes a string to replace spaces with %20
function escapeSpacesInString(string)
{
	// need to escape the &  (as far as we know)
   //string = string.replace(/&/g,"\\&");
   string = string.replace(/ /g,"%20");
	return string;
}


//! changes a string to replace spaces with %20
//! ISSUE: https://stackoverflow.com/questions/11449577/why-is-base64-encode-adding-a-slash-in-the-result
function escapeBase64InString(string)
{
  // When received, to atob(str)
  //  then str = decodeURIComponent(atob(str))

	// escape the URI first..
	var moreString2 = encodeURIComponent(string);
	// Then the btoa doesn't have "/" in it..
	var s2 = btoa(moreString2);
	return s2;

	// need to escape the &  (as far as we know)
   //string = string.replace(/&/g,"\\&");
	//var moreString = btoa(string);
   //string = moreString;
   //string = string.replace(/ /g,"%20");
	//return string;
}

// object = {"SM":sm,"img":<img src=... }
var _base64Images = [];

//! 5.9.23 call the getSM/UUID/FLOW  and when 
//! it returns, store the <img src=base64 ..
//! gets or creates a UUID for existing user "/createuuid"
function requestBase64Image(uuid, flowNum)
{
  let thisSM = createSM(uuid, flowNum);
  var command = _semanticMarkerFlowURL + "getSM/" + uuid + "/" + flowNum ;

  //! see if already cached..
  for (let i=0;i < _base64Images.length; i++)
  {
     if (thisSM.localeCompare(_base64Images[i].SM)==0)
	  {
	     console.log("Already grabbed _base64Image for: " + thisSM);
		  return;
	  }
  }

  // create placeholder
  var object = {"SM":thisSM,"img":null};

  //add to the list being requested
  _base64Images.push(object);

  var xhttp = new XMLHttpRequest();

  // update the wait count
  changeWaitingCount();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
		//!result is the USER object (not the SemanticMaker object)
		var jsonReply = this.responseText;

	//	console.log("reply: " + jsonReply);
		if (jsonReply && jsonReply.indexOf("error") >= 0)
		{

         alert(jsonReply);
			return;
		}
		if (jsonReply.length == 0 )
		{

         alert("You must login to your agent");
			return;
		}

       //! update the outstanding request for this image
       for (let i=0;i < _base64Images.length; i++)
       {
          if (thisSM.localeCompare(_base64Images[i].SM)==0)
	       {
		       _base64Images[i].img = jsonReply;
	       }
       }

       // update the wait count
       changeWaitingCount();

    }
  };
  xhttp.open("GET",command, true);
  xhttp.send();
}

//! gets the smartDecks of the user 6.13.23
// if (!_useOldSMARTDeck)  .. still working the transition (this isn't in SM.org yet)
function getSMSmartDecks(uuidStringTextId)
{
  var command = _semanticMarkerFlowURL + "getuserdecks/" + _username + "/" + _password ;

  var xhttp = new XMLHttpRequest();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
		//!result is the USER object (not the SemanticMaker object)
		var jsonReply = this.responseText;

		console.log("reply: " + jsonReply);
		if (jsonReply && jsonReply.indexOf("error") >= 0)
		{

         alert(jsonReply);
			return;
		}
		if (jsonReply.length == 0 )
		{

         alert("You must login to your agent");
			return;
		}

      var userJSON = JSON.parse(jsonReply);
		// grab array of smart decks
		//var smartDecks = userJSON.smartDecks;
		smartDecks = userJSON;
		_smartDecks = smartDecks;

		//var uuid = userJSON.uuid;
      //document.getElementById(uuidStringTextId).value = uuid;

	   // update the deck options  
      parseSmartDecks(null);
    }
  };
  xhttp.open("GET",command, true);
  xhttp.send();
}


//! gets or creates a UUID for existing user "/createuuid"
function getSMUserUUID(uuidStringTextId)
{
  if (!validUserInfo())
     return;

  var command = _semanticMarkerFlowURL + "createuuid/" + _username + "/" + _password ;

  var xhttp = new XMLHttpRequest();

  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
		//!result is the USER object (not the SemanticMaker object)
		var jsonReply = this.responseText;

		console.log("reply: " + jsonReply);


      var userJSON = JSON.parse(jsonReply);
		var uuid = userJSON.uuid;
      document.getElementById(uuidStringTextId).value = uuid;

	   // update the deck options  (Call from getSMUserUUID...
      parseSmartDecks(uuid);
    }
  };
  xhttp.open("GET",command, true);
  xhttp.send();
}

//!create the list of devices.. Fill in the idDeviceListOptions (which has the select already formed)
function createDeviceListOptions(idDeviceListOptions)
{

  var htmlSelect = "";
  htmlSelect += "<option value='NO_ONE'>NO_ONE</option>";
  htmlSelect += "\n";
  htmlSelect += "<option value='--ALL--'>--ALL--</option>";
  htmlSelect += "\n";

  // used for sorting later..
  var deviceNames = [];

  // go through list, but dont include GENERIC and DEFAULT
  for (var i =0; i< _devicesJSON.length; i++)
  {
		  //Not sorting yet..
        let deviceName = _devicesJSON[i].deviceName;
        if ("_GENERIC_".localeCompare(deviceName)!=0 && "_DEFAULT_".localeCompare(deviceName) != 0)
        {
			 deviceNames.push(deviceName);
		  }
	}

	//now sort
	deviceNames.sort();
   for (var i =0; i< deviceNames.length; i++)
   {
     let deviceName = deviceNames[i];

	  // create option for the deviceName
     htmlSelect += "<option value='" + deviceName + "'>" + deviceName + "</option>";
     htmlSelect += "\n";
   }

  document.getElementById(idDeviceListOptions).innerHTML = htmlSelect;
}

//! just sent all for FEED and CAPTURE, using send: feed
function sendAllCommand(command, cmd)
{
	_isSendToAll = true;
	var commandPath = getCommandPath(command);

   sendGETCommand(commandPath + "/" + cmd);
}

//! returns string up the argments..
//! sets up the device and isSendToAll
function setupDevice(idDevices)
{
   var deviceName = document.getElementById(idDevices).value;

	if ("--ALL--".localeCompare(deviceName)==0)
	   _isSendToAll = true;
	else
	   _isSendToAll = false;

	_deviceName = deviceName;
}

//! sets using the password provided, so can be user password or guest password
//! This uses knowledge of _isSentToAll, and _deviceName, and this command (which tacks on Device if needed)
function getCommandPathWithPassword(command,password)
{
  if (!validUserInfo())
     return;

  var commandPath = "";
  if (_isSendToAll)
  {
     commandPath = _rootBotURL + "/" + command + "/" + _username + "/" + password;
  }
  else
  {
	  //NOTE: lowercase all..
     command = command + "device";
     commandPath = _rootBotURL + "/" + command + "/" + _username + "/" + password + "/" +  _deviceName;
  }
  return commandPath;
}

//! Returns a SemanticMarker parameterized command string
//! This uses knowledge of _isSentToAll, and _deviceName, and this command (which tacks on Device if needed)
function getCommandPathWithSMParameters(command)
{
  var commandPath = "";
  if (_isSendToAll)
  {
     commandPath = _rootBotURL + "/" + command + "/" + _SemanticMarkerParameters[0] + "/" + _SemanticMarkerParameters[1];
  }
  else
  {
	  //NOTE: lowercase all..
     command = command + "device";
     commandPath = _rootBotURL + "/" + command + "/" + _SemanticMarkerParameters[0] + "/" + _SemanticMarkerParameters[1] + "/" +  _deviceName;
  }
  return commandPath;
}

//! This uses knowledge of _isSentToAll, and _deviceName, and this command (which tacks on Device if needed)
function getCommandPath(command)
{
  return getCommandPathWithPassword(command,_password);
}

//! This uses knowledge of _isSentToAll, and _deviceName, and this command (which tacks on Device if needed)
function getCommandPathGuest(command)
{
  return getCommandPathWithPassword(command,_word);
}

//! wraps the command no args, but this is sent as a guest
function sendNoArgsGuest(idDevices, idCmd)
{
	// one way: but not doing that here..
	// using  feedguestdevice/U/P/device
   // https://iDogWatch.com/bot/feedguestdevices/scott@konacurrents.com/GPASS?device=ScoobyDoo
	// sets _devices
	setupDevice(idDevices);


	// the command, which we might change below based on _isSendToAll
   var command = document.getElementById(idCmd).value;

	//eg.  feedguest<device>/USER/GPASS/<device>
	//feedguest/name/guest   or  feedguestdevice/name/guest/device
   // this will use guest password..
	var commandPath = getCommandPathGuest(command);

  //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath);
}

//! wraps the command no args
function sendNoArgs(idDevices, idCmd)
{
	setupDevice(idDevices);

	// the command. NOTE: there are some that use the "send" syntax still 5.4.23
	var cmd = document.getElementById(idCmd).value;
	var command = "cmd";
	if ("status".localeCompare(cmd)==0
	 || "temp".localeCompare(cmd)==0
	 || "capture".localeCompare(cmd)==0
	 || "volume".localeCompare(cmd)==0)
	   command = "send";

	var commandPath = getCommandPath(command);

	// bot/cmddevice/NAME/PASS/device/CMD

  //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath + "/" + cmd);
}

//! wraps the command no args. Send "feed" or "capture" for example without arguments
function sendCommandToDevice(idDevices, cmd)
{
	setupDevice(idDevices);

	// the command
	var command = "cmd";
	var commandPath = getCommandPath(command);

  //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath + "/" + cmd);
}

//! Special case sending any set:val commands
//!  set:cmd, val:arg
//! This version converts the val into base64, and the command is added with 64
function sendAnySetCommand64Both(idDevices, anySetCommandId, anySetValId, encodeQuery)
{
	// the command (base) .. device is tacked on 
	var command = "set64";
	if (encodeQuery)
	{
		// the _device global is updated to a base64 value
		// The name has to escape the spaces and | and & 
	   var device = document.getElementById(idDevices).value;

      device = device.replace(/&/g,"\\&");
      device = device.replace(/\|/g,"\\|");
      device = device.replace(/ /g,"\\ ");

      _deviceName =  escapeBase64InString(device);
		command += "query";
		// set64query
		// the global _isSendToAll is false for this encodeQuery
	   _isSendToAll = false;
	}
	else
	{
		// the global _isSendToAll is modified based on the idDevices state..
	   setupDevice(idDevices);
   }

	// encode the device as well.
	var commandPath = getCommandPath(command);

	var cmd = document.getElementById(anySetCommandId).value;
	// strip spaces on cmd..
   cmd = cmd.replace(/\s+/g, '');
	var arg = document.getElementById(anySetValId).value;
	// escape the spaces
   arg =  escapeBase64InString(arg);
   //arg = arg.replace(/\s+/g, '');

   //<!-- dawgpackTopicId used in the sendAnySetCommand64 --->
	var topicSet = document.getElementById('dawgpackTopicId').value;
   var isDawgpack = topicSet.localeCompare("dawgpack")==0;

	var path = commandPath + "/" + cmd + "/" + arg;
	if (isDawgpack)
	   path += "?topic=dawgpack";

   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
   sendGETCommand(path);
}

//! wraps the command no args
function sendNoArgsM5(idDevices, idCmd)
{
	setupDevice(idDevices);

	// the command
	var cmd = document.getElementById(idCmd).value;
	var command = "cmd";
	var commandPath = getCommandPath(command);


  //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath + "/" + cmd);
}

//! cycles through pages
function cycleM5Pages(idDevices, idCmd)
{
	 // known last page..
    var currentPage = document.getElementById(idCmd).value;
	 if (currentPage.localeCompare(_lastSMPage)==0)
	    currentPage = "sm0";
	 else
	 {
	    // get the number part:
		 var num = parseInt(currentPage.substring(2));
		 num ++;
		 currentPage = "sm" + num;
	 }
    document.getElementById(idCmd).value = currentPage;
	 sendNoArgsM5(idDevices,idCmd);
}

//! cycles through DocFollow
function cycleDOCFOLLOW(idDevices, idSet, idCmd, idTextField)
{
    var selectIndex = document.getElementById(idCmd).selectedIndex;
	 selectIndex++;

	 //! update the next in the list..
	 var max = document.getElementById(idCmd).options.length;
	 selectIndex = selectIndex % max;


    document.getElementById(idCmd).selectedIndex = selectIndex;

	 //!update the text field for show
	 docFollowChanged(idCmd, idTextField);
    //document.getElementById(idTextField).value = document.getElementById(idCmd).value;


	 //! invoke the set command
    sendAnySetCommand64(idDevices, idSet, idCmd);
}

//! each time the option changes
function docFollowChanged(idCommandArg, idTextField) 
{
    var option = document.getElementById(idCommandArg).value;

	 //!update the text field for show
    document.getElementById(idTextField).value = option;
}

//! cycles through colors (idArg == text)
function cycleM5ScreenColors(idDevices, idCmd, idArg)
{
    var cmd = document.getElementById(idCmd).value;
	 if (cmd.localeCompare("screencolor")!= 0)
	    return;

	 // known last color..
	 var maxColor = 5;
    var currentColor = document.getElementById(idArg).value;
	 currentColor++;
	 currentColor = currentColor % maxColor;
    document.getElementById(idArg).value = currentColor;
	 sendTextArgs(idDevices,idCmd,idArg);
}

//! wraps the command arg == setDevice 
//! if isBooleanArg, then this is a set:cmd, val:boolValue
//!  Otherwise it's a cmd:cmd{ON/OFF}
//! All commands here are on/off version
function sendBooleanArgs(idDevices, idCmd, idArg)
{
	//
	setupDevice(idDevices);

	// the command, either set or cmd
	var cmd = document.getElementById(idCmd).value;
	var arg = document.getElementById(idArg).value;
	var commandPath = "";

	//! command  set:cmd, val:val
	//!    setDevice/n/u/d/CMD/VAL
   command = "set";
	commandPath = getCommandPath(command) + "/" + cmd + "/" + arg;

  //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath);
}

//! wraps the command arg == setDevice 
//! if isBooleanArg, then this is a set:cmd, val:boolValue
//!  Otherwise it's a cmd:cmd{ON/OFF}
function sendBooleanArgsOLD(idDevices, idCmd, idArg)
{
	//
	setupDevice(idDevices);

	// the command, either set or cmd
	var cmd = document.getElementById(idCmd).value;
	var arg = document.getElementById(idArg).value;
	var isBooleanArg = "gen3only".localeCompare(cmd)==0 || 
	                   "minMenu".localeCompare(cmd)==0 || 
	                   "maxMenu".localeCompare(cmd)==0  ||
	                   "bleusedevicename".localeCompare(cmd)==0  ||
	                   "bleusepaireddevicename".localeCompare(cmd)==0 
							 ;
	var commandPath = "";

   if (isBooleanArg)
	{
      sendBooleanArgs(idDevices, idCmd, idArg)
		//! command  set:cmd, val:val
		//!    setDevice/n/u/d/CMD/VAL
      //command = "set";
	   //commandPath = getCommandPath(command) + "/" + cmd + "/" + arg;
	}
	else
	{
		//OLD WAY .. to be deprecated
	   //! set/u/p/[device]/cmd/arg
		// tack onto the cmd, eg. buzzon
	   if ("on".localeCompare(arg)==0)
	      cmd += "On";
	   else
	      cmd += "Off";
		command = "cmd";
	   commandPath = getCommandPath(command) + "/" + cmd;

      sendGETCommand(commandPath);
	}

  //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  //sendGETCommand(commandPath);
}

//! wraps the command arg == setDevice 
//!  set:cmd, val:arg
function sendTextArgs(idDevices, idCmd, idArg)
{
	setupDevice(idDevices);

	// the command
	var command = "set";
	var commandPath = getCommandPath(command);

	var cmd = document.getElementById(idCmd).value;
	var arg = document.getElementById(idArg).value;
	// strip spaces on arg..

	if ("location".localeCompare(cmd)==0)
      arg = escapeSpacesInString(arg);
	else
      arg = arg.replace(/\s+/g, '');


	// if an empty string then use special _EMPTY_ keyword 
	// to be converts by node-red back to ""
	if (arg.localeCompare("")==0)
	   arg = "_EMPTY_";

   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath + "/" + cmd + "/" + arg);
}


//! wraps the command arg == setDevice 
//!  set:cmd, val:arg
function showSemanticMarker(idDevices)
{
	setupDevice(idDevices);

	// the command
	var command = "set";
	var commandPath = getCommandPath(command);

	var cmd = "SMZoom";
	var arg = "on";
	// strip spaces on arg..
   arg = arg.replace(/\s+/g, '');


   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
   sendGETCommand(commandPath + "/" + cmd + "/" + arg);
}

//! test update for OTATarget (M5, ESP-BOARD, ESP-ORIG)
function updateOTATest(idDevices, OTATarget)
{
   
   var deviceName = document.getElementById(idDevices).value;

   //if (confirm("Confirm: OTA of " + OTATarget + "\nFor Device: " + deviceName + "\nThis takes about 2 to 5 minutes") == true)
	//{
   	setupDevice(idDevices);
   
   	//rootOTAFile
   	var command = "rootOTAFile";
   	var commandPath = getCommandPath(command);
   
   	// now tack on the rest..  ROOT and the VAL
   	if (OTATarget.localeCompare("M5")==0)
   	{
         // M5
   		commandPath += "/M5/ESP_IOT.ino.m5stick_c_plus.bin";
   	}
   	else if (OTATarget.localeCompare("M5Camera")==0)
   	{
         // M5
   		commandPath += "/M5/ESP_IOT.ino.m5stack_timer_cam.bin";
   	}
      //new 9.27.23 for  M5 QR Reader
      else if (OTATarget.localeCompare("M5QRReader")==0)
      {
         // M5QRReader
         commandPath += "/M5QRReader/ESP_IOT.ino.m5stick_c_plus.bin";
      }
   	else if (OTATarget.localeCompare("ESP-ORIG")==0)
   	{
         // ORIG
   		commandPath += "/ORIG/ESP_IOT.ino.esp32.bin";
   	}
   	else if (OTATarget.localeCompare("ESP-BOARD")==0)
   	{
         // BOARD
   		commandPath += "/OTA_Board/ESP_IOT.ino.esp32.bin";
   	}


		//QA Versions
   	else if (OTATarget.localeCompare("QA_M5")==0)
   	{
         // M5
   		commandPath += "/QA_M5/ESP_IOT.ino.m5stick_c_plus.bin";
   	}
   	else if (OTATarget.localeCompare("QA_ESP-BOARD")==0)
   	{
         // BOARD
   		commandPath += "/QA_OTA_Board/ESP_IOT.ino.esp32.bin";
   	}

		//Main Versions
   	else if (OTATarget.localeCompare("MAIN_M5")==0)
   	{
         // M5
   		commandPath += "/MAIN/ESP_IOT.ino.m5stick_c_plus.bin";
   	}
   	else if (OTATarget.localeCompare("MAIN_ESP-BOARD")==0)
   	{
         // BOARD
   		commandPath += "/MAIN/ESP_IOT.ino.esp32.bin";
   	}

		else
		{
		   alert("Unknown OTA Target: " + OTATarget);
		}

 if (confirm("Confirm: OTA of " + OTATarget + "\n\nFor Device: " + deviceName + "\n\n" + commandPath + "\n\n\nThis takes about 2 to 5 minutes") == true)
   {
		//!NOTE: the node-red is looking for 2 argument (eg. MAIN / bin)
		//! Also, on KnowledgeShark.org/OTA there is a TEST and all these are based off TEST.. 
		//! NOTE: that isn't the usual spot for the default build.


		//! Result file will be at: 
		//!  http://KnowledgeShark.org/OTA/TEST/<command path>
   
      //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
      sendGETCommand(commandPath);

	}

}

//! Special case for renaming a device when the device name isn't in the list.. as it was already renamed
//! wraps the command arg == setDevice 
//!  set:cmd, val:arg
function sendRenameDevice(idDeviceToRename, idDeviceNewName)
{
   // strip the device name in case..
	var oldName = document.getElementById(idDeviceToRename).value;
   oldName = oldName.replace(/\s+/g, '');
	document.getElementById(idDeviceToRename).value = oldName;


	// now call the common setupDevice
	setupDevice(idDeviceToRename);

	// the command
	var command = "set";
	var commandPath = getCommandPath(command);

	var cmd = "device";
	var arg = document.getElementById(idDeviceNewName).value;
	// strip spaces on arg..
   arg = arg.replace(/\s+/g, '');

	// if an empty string then use special _EMPTY_ keyword 
	// to be converts by node-red back to ""
	if (arg.localeCompare("")==0)
	   arg = "_EMPTY_";

   //! sends command on HTTP
   sendGETCommand(commandPath + "/" + cmd + "/" + arg);
}

//! Special case sending any set:val commands
//!  set:cmd, val:arg
function sendAnySetCommand(idDevices, anySetCommandId, anySetValId)
{
	setupDevice(idDevices);

	// the command
	var command = "set";
	var commandPath = getCommandPath(command);

	var cmd = document.getElementById(anySetCommandId).value;
	// strip spaces on cmd..
   cmd = cmd.replace(/\s+/g, '');
	var arg = document.getElementById(anySetValId).value;
	// escape the spaces
   arg =  escapeSpacesInString(arg);
   //arg = arg.replace(/\s+/g, '');

	// if an empty string then use special _EMPTY_ keyword 
	// to be converts by node-red back to ""
	if (arg.localeCompare("")==0)
	   arg = "_EMPTY_";


   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath + "/" + cmd + "/" + arg);
}

//! Special case sending any set:val commands
//!  set:cmd, val:arg
//! THese use the values passed in for 2nd and 3rd parm
function sendAnySetCommand2(idDevices, anySetCommand, anySetVal)
{
	setupDevice(idDevices);

	// the command
	var command = "set";
	var commandPath = getCommandPath(command);

	var cmd = anySetCommand;
	// strip spaces on cmd..
   cmd = cmd.replace(/\s+/g, '');
	var arg = anySetVal;

	// escape the spaces
   arg =  escapeSpacesInString(arg);
   //arg = arg.replace(/\s+/g, '');

	// if an empty string then use special _EMPTY_ keyword 
	// to be converts by node-red back to ""
	if (arg.localeCompare("")==0)
	   arg = "_EMPTY_";


   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath + "/" + cmd + "/" + arg);
}

//! Special case sending any set:val commands
//!  set:cmd, val:arg
//! This version converts the val into base64, and the command is added with 64
function sendAnySetCommand64(idDevices, anySetCommandId, anySetValId)
{
	//TODO refactor..
   sendAnySetCommand64Both(idDevices, anySetCommandId, anySetValId, false);
	return;
}

//! wraps the command arg == setDevice 
//!  set:cmd, val:"idSSID:idPassword"
function sendAddWIFITextArgs(idDevices, idSSID, idPassword)
{
	setupDevice(idDevices);

	// the command
	var command = "set";
	var commandPath = getCommandPath(command);

	var cmd = "addwifi";
	var ssid = document.getElementById(idSSID).value;
	var password = document.getElementById(idPassword).value;
	var arg = ssid + ":" + password;
	// strip spaces on arg..
   arg = arg.replace(/\s+/g, '');

	// if an empty string then use special _EMPTY_ keyword 
	// to be converts by node-red back to ""
	if (arg.localeCompare("")==0)
	   arg = "_EMPTY_";

   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
  sendGETCommand(commandPath + "/" + cmd + "/" + arg);
}

//! grab the QRAvatar first..
//! http://www.javascriptkit.com/javatutors/javascriptpromises.shtml
function getImage(url)
{
    console.log("getImage: " + url);
    return new Promise(function(resolve, reject)
	 {
        var img = new Image()
        img.onload = function()
		  {
            console.log("image.onload");
            resolve(url)
        }
        img.onerror = function()
		  {
            reject(url)
        }
        img.src = url
    })
}

//!create a semantic marker, and place at the idSM location
function createSemanticMarker(idDevices,idSemanticMarkerImageURL,idSM, idLabel)
{
	setupDevice(idDevices);

   // this will use guest password..
	var command = "feedguest";
	var commandPath = getCommandPathGuest(command);
	// feedguest<device>/USER/GPASS/<device>
   document.getElementById('_messageId').innerHTML = commandPath;

   var circular = document.getElementById('boolArgValueCircular').value=="on";

	var avatarURL = document.getElementById(idSemanticMarkerImageURL).value;

	//no avatarURL so use iDogWatch
   if (!avatarURL || avatarURL.length==0)
	{
	  //hard wire for now..
	  avatarURL = "https://idogwatch.com/pettutor/iDogWatch.png";
	}

	//empty the id first..
	//Seems that the call is adding a new SM instead of cleaning it up..
	document.getElementById(idSM).value = "";
	document.getElementById(idSM).html = "<p>x</p>";


   document.getElementById(idSM).innerHTML = "";

   console.log(idSM);
   console.log(document.getElementById(idSM));

	//! fix bug: https://itecnote.com/tecnote/javascript-qrcode-js-error-code-length-overflow-17161056/
	if (commandPath.length >= 192 && commandPath.length <= 220)
	{
      commandPath = commandPath + "&filler=";

      // pad to greater thatn 220
		var len = commandPath.length;
		while (commandPath.length <= 220)
		{
		   commandPath= commandPath + "x";
		}
	}

	try
	{
	   getImage(avatarURL).then
		(
		   function (successurl)
			{
	  
	         var sm = new SemanticMarker(document.getElementById(idSM),
	            commandPath,
			      avatarURL,
			      circular);
			}).catch (function (errorurl)
			{
 
		      alert("Issue creating QRAvatar in Semantic Marker creation: \n" + errorurl + "\n\nPlease file bug report"
				   + "\nsyntax including  # can be problematic");
			})
	}
	catch (error)
	{

		alert("Issue with Semantic Marker creation: \n" + error.message + "\nPlease file bug report");
	}

   document.getElementById(idLabel).innerHTML = commandPath;
}


//!create a semantic marker, and place at the idSM location
function createSemanticMarkerPath(commandPath, avatarURL, idSM, idLabel)
{
   var circular = document.getElementById('boolArgValueCircular').value=="on";

	//avatar URL
	//var url = document.getElementById(idSemanticMarkerImageURL).value;

	//no avatarURL so use iDogWatch
   if (!avatarURL || avatarURL.length==0)
	{
	  //hard wire for now..
	  avatarURL = "https://idogwatch.com/pettutor/iDogWatch.png";
	}

	//empty the id first..
	var previousSM = document.getElementById(idSM);
	//Seems that the call is adding a new SM instead of cleaning it up..
	document.getElementById(idSM).value = "";
	//document.getElementById(idSM).html = "<p>x</p>";
	document.getElementById(idSM).html = "<p >x</p>";

   document.getElementById(idSM).innerHTML = "";

   console.log(idSM);
   console.log(document.getElementById(idSM));

	//! fix bug: https://itecnote.com/tecnote/javascript-qrcode-js-error-code-length-overflow-17161056/
	if (commandPath.length >= 192 && commandPath.length <= 220)
	{
      commandPath = commandPath + "&filler=";

      // pad to greater thatn 220
		var len = commandPath.length;
		while (commandPath.length <= 220)
		{
		   commandPath= commandPath + "x";
		}
	}

	try
	{
	   getImage(avatarURL).then
		(
		   function (successurl)
			{
	  
	         var sm = new SemanticMarker(document.getElementById(idSM),
	            commandPath,
			      avatarURL,
			      circular);
			}).catch (function (errorurl)
			{
 
		      alert("Issue creating QRAvatar in Semantic Marker creation: \n" + errorurl + "\n\nPlease file bug report"
				  + "\nUrls with # and other special characters can be problematic");
			})

	}
	catch (error)
	{

		alert("Issue with Semantic Marker creation: \n" + error.message + "\nPlease file bug report");
	}

   document.getElementById(idLabel).value = commandPath;

}

//!create a semantic marker, and place at the idSM location
function createSemanticMarkerPathId(commandPathId, urlId ,idSM, idLabel)
{
   var commandPath = document.getElementById(commandPathId).value;
	var url = document.getElementById(urlId).value;
   if (!url || url.length==0)
	{
	   url = "https://SemanticMarker.org/images/SM-Circle-R.png"; 
	}
   createSemanticMarkerPath(commandPath, url ,idSM, idLabel);
}

//! BOT DEVICE MANAGEMENT (add, remove, rename)
//!adds the device (from the deviceName .. to the user)
function addDeviceNameBot(deviceNameId)
{

	//! this is so the 'device' isn't tacked on..
	_isSendToAll = true;

   // strip spaces
   var deviceName = document.getElementById(deviceNameId).value;
   deviceName = createValidDeviceName(deviceName);

   var command = "adddevice";
   var commandPath = getCommandPath(command);

   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
   sendGetCommand_thenAlert(commandPath + "/" + deviceName, "Added device: " + deviceName, true);
}

//!removes the device (from the deviceName .. to the user)
function removeDeviceNameBot(deviceNameId)
{
	//! this is so the 'device' isn't tacked on..
	_isSendToAll = true;

   // strip spaces
   var deviceName = document.getElementById(deviceNameId).value;
   deviceName = createValidDeviceName(deviceName);

   var command = "removedevice";
   var commandPath = getCommandPath(command);

   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
   sendGetCommand_thenAlert(commandPath + "/" + deviceName, "Removed device: " + deviceName, true);

}


//!renames the device (from the deviceName .. to the user)
function renameDeviceNameBot(deviceNameId, deviceNameNewId)
{
	//! this is so the 'device' isn't tacked on..
	_isSendToAll = true;

   var deviceNameNew = document.getElementById(deviceNameNewId).value;
   deviceNameNew = createValidDeviceName(deviceNameNew);

   // strip spaces
   var deviceName = document.getElementById(deviceNameId).value;
   deviceName = createValidDeviceName(deviceName);

   var command = "renamedevice";
   var commandPath = getCommandPath(command);

   //! https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send
   sendGetCommand_thenAlert(commandPath + "/" + deviceName + "/" + deviceNameNew, "Renamed device: " + deviceName + " to:" + deviceNameNew, true);
}
//!END DEVICE MANAGEMENT

//! sends the GET command, but shows an alert when done..
function sendGetCommand_thenAlert(command, alertString, doRefresh)
{
   var xhttp = new XMLHttpRequest();

	//!https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/readystatechange_event
   xhttp.onreadystatechange = function() {
		// called when open is finished
      if (this.readyState == 4 && this.status == 200) 
	   {
		   if (alertString && alertString.length > 0)
			{
		     alert(alertString);
           if (doRefresh)
			  {
			     //location.reload();
				  // 6.13.23 use the reload of agent data, not the web page
				  // Especially if the stateless version is used
              reloadUserAgent();
			  }
			}
      }
   };
  //! update the messageId too
  document.getElementById('_messageId').innerHTML = command;

//TRYING value (not innerHTML)
  // Update the text window..
  var recordedTextMessages = document.getElementById('_recordedMessages').value;
  recordedTextMessages += command + "\n";
  document.getElementById('_recordedMessages').value = recordedTextMessages;


  xhttp.open("GET", command, true);
  xhttp.send();
}

//! sends the GET command, but shows an alert when done..
function justSendGETCommand(command)
{
   var xhttp = new XMLHttpRequest();

	//!https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/readystatechange_event
   xhttp.onreadystatechange = function() {
		// called when open is finished
      if (this.readyState == 4 && this.status == 200) 
	   {
      }
   };

  xhttp.open("GET", command, true);
  xhttp.send();
}


//! set when to user the parameters
//! FOR NOW: since the command was already created,
//!   The command will be searched for the the values [0],[1] and replace with the parameters [0],[1]
var _useSemanticMarkerParameters = true;

//! Gets the command
//!  HERE is a device is mentioned .. add DEVICE for the current device.. TODO
function getParameterizedSemanticMarkerCommand(val, useSemanticMarkerParameters)
{
	//! the arg is the val passed in.. which is the complete command iDogwatch.com/bot/...
	var arg = val;

   //!   The command will be searched for the the values [0],[1] and replace with the parameters [0],[1]
	//! The issue: this arg is in the context of some random URL (not a SemanticMarker URL). So the parameters are in that context
	//! BUT: how do we get the SemanticMarker engine to manipulate and instantiate it?
	//!   It seems this URL must be wrapped AGAIN in base64 .. and that sent as a SemanticMarker to the SemanticMarker engine
	//!NOTE: the arguments USERNAME and PASSWORD are known to be the current users _username and _password

   if (useSemanticMarkerParameters)
	{
	   //! update the UUID
		updateSemanticMarkerUUID();

	   for (var i=0; i< _SemanticMarkerValues.length; i++)
		{
		   arg = arg.replace( _SemanticMarkerValues[i],_SemanticMarkerParameters[i]);
		}
      console.log("SemanticAddress cmd = " + arg);

		//!result is:
		//!   https://SemanticMarker.org/bot/sm/uuid/<UUID>/ ... rest of command ...
		//! NOTE: This assumes the final command goes through the SemanticMarker (versus some random location).

	   // escape the spaces. Convert to Base64
      arg = escapeBase64InString(arg);

		// Now create a new ARG , which contains the previous command (eg. dogwatch/feed already 
		// Modified to for the parameters (Username, password ..etc)
		// ??? Why is UUID needed? It seems the ARG has been intantiated.. the UUIR is used to get the parameters (not here yet)

		arg = "https://SemanticMarker.org/bot/sm/" + _SemanticMarker_UUID + "/" + arg;

	}

   return arg;

}

//! repeats the GET command as a semanticMarker Docfollow message (send to ALL)
//! pass the VAl of the URL just sent
function sendSemanticMarkerCommand(val)
{
	//! 9.28.23 going to add the "dev" to the send .. NO wildcard yet
	// send to all
//	_isSendToAll = true;

	//!setup the devices
   setupDevice('devices');

	// the command (base) .. device is tacked on 
	var command = "set64";

	// encode the device as well.
	var commandPath = getCommandPath(command);

	console.log("commandPath = " + commandPath);

   //var arg = getParameterizedSemanticMarkerCommand(val, _useSemanticMarkerParameters);
	//! the arg is the val passed in.. which is the complete command iDogwatch.com/bot/...
	var arg = val;

   //!   The command will be searched for the the values [0],[1] and replace with the parameters [0],[1]
	//! The issue: this arg is in the context of some random URL (not a SemanticMarker URL). So the parameters are in that context
	//! BUT: how do we get the SemanticMarker engine to manipulate and instantiate it?
	//!   It seems this URL must be wrapped AGAIN in base64 .. and that sent as a SemanticMarker to the SemanticMarker engine
	//!NOTE: the arguments USERNAME and PASSWORD are known to be the current users _username and _password

   if (_useSemanticMarkerParameters)
	{
	   //! update the UUID
		updateSemanticMarkerUUID();

	   for (var i=0; i< _SemanticMarkerValues.length; i++)
		{
		   arg = arg.replaceAll( _SemanticMarkerValues[i],_SemanticMarkerParameters[i]);
		}
      console.log("SemanticAddress cmd = " + arg);

		//!result is:
		//!   https://SemanticMarker.org/bot/sm/uuid/<UUID>/ ... rest of command ...
		//! NOTE: This assumes the final command goes through the SemanticMarker (versus some random location).

	   // escape the spaces. Convert to Base64
      arg = escapeBase64InString(arg);

		// Now create a new ARG , which contains the previous command (eg. dogwatch/feed already 
		// Modified for the parameters (Username, password ..etc)
		// ??? Why is UUID needed? It seems the ARG has been intantiated.. the UUID is used to get the parameters (not here yet)

		arg = "https://SemanticMarker.org/bot/sm/" + _SemanticMarker_UUID + "/" + arg;

	}

	// escape the spaces. Convert to Base64
   arg = escapeBase64InString(arg);

   //arg = arg.replace(/\s+/g, '');

   //<!-- dawgpackTopicId used in the sendAnySetCommand64 --->
	var topicSet = document.getElementById('dawgpackTopicId').value;
   var isDawgpack = topicSet.localeCompare("dawgpack")==0;

	var cmd = "SemanticMarker";

	var path = commandPath + "/" + cmd + "/" + arg;
	if (isDawgpack)
	   path += "?topic=dawgpack";

	console.log("path = " + path);


   //sendGETCommand(path);  (Cannot.. recursion..)
   sendGetCommand_thenAlert(path,"", false);
}


//! sends the GET command
function sendGETCommand(command)
{

	var arg1 = document.getElementById('_boolArgValueOnlySM').value;
	if ("off".localeCompare(arg1)==0)
	{
	   // call the send without an alert string
      sendGetCommand_thenAlert(command,"", false);
	}

	//! grab the boolean switch..
	var arg = document.getElementById('_boolArgValueRepeatSM').value;
	if ("on".localeCompare(arg)==0 || "on".localeCompare(arg1)==0)
	{
	   // just send SemanticMarker 
	   sendSemanticMarkerCommand(command);
	}
}

//! invokes a web site specified, bringing up a web window
function invokeWebSite(idWebAddress)
{
   var webAddress = document.getElementById(idWebAddress).value;

   //! display in new window
	//window.open(webAddress,"WEB");
	window.open(webAddress);
}

//! { elementId, initialString }
var _registeredDeviceChanges = [];

//! add the objects to change when the device name changes..
//! { elementId, initialString }
function registerDeviceChange(elementId, initialString)
{
    var object = {'elementId':elementId, 'initialString':initialString};
	 _registeredDeviceChanges.push(object);

}

//! change devices big button
function devicesChanged(idDevices)
{
   var deviceName = document.getElementById(idDevices).value;

   //9.5.23 change the color if special ones..
   if (deviceName.startsWith("M5"))
      document.getElementById(idDevices).className= "M5button";
   else if (deviceName.includes("GEN3"))
      document.getElementById(idDevices).className= "H2orange";
   else
      document.getElementById(idDevices).className= "btnB";

   for (var i =0; i< _registeredDeviceChanges.length; i++)
	{
	   var elementId = _registeredDeviceChanges[i].elementId;
	   var initialString = _registeredDeviceChanges[i].initialString;

	   var label = initialString + ": " + deviceName;
      document.getElementById(elementId).innerHTML = label;

	}
}

//!init registered devices
function initRegisteredDevices()
{
   registerDeviceChange('_manageActualDevice',"Manage Actual Device"); 
   registerDeviceChange('_M5SpecificCommands',"M5 Specific Commands");
   registerDeviceChange("_TimerCommands","Timer Commands to your device");
   registerDeviceChange("_CommandsToYourDevice", "Commands to your Device");
   registerDeviceChange("_DeviceNamesManagedByBot", "Device Names managed by your Agent (bot)");

   registerDeviceChange("_DOCFOLLOWMessages", "DOCFOLLOW SemanticMarker&#x2122; Example Messages");
   registerDeviceChange("_RevertToMainOTA", "Revert to MAIN OTA");
   registerDeviceChange("_QAOTA", "QA OTA Test Updates");
   registerDeviceChange("_DevOTA", "DEV OTA Test Updates");
   registerDeviceChange("_SMRecordDevice", "Device");


   registerDeviceChange("_GroupCommandsTab", "GROUP Messaging");
}


//! just web invokes the SemanticMarker
function invokeSemanticMarker(smId)
{
	var webAddress = document.getElementById(smId).value;

	if (window.confirm("Invoke: " + webAddress + "?"))
	{
	   // invoke this manually..
      window.open(webAddress, 'SemanticMarkerWindow');
	}
}

//!invokes flow using info..
function invokeSavedFlow(recordedMessagesId, uuidStringTextId, flowNumberTextId, privateTextId)
{
   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}
   // This has to sent this message backend..
	//  eg.  runFlow
   var flowNum = document.getElementById(flowNumberTextId).value;
   var uuid = document.getElementById(uuidStringTextId).value;
	//! format != json .. so this is a web call (to the semanticMarkerInstance.html)
	var webAddress = _semanticMarkerFlowURL + "smart?uuid=" + uuid + "&flow=" + flowNum;
	console.log("web = " + webAddress);

	// invoke this manually..
   window.open(webAddress, 'SemanticMarkerWindow');
}

//! calls the node-red process engine to create a smart deck .. then refreshes the decks
//!-- calls: /adddeckuuid/:NAME/:PASSWORD/:DECKNAME/:DECKPASSWORD/:DECKCAT -->
function createSmartDeck(smartDeckCategoryId,smartDeckNameId,smartDeckPasswordId)
{
   var deckcat = document.getElementById(smartDeckCategoryId).value;
   deckcat = createValidDeviceName(deckcat)

   var deckname = document.getElementById(smartDeckNameId).value;
   deckname = createValidDeviceName(deckname)

   var deckpass = document.getElementById(smartDeckPasswordId).value;
   deckpass = createValidDeviceName(deckpass)

	if (deckcat.length == 0 || deckpass.length == 0 || deckpass == 0)
	{
      alert("Values must be not be empty (and spaces are removed)");
		return;
	}

	var msg = "Create SMART Deck? \n" + "Name: " + deckname + "\nCat: " + deckcat + "\nPass: " + deckpass;
	if (window.confirm(msg))
	{
       var webAddress;
if (_useOldSMARTDeck)
{
       //! send this as a GET command to the bot backend (nodered)
       webAddress = _semanticMarkerFlowURL + "adddeckuuid/" + _username + "/" + _password  
		   + "/" + deckname + "/" + deckpass + "/" + deckcat;
}
else
{
       //! send this as a GET command to the bot backend (nodered)
       webAddress = _semanticMarkerFlowURL + "adddeckuuidNEW/" + _username + "/" + _password  
		   + "/" + deckname + "/" + deckpass + "/" + deckcat;
}
   
       console.log("web = " + webAddress);
		 alert(webAddress);
   
   	 // send this to node-red  "smflow/saveflow"
       justSendGETCommand(webAddress);

		 //TODO: needs a refresh
		 //NOTE: this doesn't return the UUID created ..  needs to update the SMUsersDB
		 // {username, password smartDecks:[] << place here

       //getSMUserUUID(uuidStringTextId)

	}
	else
	{

      alert("Cancelled creating a SMART Deck");
	}
}



//!sends flow using info..
/* 
  This will grab all the commands from the text recorded messages and base64 them .. and send as 1 message 
   https://SemanticMarker.org/bot/sm/saveflow/FLOW64?uuid=UUID&flow=10    where flow == flow number
	// Maybe put the parameters, flowname, flow# into another Base64 JSON..
	ADD: username,password somewhere (either &username=XXX&password=YY
	Then to run:
	https://SemanticMarker.org/bot/smart?uuid=UUID&flow=10
  "Save Semantic Marker&#x2122; Flow*"
*/
function sendSavedFlow(recordedMessagesId, uuidStringTextId,flowNumberTextId, flowNameTextId, flowCatTextId, privateId, flowsSelectId, isDataId, descTextId, dateTextId, QRAvatarURLTextId, parameterValuesSMId, nextFlowURLId, 
KSMatrixId, dataSMId, artifactsSMId, markupId, languagesSMId, videoSMId, isCircularAvatarId,
audioSMId, locationSMId, inheritedSMId, deckSMId, isMessagingId, isIndirectSMId, indirectSMId,
KSWaveId, bridgeSMId, futureId)
{

   // grab the text.. then wrap the entire things
	var isDataFlag = document.getElementById(isDataId).value;
	var privateflag = document.getElementById(privateId).value;
   var flowNum = document.getElementById(flowNumberTextId).value;
   var flowName = document.getElementById(flowNameTextId).value;
   var flowCat = document.getElementById(flowCatTextId).value;

	var nextFlowURL = document.getElementById(nextFlowURLId).value;

	// 3.22.23 added
	var KSMatrixText = document.getElementById(KSMatrixId).value;
	var dataSM = document.getElementById(dataSMId).value;
	var artifactsSM = document.getElementById(artifactsSMId).value;

	var KSWaveText = document.getElementById(KSWaveId).value;
	var bridgeSM = document.getElementById(bridgeSMId).value;
	var futureText = document.getElementById(futureId).value;
	var languagesSM = document.getElementById(languagesSMId).value;
	var videoSM = document.getElementById(videoSMId).value;
	var isCircularAvatar = document.getElementById(isCircularAvatarId).value;

	// grab the UUID
   var uuid = document.getElementById(uuidStringTextId).value;
	//require a uuid
	if (!uuid || uuid.length == 0)
	{
      alert("UUID required");
		return;
	} 
	else 
	{
		var validUUID = false;
	   for (let i =0; i< _UUIDNumbers.length; i++)
		{
		   if (_UUIDNumbers[i].localeCompare(uuid)==0)
			{
			   validUUID = true;
				break;
			}
		}
		if (!validUUID)
		{
         alert(uuid + ": Cannot save a different users SMART Deck." 
		   + " Please inherit and clone to"
		   + " run your own (which is recommended).");
		   return;
		}
	}

	// NOTE: multiple lines don't work .. 
   var markupText = document.getElementById(markupId).value;
	// Replace NEWLINE with \n\
   markupText = markupText.replaceAll('\\n','\\n\\');

	var audioSM = document.getElementById(audioSMId).value;
	var locationSM = document.getElementById(locationSMId).value;
	var inheritedSM = document.getElementById(inheritedSMId).value;
	//var isDeck = document.getElementById(isDeckId).value;
	var deckSM = document.getElementById(deckSMId).value;
	var isMessaging = document.getElementById(isMessagingId).value;
	var isIndirectSM = document.getElementById(isIndirectSMId).value;
	var indirectSM = document.getElementById(indirectSMId).value;
	//! end added

	//5.1.23 .. check the deckSM syntax UUID.flownum, UUUID.flownum
	if (deckSM && deckSM.length > 0)
	{
		deckSM = stripSpaces(deckSM);
		let validDeckSM = true;
	   let deckSMparts = deckSM.split(",");
		for (let p=0;p<deckSMparts.length;p++)
		{
		   let deckSMpart = deckSMparts[p];
			let SMparts = deckSMpart.split(".");
			if (SMparts.length != 2)
			{
			  validDeckSM = false;
			  break;
			}
		}
		if (!validDeckSM)
		{
			alert("Invalid syntax for deckSM: " + deckSM 
			  + "\nComma seperated UUID.flownum required."
			  + "\n(Note: not checking for valid UUID.flownum)");
         return;
		}

	}
	//! 5.5.23
	//!   Seems that when saved, the .../DEVICE_1/ ... isn't detected as a parameter to look for.
	//!  unless the parameterValuesSMId .. is set

	// select options 
	var flowParametersArray = ["USERNAME","PASSWORD"];
	var flowParameters = document.getElementById(parameterValuesSMId);
	 //! foreach arg.. replace the Parameter with the equilivent instance (eg. password -> _password)
	 for (var i=0; i< flowParameters.length; i++)
	 {
        var parameter = flowParameters[i].innerHTML;
		  flowParametersArray.push(parameter);
	 }
	 // now make them unique (new Set) and back to an array
	 var parameters  = Array.from(new Set(flowParametersArray));

	 //NOTE: 1.26.23   The parameters need to be examined below to see if they are still in the flow

	// NOTE: multiple lines don't work .. 
   var desc = document.getElementById(descTextId).value;
	// Replace NEWLINE with \n\
   desc = desc.replaceAll('\\n','\\n\\');

   var QRAvatarURL = document.getElementById(QRAvatarURLTextId).value;

	var currentDate = document.getElementById(dateTextId).value;


	//require a flowNum
	if (!flowNum || flowNum.length == 0)
	{
      alert("flowNumber required");
		return;
	} 

	//require a flowName
	if (!flowName || flowName.length == 0)
	{
      alert("flowName required");
		return;
	} 
	// strip spaces on flowName
   flowName = createValidFlowName(flowName);
   document.getElementById(flowNameTextId).value = flowName;

	//require a flowCat
	if (!flowCat || flowCat.length == 0)
	{
      alert("flow category required");
		return;
	} 
	// strip spaces on flowCat
   flowCat = createValidFlowName(flowCat);
   document.getElementById(flowCatTextId).value = flowCat;

	//encourage a QRAvatarURL
	if (!QRAvatarURL || QRAvatarURL.length == 0)
	{
		if (!window.confirm("The QRAvatarURL to an image is encouraged\nto improve visibility of your Semantic Marker\u00AE"))
		   return;
	} 

	//TODO: if a different flowNum .. then we are overriding .. so ask 

	// Check if this flow NUM is already defined .. and ask for confirmation to override..
	// Also check if the Name is used in the same Category.
	// SO Algorithm:  KEY = num (so cannot overlap without overwriting) 
	//    1. check if same num, set matchingNum=true
	//       so: will only overwrite if same cat and name,
	//       otherwise: overwrite not allowed
	//         1b. check if same cat, 
	//         1c. check if same name
	//       if all 3 -- then ask for Over Write 
	//         1d. if same CAT .. then RENAMING "name"
	//       -- otherwise cannot overwrite
	//    2. if no matching num 
	//     2.a  ensure flowName not in the same Category
	//  5.a - if same name and cat, but different flowNum .. then ask to change the flowNum
	//  6.a - if changing the category .. let them..
	//       
	if (_userFlowsJSON)
	{
	  // if override, then we are good.. otherwise
	  //  2.a ensure flowName not in same category
	  var override = false;
     for (var i =0; i< _userFlowsJSON.length; i++)
	  {
		  var flow = _userFlowsJSON[i];
		  if (flow.flowNum == flowNum)
		  {
		     //1.b. check same cat, 1.c same name
   		  if ((flow.name.localeCompare(flowName) == 0) && (flow.flowCat.localeCompare(flowCat) == 0))
			  {
			     if (window.confirm("** CAUTION **\nUpdating existing flow\nFlowName: " + flowName + "\nFlowCat: " + flow.flowCat + "\nFlowNum: " + flowNum))
			     {
		           console.log("**** Overriding a existing flow( " + flowNum + ") = " + flowName);

		           // if valid, then break the loop. There can be only 1 matching flowNum as it's our KEY
					  override = true;
				     break;
			     }
			     else
			     {
		           console.log("**** Canceled Overriding a existing flow: " + flowNum);
				     return;
			      }
				}
				// 1.d. Renaming name
   		   else if (flow.flowCat.localeCompare(flowCat) == 0)
				{
			     if (window.confirm("** CAUTION **\nRenaming flow\nOld   Name: " + flow.name 
				            + "\nNew Name: " + flowName + "\nFlowCat: " + flow.flowCat))
				  {
		           // if valid renaming, then break the loop. There can be only 1 matching flowNum as it's our KEY
					  override = true;
					  break;
				  }
				  else
				  {
				     alert("** Not Renaming **\nFlowNum (" + flowNum + ") already exists as\nFlowName: " + flow.name + "\nFlowCat: " + flow.flowCat);
					  return;
				  }

				}

				else
				{
				   alert("** Not Saving **\nFlowNum (" + flowNum + ") already exists as\nFlowName: " + flow.name + "\nFlowCat: " + flow.flowCat);
					return;
				}
		  } // if same num
	  }
	  
   // the node-red side checks for updating a flowNum, and if not there .. then adds. But
	// we are changing the number .. so there will be duplicates.
	//TODO:   delete in node-red first .. then add (but as that's an async web call tricky)
	// OR: the post message has a field "oldFlowNum" .. that is used.
/*
 //backend code:
 //!remove all flowNum == flowNum (vs replace)
   for (let [i, flow] of flows.entries()) {
      if (flow.flowNum === flowNum) {
         console.log("Remove: " + i);
         flows.splice(i, 1); // flowNum is now removed from "flows"
      }
   }
   //!add new flow
   msg.payload.flows.push(msg.flow);
*/
	  //! 5.3.23 .. check for changing a flow number
	  if (!override)
	  {
	  //bug..  not updating .. but creating another..
        for (var i =0; i< _userFlowsJSON.length; i++)
   	  {
   		  var flow = _userFlowsJSON[i];
		     //5.a if same name and cat but different flowNum .. then we are changing the flowNum
   		  if ((flow.name.localeCompare(flowName) == 0) && (flow.flowCat.localeCompare(flowCat) == 0))
			  {
			     if (!confirm("** CAUTION NOT SUPPORTED YET - use REMOVE FLOW**\nChanging flow number from:\n" + flow.flowNum + " -> to:\n" + flowNum ))
				  {
				     alert("** Not Saving **");
				     return;
				  }
				  else
				  {
				     alert("** Not Saving **");
					  return;
				     //override = true;
					  //break;
				  }
				}
   	  }
	  }

	  // if not override, then 2.a ensure flowName not in same category
	  if (!override)
	  {
        for (var i =0; i< _userFlowsJSON.length; i++)
   	  {
   		  var flow = _userFlowsJSON[i];
		     //2.a if same name and cat then not allowed..
   		  if ((flow.name.localeCompare(flowName) == 0) && (flow.flowCat.localeCompare(flowCat) == 0))
			  {
				  alert("Not Saving\nFlowNum (" + flowNum + ") already exists as\nFlowName: " + flow.name + "\nFlowCat: " + flow.flowCat);
				  return;
           }
   	  }
	  }
	} // _flow valid

	//! try to grab thew image..
	if (QRAvatarURL &&  QRAvatarURL.length > 0)
	{
		// start escaping some items..
		//NOTE: I cannot get this to work synchronously..
		try
		{
   	   getImage(QRAvatarURL).then
   		(
   		   function (successurl)
   			{
   			    console.log("Great, Valid Image URL\n\nFYI: Background checking found a VALID QRAvatarURL:\n" + QRAvatarURL + "\nYour Semantic Marker\u00AE works best with an embedded image.");
   			    //alert("Great, Valid Image URL\n\nFYI: Background checking found a VALID QRAvatarURL:\n" + QRAvatarURL + "\nYour Semantic Marker\u00AE works best with an embedded image.");
   			}).catch (function (errorurl)
   			{
   			    alert("Sorry, Invalid Image URL\n\nFYI: Background checking found an INVALID QRAvatarURL:\n" + QRAvatarURL + "\nYou can fix at your convience");
   				 return;
   			})
   	    }
	    catch (error)
	    {
		    alert("INVALID QRAvatarURL: " + QRAvatarURL  + "\nerror: " + error.message);
			 return;
	    }
	}

	alert("Saving Flow\nFlowName: " + flowName + "\nFlowCat: " + flowCat);

//alert("Testing valid write .. no operation taken..");
//return;

	//These are the commands themselves, like change page or feed -- not SemanticMarkers
   var allCommands = document.getElementById(recordedMessagesId).value;
   console.log("all= " + allCommands);

	//NOTE: I think the commands should be as in the end-domain (not SemanticMarkers)
   //allCommands = { "https://iDogWatch.com/bot/cmd/scott@konacurrents.com/p/feed", "https://iDogWatch.com/bot/cmd/scott@konacurrents.com/p/feed"};
   //allCommands = { "https://iDogWatch.com/bot/cmd/USERNAME/PASSWORD/feed", "https://iDogWatch.com/bot/cmd/USERNAME/PASSWORD/feed"};

	// so they have been replaces and encrypted..
	// eg  "https://SemanticMarker.org/bot/sm/saveflow/" + ENCRYPTED_COMMANDS + uuid..;

	//!NOTE: this isn't a message to users, but rather a message to the node-red SemanticMarker backend
	//   /sm/addflow/BASE64 ...
	var allCommandsJSON;

	//BUT the parameters should be  replaced (eg. myName -> USERNAME)
	for (var i=0; i< _SemanticMarkerValues.length; i++)
	{
	   allCommands = allCommands.replaceAll( _SemanticMarkerValues[i],_SemanticMarkerParameters[i]);
   }

	// tack onto these parameters with DEVICE_1, ... DEVICE_n
	// If re-saving, the the flowParameters are valid..
	//var parameters = ["USERNAME","PASSWORD"];
	//var parameters = flowParametersArray;


	//### NOTE: when looking at a flow that was already made generic, the values have already been updated
	//! eg.   scott -> USERNAME,  and others like M5Rainier -> M5_DEVICE_1, ScoobyDoo -> DEVICE_5, DEVICE_3_GEN3
	//! SO .. these should be used in the loop below.. otherwise the parameters are removed..
	//! OR: make parameters the parameters..

	//NOTE: after saving the first time, we don't know the local device (it's already DEVICE_1 for example).
	//Also, before adding say a DEVICE_1, check to see if it already exists, if so .. then DEVICE_2 .. etc

	//! NOW go through the commands looking for the 'devices' anywhere.. if _ALL_ leave it.. but if a parameter name
	//!  THEN: foreach .. replace with DEVICE_1 DEVICE_2  DEVICE_1 (again) .. 
	var deviceCount = 0;
	for (var i=0; i< _devicesJSON.length; i++)
	{
       let deviceName = _devicesJSON[i].deviceName;
		 // first see if that name is in our allCommands
	    // JSON == var _devicesJSON =  [{"deviceName":"_GENERIC_"},{"deviceName":"ScoobyDoo"},{"deviceName":"PumpkinUno"} ...
		 // That device name (like scooby) is in our list .. so add. But check for the a unique Device name
		 if (allCommands.indexOf(deviceName) >= 0)
		 {
			 var deviceParamName; // result name, like DEVICE_n where n isn't used yet. (even if M5_DEVICE_1 vs DEVICE_1)
			 var duplicateName = true;
          //! returns a unique deviceCount 
          //! by checking the DEVICE_ + count .. if exists, then return the next number..
			 while (duplicateName)
			 {
				 duplicateName = false;
			    deviceCount++;
			    deviceParamName = "DEVICE_" + deviceCount;
				 for (var i=0; i< parameters.length; i++)
				 {
					 // if name exists, continue..
				    if (parameters[i].indexOf(deviceParamName) >= 0)
					 {
                    duplicateName = true;
					 }
				 }
			 }
			 //! see if M5
			 if (deviceName.indexOf("M5") >= 0)
			    deviceParamName = "M5_" + deviceParamName;
			 else if (deviceName.indexOf("GEN3") >= 0)
			    deviceParamName = deviceParamName + "_GEN3";
				 //added 3.24.23
			 else if (deviceName.indexOf("NO_ONE") >= 0)
			    deviceParamName = "NO_ONE_" + deviceParamName;

			 // add name to the parameters array..
			 parameters.push(deviceParamName);
          console.log(" ** Found in allCommands: " + deviceName + " call it: " + deviceParamName);

			 // replace that string everwhere..
	       allCommands = allCommands.replaceAll( deviceName, deviceParamName);

		 }
	}

	//! 7.25.23 group..
	//! NOW go through the commands looking for the 'groups' anywhere.. if _ALL_ leave it.. but if a parameter name
	//!  THEN: foreach .. replace with GORUP_1 GROUP_2  (again) .. 
	var groupCount = 0;
  var groupsArray = _groupsJSON;

  // go through list, but dont include GENERIC and DEFAULT
  for (var i =0; i< groupsArray.length; i++)
  {
		  // key = group name

			  var groupJSON = groupsArray[i];
		     var groupName = groupJSON.group;

		 // first see if that name is in our allCommands
	    // JSON == var _devicesJSON =  [{"deviceName":"_GENERIC_"},{"deviceName":"ScoobyDoo"},{"deviceName":"PumpkinUno"} ...
		 // That device name (like scooby) is in our list .. so add. But check for the a unique Device name
		 if (allCommands.indexOf(groupName) >= 0)
		 {
			 var groupParamName; // result name, like DEVICE_n where n isn't used yet. (even if M5_DEVICE_1 vs DEVICE_1)
			 var duplicateName = true;
          //! returns a unique deviceCount 
          //! by checking the DEVICE_ + count .. if exists, then return the next number..
			 while (duplicateName)
			 {
				 duplicateName = false;
			    groupCount++;
			    groupParamName = "GROUP_" + groupCount;
				 for (var i=0; i< parameters.length; i++)
				 {
					 // if name exists, continue..
				    if (parameters[i].indexOf(groupParamName) >= 0)
					 {
                    duplicateName = true;
					 }
				 }
			 }

			 // add name to the parameters array..
			 parameters.push(groupParamName);
          console.log(" ** Found in allCommands: " + groupName + " call it: " + groupParamName);

			 // replace that string everwhere..
	       allCommands = allCommands.replaceAll( groupName, groupParamName);

		 }

	}

	//! 7.25.23  FLAW: 
	// if the parameter is at the end of the command (eg. feed/GROUP1, vs bot/GROUP/feed the /GROUP_1/ 
	// won't work.. So for GROUP_! .. don't check??

	//NOW: for all parameters, look to see if they are in the flow, if not then they were removed..
	//! Go in reverse so can remove elements in the loop..
	//! https://stackoverflow.com/questions/5767325/how-can-i-remove-a-specific-item-from-an-array
	//!NOTE: here the parameter needs to be enclosed in "/" which assumes not at the end of a command  *** LIMITATION
	for (var i= parameters.length-1; i >= 0; i--)
	{
      // search allCommands (a long string) to see if parameter is still there .. otherwise, remove from array
		var parameter = parameters[i];
		if (parameter.indexOf("GROUP_") >= 0)
		   continue;

		parameter = "/" + parameter + "/";
		// not found == -1
		if (allCommands.indexOf(parameter) < 0)
		{
         console.log("Removing parameter: " + parameter);
			parameters.splice(i, 1);
		}
	}


	//!NOTE: flaw, when a DEVICE_1 and DEVICE_1_GEN3 .. the replace will be 
	//! for all DEVICE_1 with your value .. which will change DEVICE_1_GEN3 to .. name_GEN3
	//!  SO A solution: the parameters are sorted by longest to shortest when being replaced by the next step..


   console.log("parameters = " + parameters);
   console.log("allCommands = " + allCommands);

   // create an array of commands.. in JSON, which will be flow:<allCommandsJSON array>
	var commandsArray = allCommands.split("\n");
	allCommandsJSON = JSON.parse(JSON.stringify(commandsArray));

	var dateString = new Date().toLocaleString();
    // "Friday, Jul 2, 2021"

   document.getElementById(dateTextId).value = dateString;

	//TODO: add the avatar type.. circle/square, but the nodered has to be updated too..

	 // create the parameter and other info..
	 // Currently the parameters are known to this code .. as below
	 var flowMetaJSON = { 
                         "username":_username,
								 "password":_password,
	                      "name" : flowName,
								 "uuid" : uuid,
								 "isdata": isDataFlag,
								 "private": privateflag, 
	                      "flowNum"  : flowNum,
								 "flowCat"  : flowCat,
								 "date" : dateString,
								 "parameters" : parameters,
								 "desc": desc,
								 "QRAvatarURL":QRAvatarURL,
								 "nextFlowURL":nextFlowURL,
								 "flow" : allCommandsJSON,

								 "dataSM" : dataSM,
								 "KSMatrix" : KSMatrixText,
								 "artifactsSM" : artifactsSM,
								 "markup" : markupText,
								 "languagesSM": languagesSM,
								 "videoSM": videoSM,
								 "isCircularAvatar": isCircularAvatar,

								 "KSWave" : KSWaveText,
								 "bridgeSM" : bridgeSM,
								 "future" : futureText,

								 "audioSM" : audioSM,
								 "locationSM" : locationSM,
								 "inheritedSM" : inheritedSM,
								 "deckSM" : deckSM,
								 "isMessaging" : isMessaging,
								 "isIndirectSM" : isIndirectSM,
								 "indirectSM" : indirectSM
							  };

//	 console.log("flowMetaJSON = " + flowMetaJSON);

//	 alert(JSON.stringify(flowMetaJSON));


   if (true)
   {
     // sends this JSON as a POST (not a GET). 
	  // When done.. it calls getSMFlows(uuidStringTextId, flowsSelectId);
     sendJSONAsPOST(flowMetaJSON, uuidStringTextId, flowsSelectId, false);

	  // This is needed to let the POST finish.. otherwise the update 
	  // doesn't get results (as the getSMFlows is a call to the same nodered)
     //alert("Finshed update. WIll refresh flows");
   
     //update the flows. Again, a race condition..
     ////getSMFlows(uuidStringTextId, flowsSelectId);
   
     return;
   }
   else
   {
   
   	 // stringify then base64 encode it
   	 flowMetaJSON = JSON.stringify(flowMetaJSON);
   
   	 // convert to BASE64 encoding
       var commandsEncoded = btoa(flowMetaJSON);
   
   
   //TODO .. this needs to be a POST command.. sending the JSON
   
   
       //! send this as a GET command to the bot backend (nodered)
       var webAddress = _semanticMarkerFlowURL + "smflow/saveflow/" + commandsEncoded 
   	    + "?uuid=" + uuid + "&flow=" + flowNum + "&username=" + _username + "&password=" + _password;
   
       console.log("web = " + webAddress);
   
   	 // send this to node-red  "smflow/saveflow"
       justSendGETCommand(webAddress);
   
       //grab the flows
       getSMFlows(uuidStringTextId, flowsSelectId);
   
   }

}

//!Remove Flow using info..
function sendRemoveFlow(recordedMessagesId, uuidStringTextId,flowNumberTextId, flowNameTextId, flowCatTextId, privateId, flowsSelectId, isDataId, descTextId, dateTextId, QRAvatarURLTextId, parameterValuesSMId, nextFlowURLId, 
KSMatrixId, dataSMId, artifactsSMId, markupId, languagesSMId, videoSMId, isCircularAvatarId,
audioSMId, locationSMId, inheritedSMId, deckSMId, isMessagingId, isIndirectSMId, indirectSMId,
KSWaveId, bridgeSMId, futureId)
{

   // grab the text.. then wrap the entire things
	var isDataFlag = document.getElementById(isDataId).value;
	var privateflag = document.getElementById(privateId).value;
   var flowNum = document.getElementById(flowNumberTextId).value;
   var flowName = document.getElementById(flowNameTextId).value;
   var flowCat = document.getElementById(flowCatTextId).value;

	var nextFlowURL = document.getElementById(nextFlowURLId).value;

	// 3.22.23 added
	var KSMatrixText = document.getElementById(KSMatrixId).value;
	var dataSM = document.getElementById(dataSMId).value;
	var artifactsSM = document.getElementById(artifactsSMId).value;

	var KSWaveText = document.getElementById(KSWaveId).value;
	var bridgeSM = document.getElementById(bridgeSMId).value;
	var futureText = document.getElementById(futureId).value;
	var languagesSM = document.getElementById(languagesSMId).value;
	var videoSM = document.getElementById(videoSMId).value;
	var isCircularAvatar = document.getElementById(isCircularAvatarId).value;


	// NOTE: multiple lines don't work .. 
   var markupText = document.getElementById(markupId).value;
	// Replace NEWLINE with \n\
   markupText = markupText.replaceAll('\\n','\\n\\');

	var audioSM = document.getElementById(audioSMId).value;
	var locationSM = document.getElementById(locationSMId).value;
	var inheritedSM = document.getElementById(inheritedSMId).value;
	//var isDeck = document.getElementById(isDeckId).value;
	var deckSM = document.getElementById(deckSMId).value;
	var isMessaging = document.getElementById(isMessagingId).value;
	var isIndirectSM = document.getElementById(isIndirectSMId).value;
	var indirectSM = document.getElementById(indirectSMId).value;
	//! end added

	// grab the UUID
   var uuid = document.getElementById(uuidStringTextId).value;
	//require a uuid
	if (!uuid || uuid.length == 0)
	{
      alert("UUID required");
		return;
	} 
	else 
	{
		// check if we own this UUID (if not, then we traversed to it..)
		var validUUID = false;
	   for (let i =0; i< _UUIDNumbers.length; i++)
		{
		   if (_UUIDNumbers[i].localeCompare(uuid)==0)
			{
			   validUUID = true;
				break;
			}
		}
		if (!validUUID)
		{
         alert(uuid + ": Cannot remove a different users SMART Deck." 
		   + " Please inherit and clone to"
		   + " run your own (which is recommended).");
		   return;
		}
	}

	//require a flowNum
	if (!flowNum || flowNum.length == 0)
	{
      alert("flowNumber required");
		return;
	} 

	//require a flowName
	if (!flowName || flowName.length == 0)
	{
      alert("flowName required");
		return;
	} 
	// strip spaces on flowName
   flowName = createValidFlowName(flowName);
   document.getElementById(flowNameTextId).value = flowName;

	//require a flowCat
	if (!flowCat || flowCat.length == 0)
	{
      alert("flow category required");
		return;
	} 
	// strip spaces on flowCat
   flowCat = createValidFlowName(flowCat);
   document.getElementById(flowCatTextId).value = flowCat;


	 // create the parameter and other info..
	 // Currently the parameters are known to this code .. as below
	 var flowMetaJSON = { 
                         "username":_username,
								 "password":_password,
	                      "name" : flowName,
								 "uuid" : uuid,
	                      "flowNum"  : flowNum,
								 "flowCat"  : flowCat
							  };

//	 console.log("flowMetaJSON = " + flowMetaJSON);

	var removeIt = false;
	if (confirm("*** CAUTION *** Removing\nflowName: " + flowName + "\nflowNum: " + flowNum))
	{
	    alert("Removing: " + flowName);
		 removeIt = true;
	}
	else
	{
	    alert("NOT Removing: " + flowName);
	}


   if (removeIt)
   {
     // sends this JSON as a POST (not a GET). 
	  // When done.. it calls getSMFlows(uuidStringTextId, flowsSelectId);
     sendJSONAsPOST(flowMetaJSON, uuidStringTextId, flowsSelectId, true);

	  // This is needed to let the POST finish.. otherwise the update 
	  // doesn't get results (as the getSMFlows is a call to the same nodered)
     //alert("Finshed update. WIll refresh flows");
   
     //update the flows. Again, a race condition..
     ////getSMFlows(uuidStringTextId, flowsSelectId);
   
     return;
   }

} // remove

//!setup a flow recording session
function setupFlowCapture(recordedMessagesId,uuidStringTextId,flowNumberTextId, repeatId, sendOnlyId, flowsSelectId)
{
  // set the modes..
  document.getElementById(recordedMessagesId).innerHTML = "";
  document.getElementById(repeatId).value = "off";
  document.getElementById(sendOnlyId).value = "off";
  _useSemanticMarkerParameters = false;

  //grab the flows
  getSMFlows(uuidStringTextId, flowsSelectId);
}

//! sends FLOW as a Semantic Marker..   BUT this is just the flowMeta info (not the flow)
function sendFlowSM(uuidStringTextId, flowNumberTextId, flowNameTextId, flowCatTextFieldId)
{
   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}
   var flowName = document.getElementById(flowNameTextId).value;
   var flowNum = document.getElementById(flowNumberTextId).value;
   var flowCat = document.getElementById(flowCatTextFieldId).value;

   var uuid = document.getElementById(uuidStringTextId).value;
   var webAddress = _semanticMarkerFlowURL + "smart"
	    + "?uuid=" + uuid + "&flow=" + flowNum +  "&flowname=" + flowName + "&flowcat=" + flowCat;

	// not a parameterized command.. this is straight SemanticMarker.org/bot
   _useSemanticMarkerParameters = false;

	// Now send this..
	// just send SemanticMarker 
	sendSemanticMarkerCommand(webAddress);

}

//! 7.1.23 Dad's 92nd Birthday
//! Sends the JSON of this SMARTButton to the devide specified..
function sendSMARTButtonJSON(uuidStringTextId, flowNumberTextId, flowNameTextId, flowCatTextFieldId)
{
   //format:  {dev:<device>, "SMARTButton": <entire json> }

   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}
   var flowName = document.getElementById(flowNameTextId).value;
   var flowNum = document.getElementById(flowNumberTextId).value;
   var flowCat = document.getElementById(flowCatTextFieldId).value;

   var uuid = document.getElementById(uuidStringTextId).value;

	// grab the flow .. JSON
   let flow = flowOfFlowNum(uuid, flowNum);

	if (!flow)
	{

      alert("Cannot find flow for " + uuid + "." + flowNum);
	   return;
	}

	//!setup the devices
   setupDevice('devices');

	//! check device name..
	if (_isSendToAll)
	{
      alert("Currently only supporting sending SMART Button to single user. Specify a device name");
		return;
	}


	let messageJSON = {"dev":_deviceName,"SMARTButton": flow};

	alert(JSON.stringify(messageJSON));
	
}

//! history of links..   (array of SM)
var _historyOfLinksSM = [];


// pop the stack
function showPreviousLink()
{
	// pop the stack..
   var previousLinkSM = _historyOfLinksSM.pop();

	if (previousLinkSM)
	{
      pushSMLink(previousLinkSM); 
	}
}


//! sets the index of this link..
//! updates the global: _selectedFlowIndex (a hidden value)
//! returns TRUE if valid, and false if can't find (but initiated a web call)
//! Requires that _userFlowsJSON be valid 
//!  if not. then the _cachedFlowsJSON ..
//@returns {boolean}
function setSelectedFlowIndex(thisDeckSM)
{
  let deckSMuuid = getUUIDFromSM(thisDeckSM);
  let deckSMflowNum = getFlowNumFromSM(thisDeckSM);

  let sameUUID = true;
  let validIndex = true;

  // find the flowsSM. Start with singleton _userFlowsJSON 
  for (let i=0; i<_userFlowsJSON.length; i++)
  {
       // find the matching flow..
		 let thisUUID = _userFlowsJSON[i].uuid;
		 if (thisUUID != deckSMuuid)
		 {
		    sameUUID = false;
			 break;
		 }

		 //below is same for this UUID 
		 let thisFlowNum = _userFlowsJSON[i].flowNum;
		 let thisSM = createSM(thisUUID, thisFlowNum);
		 if (thisSM.localeCompare(thisDeckSM)==0)
		 {
           document.getElementById('_selectedFlowIndex').value = i;
			  return true;
	    }
   }
	// didn't find the uuid in the _userFlowsJSON .. so look in cache
	if (!sameUUID)
	{
		// format:  {uuid:u, flows:flowsJSONArray}
      for (let i=0; i<_cachedFlowsJSON.length;i++)
		{
			 var uuid = _cachedFlowsJSON[i].uuid;
			 if (uuid == deckSMuuid)
			 {
		       // swap it out.., then recursively find it..
			    _userFlowsJSON = _cachedFlowsJSON[i].flows;
				 return setSelectedFlowIndex(thisDeckSM);
			 }
		}
	}

	// request a flowName .. which initiates a GET fetch
   flowNameOfSM(thisDeckSM);

	// let the caller know we don't have anything, but check back..
	return false;
}

// pushes the SMLink and calls showSMFlow
function pushSMLink(thisDeckSM)
{
   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}

  // sets the selected in the _userFlowsJSON so the showSMFlow works..
  if (!setSelectedFlowIndex(thisDeckSM))
  {
     alert("Still fetching SMART Button, try again shortly: " + thisDeckSM);
	  return;
  }

  //! 5.1.23 .. updating the global _uuidStringText to this new UUID
  var uuid = getUUIDFromSM(thisDeckSM);
  document.getElementById('_uuidStringText').value = uuid;


	 // 5.1.23 .. done above in the setSelectedFlowIndex
	 //TODO: change UUID..  which requires the flow to change
	 // currently only working with this UUID
	 //now invoke this one..  'flowsSM' is an index into the flows.., replace with our _selectedFlowIndex
showSMFlow('_selectedFlowIndex','parameterValuesSM','_flowValuesSM','_flowNumberText','flowNameText','flowCatText','boolArgValuePrivate','flowSMName','boolArgValueIsData','descriptionText','_recordedMessages','flowDateText','flowQRAvatarURLText','sm1','sm1Command','nextFlowURLText','KSMatrixText', 'dataSMText', 'artifactsSMText', 'markupText','languagesSMText','videoSMText', 'boolArgValueIsCircularAvatar', 'audioSMText', 'locationSMText', 'inheritedSMText',  'deckSMText', 'boolArgValueIsMessaging',  'boolArgValueIsIndirectSM','_indirectSMText', 'KSWaveText', 'bridgeSMText', '_futureText','_QRAvatarId2','otherSM');

}

//! get the SM of the currently shown based on the text values..
//! UUID.flownum
function currentlyShownSM()
{
  var uuid = document.getElementById('_uuidStringText').value;
  var flowNum = document.getElementById('_flowNumberText').value;
  var SM = createSM(uuid, flowNum);
  return SM;
}

//! retrieve based on a SM (so this tears it apart and retrieves it async..)
//! calls flowNameOfFlowNum
function avatarURLOfSM(SM)
{
  let uuid = getUUIDFromSM(SM);
  let flowNum = getFlowNumFromSM(SM);
  if (uuid)
  {
	 return avatarURLOfFlowNum(uuid, flowNum);
  }
  return null;
}

//! retrieve based on a SM (so this tears it apart and retrieves it async..)
//! calls flowNameOfFlowNum
function markupOfSM(SM)
{
  let uuid = getUUIDFromSM(SM);
  let flowNum = getFlowNumFromSM(SM);
  if (uuid)
  {
	 return markupOfFlowNum(uuid, flowNum);
  }
  return null;
}

//! see if this SM.uuid is our UUID, if so then return the flowName
function flowInheritedSMOfSM(SM)
{
   var uuid = getUUIDFromSM(SM);
   var flowNum = getFlowNumFromSM(SM);
   let flow = flowOfFlowNum(uuid, flowNum);
	if (flow)
	{
		console.log("Found cached flowName: " + flow.name);
	   return flow.inheritedSM;
	}
	return null;
}

//! retrieve based on a SM (so this tears it apart and retrieves it async..)
//! calls flowNameOfFlowNum
function flowNameOfSM(SM)
{
  let uuid = getUUIDFromSM(SM);
  let flowNum = getFlowNumFromSM(SM);
  if (uuid)
  {
	 return flowNameOfFlowNum(uuid, flowNum);
  }
  return null;
}

//! see if this SM.uuid is our UUID, if so then return the flowName
//! returns the flow 
function flowOfFlowNum(uuid, flowNum)
{
  // NOW only go through the _cachedFlows
  for (let i=0; i<_cachedFlowsJSON.length;i++)
  {
	  if (uuid == _cachedFlowsJSON[i].uuid)
	  {
		 var userFlows = _cachedFlowsJSON[i].flows;
	    // found match..
		 // look for the same flowNum
		 for (let n=0;n<userFlows.length;n++)
		 {
		   var userFlow = userFlows[n];
		   if (userFlow.flowNum == flowNum)
		   {
				// found and use thie flow name (.name)
		      var flowName = userFlow.name;
				console.log("Found cachedFlow: " + flowName);
		      return userFlow;
		   }
	    }
     }
  }
  // didn't find .. so make a request, but answer won't be back for awhile.

  document.getElementById('_hiddenUUID').value = uuid;
  document.getElementById('_hiddenFlowNum').value = flowNum;

	console.log("Requesting getSMFlows: " + uuid + "." + flowNum);

  //! this should be threadsafe as the calls are synchronous, and the getSMFlows grabs the value 
  //! before it's async call
  getSMFlows('_hiddenUUID', null);

  return null;

}


//! see if this SM.uuid is our UUID, if so then return the flowName
function flowNameOfFlowNum(uuid, flowNum)
{
   let flow = flowOfFlowNum(uuid, flowNum);
	if (flow)
	{
		console.log("Found cached flowName: " + flow.name);
	   return flow.name;
	}
	return null;
}

//! see if this SM.uuid is our UUID, if so then return the flowName
function avatarURLOfFlowNum(uuid, flowNum)
{
	let avatarURL = "https://SemanticMarker.org/images/SM-Circle-R.png";
   let flow = flowOfFlowNum(uuid, flowNum);
	if (flow)
	{
		console.log("Found cached flowName: " + flow.name);

		if (flow.QRAvatarURL && flow.QRAvatarURL.length > 0)
		   avatarURL = flow.QRAvatarURL;
	}
	return avatarURL;

}

//! see if this SM.uuid is our UUID, if so then return the flowName
function markupOfFlowNum(uuid, flowNum)
{
	let markup = "";
   let flow = flowOfFlowNum(uuid, flowNum);
	if (flow)
	{
		console.log("Found cached flowName: " + flow.name);

		if (flow.markup && flow.markup.length > 0)
		   markup = flow.markup;
	}
	return markup;

}

//! 4.30.23 show the SMART Deck, and grab the selected from '_SMARTDeckLinks'
//! Show SM Link
//! This version creates a
function showSMLink(SMARTDeckLinksId)
{
  // get the deckSM from the current links id 
  var thisDeckSM = document.getElementById(SMARTDeckLinksId).value;

  //! call showSMLinkSM
  showSMLinkSM(thisDeckSM);

}

//! 4.30.23 show the SMART Deck, and grab the selected from '_SMARTDeckLinks'
//! Show SM Link
//! This version creates a
function showSMLinkSM(SM)
{
  console.log("showSMLinkSM: " + SM);

  // push which also calls showSMFlow
  //! the currentlyShowSM() is a function that returns the flow shown
  //! It's not pushed on history until we leave it to deeper in the tree
  _historyOfLinksSM.push(currentlyShownSM());

  //now push the link
  pushSMLink(SM);
}

//!creates a SM from uid/flownum
function createSM(uuid, flowNum)
{
   return uuid + "." + flowNum;
}

// 4.30.23 show the deckSM links in a pulldown
// also init the stack
function showSMDeckLinks(SM, deckSMs)
{
  // the deckSM (if available) 
  // modifies _SMARTDeckLinks
  var htmlSelect = "";

  var validLinks = false;
  let deckSMLinks = []; // [{"SM":SM, "flowName":name, "avatarURL:"http link.."}]

		console.log("showSMDeckLinks = " + deckSMs);
		if (deckSMs && deckSMs.length>0)
		{
		  // now parse the deckSMs, comma seperated
		  deckSMs = stripSpaces(deckSMs);

		  //should be list of UUID.flownum, UUID.flownum
		  let deckSMAddresses = deckSMs.split(",");

		  if (deckSMAddresses && deckSMAddresses.length>0)
		  {
			  // the result if itself if no ','
		     for (let i=0; i< deckSMAddresses.length; i++)
			  {
				  validLinks = true;
				  let thisDeckSM = deckSMAddresses[i];

			     // get the single address, 
              let deckSMuuid = getUUIDFromSM(thisDeckSM);
              let deckSMflowNum = getFlowNumFromSM(thisDeckSM);

				  //Add the flowName if this is our UUID
				   var flowName = flowNameOfFlowNum(deckSMuuid, deckSMflowNum);

					// grab the avatar (which will return something..)
					let avatarURL = avatarURLOfFlowNum(deckSMuuid, deckSMflowNum);

					let object = {"SM":thisDeckSM, "flowName":flowName, "avatarURL":avatarURL};
					deckSMLinks.push(object);

					 //don't know the flowName yet ...
               htmlSelect += "<option value='" + thisDeckSM + "'>";
					if (flowName)
					   htmlSelect += flowName + " ";
					htmlSelect += "(" + thisDeckSM + ")</option>";
               htmlSelect += "\n";
				}
			}
		}

  document.getElementById('_SMARTDeckLinks').innerHTML = htmlSelect;

  // 5.2.23 Also update the Hidden aspects
  document.getElementById('_showLinkButton').hidden = !validLinks;;
  document.getElementById('_previousLinkButton').hidden = (_historyOfLinksSM.length == 0);

  //!now update the SMART Button Images
	/*
	 modify document.getElementById("_SMARTButtonsDeckImages").innerHTML
	      <table>
		     <tr>
	          <td><img width="100" src="https://SemanticMarker.org/images/M5/M5Menu.jpg">
	          <td><img width="100" src="https://user-images.githubusercontent.com/5956266/219514302-25c41a8a-f3fd-41de-88fe-be675cb7e5e1.jpeg">
	          <td><img width="100" src="https://user-images.githubusercontent.com/5956266/221418254-a93d02bf-31b4-46fa-b740-bfde510c43aa.jpeg">
	          <td><img width="100" src="https://SemanticMarker.org/users/QHmwUurxC3/LauraSki.jpg">
				</tr>
			</table>
		*/
	let htmlTable = "<table cellspacing='0' cellpadding='4'>\n<tr>";
	// if a previous.. show it
	if (_historyOfLinksSM.length > 0)
	{
		// at(-1) see: https://stackoverflow.com/questions/42501871/peek-operation-in-stack-using-javascript
      let previousSM =  _historyOfLinksSM.at(-1);
      let avatarURL = avatarURLOfSM(previousSM);
      let flowName = flowNameOfSM(previousSM);
		//! https://jkorpela.fi/html/cellborder.html
	   htmlTable += "<td><table border='2' cellpadding='4' ><tr><td bgcolor='lightgrey'>Previous:: " + flowName 
		   + "<br><img width='100' src='" + avatarURL + "' onClick='showPreviousLink()'></td></tr></table></td>\n";
	}
	// use the deckSMLinks array created above .. where the avatarURL is set
	for (let i=0; i< deckSMLinks.length; i++)
	{
	   let object = deckSMLinks[i];
		let thisSM = object.SM;
		let flowName = object.flowName;
		let avatarURL = object.avatarURL;
	   htmlTable += "<td>" + flowName + "<br><img width='100' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + thisSM + "\")'></td>\n";
	}

	// 5.6.23 if the inherited .. tack the button at the end
   let inheritedSM = flowInheritedSMOfSM(SM);
	if (inheritedSM && inheritedSM.length > 0)
	{
	  // tack on inherited at the end..
	  let flowName = flowNameOfSM(inheritedSM);
	  let avatarURL = avatarURLOfSM(inheritedSM);
	   htmlTable += "<td><table border='2' cellpadding='4' ><tr><td bgcolor='grey'>1.Inherited:: " + flowName 
		   + "<br><img width='100' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + inheritedSM + "\")'></td>\n";
	}


	htmlTable += "</tr>\n</table>\n";
	document.getElementById("_SMARTButtonsDeckImages").innerHTML = htmlTable;

	console.log(htmlTable);

} // showSMDeckLinks(SM, deckSMs)

// 5.10.23, (4.30.23 show the deckSM links in a pulldown)
// return an array of the deckSM  links
// [{"SM":SM, "flowName":name, "avatarURL:"http link.."}]
//function getSMDeckLinksArray(SM, deckSMs)
function getSMDeckLinksArray(deckSMs)
{
  // the deckSM (if available) 
  var htmlSelect = "";

  var validLinks = false;
  let deckSMLinks = []; // [{"SM":SM, "flowName":name, "avatarURL:"http link.."}]

		if (deckSMs && deckSMs.length>0)
		{
		  // now parse the deckSMs, comma seperated
		  deckSMs = stripSpaces(deckSMs);

		  //should be list of UUID.flownum, UUID.flownum
		  let deckSMAddresses = deckSMs.split(",");

		  if (deckSMAddresses && deckSMAddresses.length>0)
		  {
			  // the result if itself if no ','
		     for (let i=0; i< deckSMAddresses.length; i++)
			  {
				  validLinks = true;
				  let thisDeckSM = deckSMAddresses[i];

			     // get the single address, 
              let deckSMuuid = getUUIDFromSM(thisDeckSM);
              let deckSMflowNum = getFlowNumFromSM(thisDeckSM);

				  //Add the flowName if this is our UUID
				   var flowName = flowNameOfFlowNum(deckSMuuid, deckSMflowNum);

					// grab the avatar (which will return something..)
					let avatarURL = avatarURLOfFlowNum(deckSMuuid, deckSMflowNum);

					let object = {"SM":thisDeckSM, "flowName":flowName, "avatarURL":avatarURL};
					deckSMLinks.push(object);

				}
			}
		}

   return deckSMLinks;

} // getSMDeckLinks(SM, deckSMs)

//!copy of the user flow
var _userFlowsJSON = null;

/**
* Show SM Flow (using _userFlowsJSON global)
* @param {flowsSelectId} id of flowsSelect
* @param {flowsParameterId} id of parameterSelect
* @param {flowsFlowId} id of flowsSelect
* @param {flowNumId} id of flowNum
* @param {flowNameId} id of flowName
* @param {flowCatId} id of flow Category
* @param {flowPrivateId} id of flowIsPrivate
* @param {flowSMNameId} id of flowSMName the Semantic Marker address
* @param {flowIsDataId} id of flowIsData
* @param {descTextId} id of description
* @param {recordedTextId} id of recordedText area. If non null, then decode the flow into HTTP calls in this area
* @param {dateTextId} id of date field
* @param {QRAvatarURLTextId} id of QRAvatarURLTextId field
* @param {sm} id of where the SM will go field  (if NULL then don't create SM)
* @param {smCommand} id of where the SM command will go field. These will be escaped..
* @param {nextFlowURLId} id of next FLOW URL (a string, maybe multiple later..) 1.29.23
*/
function showSMFlow(flowsSelectId, flowsParameterId, flowsFlowId, flowNumId, flowNameId, flowCatId, flowPrivateId, flowSMNameId, flowIsDataId, descTextId, recordedTextId, dateTextId, QRAvatarURLTextId, sm, smCommand, nextFlowURLId, KSMatrixId, dataSMId, artifactsSMId, markupId, languagesSMId, videoSMId, isCircularAvatarId,
audioSMId, locationSMId, inheritedSMId,  deckSMId, isMessagingId, isIndirectSMId, indirectSMId,
KSWaveId, bridgeSMId, futureId, QRAvatarId, otherSMId)
{
//TODO:: Figure out the flowsSelectedId  .. I think it's somewhere already..
  // use global id:  
  var selectedFlowIndex = document.getElementById(flowsSelectId).value;
  var flow = _userFlowsJSON[selectedFlowIndex];
  var flowName = flow.name;
  var private = flow.private;
  var isdata = flow.isdata;
  var uuid = flow.uuid;
  var flowNum = flow.flowNum;
  var flowCat = flow.flowCat;
  var desc = flow.desc;
  var date = flow.date;
  var QRAvatarURL = flow.QRAvatarURL;
  var nextFlowURL = flow.nextFlowURL;

  var n1 = document.getElementById(flowNameId);
  var n2 = document.getElementById(flowCatId);
  var n3 = document.getElementById(dateTextId);

  document.getElementById(flowCatId).value = flowCat;
  document.getElementById(flowNumId).value = flowNum;
  document.getElementById(flowNameId).value = flowName;
  document.getElementById(flowPrivateId).value = private;
  document.getElementById(flowIsDataId).value = isdata;
  document.getElementById(descTextId).value = desc;
  document.getElementById(dateTextId).value = date;
  document.getElementById(QRAvatarURLTextId).value = QRAvatarURL;
  document.getElementById(nextFlowURLId).value = nextFlowURL;

	// 3.22.23 added
	var KSWaveText = flow.KSWave?flow.KSWave:"";
	var bridgeSM = flow.bridgeSM?flow.bridgeSM:"";
	// it's flow.future (not futureText)
	var futureText = flow.future?flow.future:"";
	var languagesSM = flow.languagesSM?flow.languagesSM:"";
	var videoSM = flow.videoSM?flow.videoSM:"";
	var isCircularAvatar = flow.isCircularAvatar?flow.isCircularAvatar:"false";

	var dataSM = flow.dataSM?flow.dataSM:"";
	var artifactsSM = flow.artifactsSM?flow.artifactsSM:"";
	var KSMatrix = flow.KSMatrix?flow.KSMatrix:"";
	var markup = flow.markup?flow.markup:"";

	var audioSM = flow.audioSM?flow.audioSM:"";
	var locationSM = flow.locationSM?flow.locationSM:"";
	var inheritedSM = flow.inheritedSM?flow.inheritedSM:"";
	//var isDeck = flow.isDeck?flow.isDeck:"false";
	var deckSM = flow.deckSM?flow.deckSM:"";
	var isMessaging = flow.isMessage?flow.isMessaging:"false";
	var isIndirectSM = flow.isIndirectSM?flow.isIndirectSM:"false";
	var indirectSM = flow.indirectSM?flow.indirectSM:"";

	// 3.22.23 added
	 //3.24.23
	 document.getElementById(KSWaveId).value = KSWaveText;
	 document.getElementById(bridgeSMId).value = bridgeSM;
	 document.getElementById(futureId).value = futureText;
	 document.getElementById(languagesSMId).value = languagesSM;
	 document.getElementById(videoSMId).value = videoSM;
	 document.getElementById(isCircularAvatarId).value = isCircularAvatar;

	 document.getElementById(KSMatrixId).value = KSMatrix;
	 document.getElementById(dataSMId).value = dataSM;
	 document.getElementById(artifactsSMId).value = artifactsSM;
	 document.getElementById(markupId).value = markup;

	 document.getElementById(audioSMId).value = audioSM;
	 document.getElementById(locationSMId).value = locationSM;
	 document.getElementById(inheritedSMId).value = inheritedSM;
	 //document.getElementById(isDeckId).value = isDeck;
	 document.getElementById(deckSMId).value = deckSM;
	 document.getElementById(isMessagingId).value = isMessaging;
	 document.getElementById(isIndirectSMId).value = isIndirectSM;
	 document.getElementById(indirectSMId).value = indirectSM;

	 //! 5.7.23 (year since Amber grad L&C
	 let o = document.getElementById('_SMARTMarkup');
	 //! look for @(UUID.flow), @(audio), @(video), @(SMARTDeck) and convert..  @(playlist), @(QRAvatar), @(SM) ..etc
    markup = replaceSMLinks(markup, flow, true);
	 o.innerHTML = markup;

	 // 4.30.23 show the deckSM links in a pulldown
	 // let it know what the parent starting this..
    showSMDeckLinks( createSM(uuid, flowNum), deckSM);


  // set semantic marker
  var webAddress = _semanticMarkerFlowURL + "smart"
	    + "?uuid=" + uuid + "&flow=" + flowNum + "&flowname=" + flowName + "&flowcat=" + flowCat;
  document.getElementById(flowSMNameId).value = webAddress;

  var parametersArray = flow.parameters;
  var flowArray = flow.flow;


  //! 5.8.23 add this (without passing a parameter)
  //! update _mySMLink
  var mySM = createSM(uuid, flowNum);
  document.getElementById('_mySMLink').value = mySM;

  //TODO: SORT..

  //then set the parameter 
		var flowsHTML = "";
      for (var i =0; i< parametersArray.length; i++)
		{
			var element = parametersArray[i];

			// onselect call showSMFlow() but then it checks value .. (can be same value)
			flowsHTML += "<option value='" + i + "'>" + element + "</option>\n";

			//Also tack on to the web address
			webAddress += "&" + element + "=";
		}

		//test.. works.. the 
		if (false)
		{
			 //escape the element
			 // SEE: https://stackoverflow.com/questions/332872/encode-url-in-javascript
		    var elementValue = "This is a long string";
			 elementValue = encodeURIComponent(elementValue);

			 var element = "LONG_NAME";

			 //Also tack on to the web address
			 webAddress += "&" + element + "=" + elementValue;

//TODO:  OR THESE ARE added in the flow description which is grabbed by the Custom Flow page..
// 1.19.23
      }


		if (flowsHTML.length > 0)
         document.getElementById(flowsParameterId).innerHTML = flowsHTML;

  //then set the and flowsID
		flowsHTML = "";
      for (var i =0; i< flowArray.length; i++)
		{
			var element = flowArray[i];
			flowsHTML += "<option value='" + i + "'>" + element + "</option>\n";
		}

		if (flowsHTML.length > 0)
         document.getElementById(flowsFlowId).innerHTML = flowsHTML;

		//! now draw the semantic marker (sm1command is where SM address is placed..)
	   var avatarURL;
		if (QRAvatarURL && QRAvatarURL.length > 0)
		   avatarURL = QRAvatarURL;
		else
		   avatarURL = "https://SemanticMarker.org/images/SM-Circle-R.png";

		// create a semantic marker with the avatarURL (since this is called 2 times for same 'sm' .. only do it once)
		if (sm)
         createSemanticMarkerPath(webAddress, avatarURL, sm, smCommand);

		if (otherSMId)
         createSemanticMarkerPath(webAddress, avatarURL, otherSMId, smCommand);

		 // set the Avatar URL
       var q = document.getElementById(QRAvatarId);
		 q.src = avatarURL;

		//12.8.22
		if (recordedTextId)
		{
		   // break up the flow
		   flowsHTML = "";
         for (var i =0; i< flowArray.length; i++)
		   {
			   var element = flowArray[i];

			   flowsHTML += element + "\n";
		   }

		   if (flowsHTML.length > 0)
            document.getElementById(recordedTextId).value = flowsHTML;

		}
}

//! 5.8.23 Pauls 69th birthday
//! hide or show the markup (and later other) fields
function hideShowMarkup(elementIdArray)
{
	 var doHide = false;
	 for (let i=0; i< elementIdArray.length; i++)
	 {
	    var elementId = elementIdArray[i];
	    var o = document.getElementById(elementIdArray[i]);
		 if (o)
		 {
		    doHide = ! o.hidden;
			 break;
		 }
	 }
	 for (let i=0; i< elementIdArray.length; i++)
	 {
	   var elementId = elementIdArray[i];
	   var o = document.getElementById(elementId);
		if (o)
	     o.hidden = doHide;

	 }

	 //save state in a cookie
	 saveCookies();


}

//! 5.19.23 use a tidy HTML function
//! 
function tidy(html)
{
  var d = document.createElement('div');
  d.innerHTML = html;
  return d.innerHTML;
}

//! 6.1.23 call to get the SemanticMarker (generic with SM) from the _base64Images array
//! SM in form UUID.flow
function getBase64Image(SM)
{

  var img = null;
  for (var i =0; i< _base64Images.length; i++)
  {
	  // smflow is a JSON object {name, ...}
     let object = _base64Images[i];
     let SM = object.SM;
	  if (SM.localeCompare(object.SM)==0)
	  {
	     //found match .. could still be nil
	     let img = object.img;
		  return img;
	  }
  }
  return img;
}

//! 5.7.23 (Abandoned house burning down at corner..)
//! pass in the markup text, and return same with links..
//! 5.19.23 .. syntax:   @SM(uuid.flow)  and other @u(u.f) @web(dkkdkd)
//! want to grab items from the SMART button, like the avatar, the next links.. the Audio..
//! isInternalWeb === this browser, false == remote web    TODO..
//! 5.22.23 the PDF created won't have live video and won't have a link .. so add it as a button..
//! 5.29.23 add @(playlist),  @(header), @(avatar), @(QRAvatar), @(SM) .. todo
function replaceSMLinks(markup, flow, isInternalWeb)
{
	 let markupFinal = "";
	 for (let i=0; i< markup.length-1; i++)
	 {
		 let c = markup[i];
		 let c2 = markup[i+1];
		 // @(  .. not many HTML that use that .. so not worring..
	    if (c == '@' && c2 == '(')
		 {
		    i += 2;
			 // @(uuid.flow),  @(video) @(audio) ...
		    // now look for @( <internal> )
			 
          // search for ) .. or end of file
			 let parsedToken = "";
			 while (markup[i] != ')'  && i < markup.length)
			 {
			    parsedToken += markup[i];
				 i++;
			 }
			 // if not a ) then hit the end of the line.. give up..
			 if (markup[i] != ')')
			 {
				 // note i could be reversed and continue loop..
			    console.log("*** Invalid HTML syntax***");
				 return tidy(markup);
			 }
    
		     //! get the flowName, but it might be null since
		     //! async call (if not cached) Call back later..
	        let flowName = flow.name; // flowName (but name in JSON0

		     //! get the markup
		     let videoSM = flow.videoSM;
		     let QRAvatarURL = flow.QRAvatarURL;
		     let audioSM = flow.audioSM;
           let uuid = flow.uuid;
	        let flowNum = flow.flowNum;
	        let nextURL = flow.nextFlowURL;
			  let desc = flow.desc;
			  //etc..

   		 if (parsedToken.localeCompare("header")==0)
   		 {
				 let SM = createSM(uuid,flowNum);
      		 let webAddress = _semanticMarkerFlowURL  + "smart?uuid=" + uuid + "&flow=" + flowNum;
				 let result = "<h2>Semantic Marker&#x2122; SMART Button</h2>\n";
      
      		 result += "<h3 id='" + SM + "'>";
      		 if (flowName)
      		    result += flowName;
             result += " (" + SM + ")\n";
      
      		 result += "</h3>\n";
             result += "<a href='" + webAddress + "'>" + "(Invoke SMART Button - or touch Semantic Marker)" + "</a><br>\n" ;
      		 result += "<p>" + desc + "</p><br>\n";

				 //append to result
				 markupFinal += result;
   
   		 }
			 else if (parsedToken.localeCompare("video")==0)
			 {
			       if (videoSM && videoSM.length > 0)
					 {
						 if (false)
						 {
							// This version just creates an Image with the Play button
					      let mediaName = "video";
					      let mediaType = "video/mp4";
					      let showVideo = "<" + mediaName + " width='480' height='320' controls><source src='" + videoSM + "' type='" + mediaType + "'>"
   			         markupFinal += "<br>" + showVideo + "</video> ";
						 }
						 else
						 {
							// This version plays automatically
						   let showVideo = "<img width='50%' src='" + videoSM + "'>";
   			         markupFinal += "<br>" + showVideo + "<br>";

                     //! 5.22.23 the PDF created won't have live video and won't have a link .. so add it as a button..
							//!  <a href="videoURL ..">videoURL</a>
							showVideo = "<a href='" + videoSM + "'>Play Video</a><br>";
   			         markupFinal += "<br>" + showVideo + "<br>";

						 }
					 }
			 }
			 else if (parsedToken.localeCompare("audio")==0)
			 {
			       if (audioSM && audioSM.length > 0)
					 {
   			       let mediaName = "audio";
                   let mediaType = "audio/mp3";
					    let showAudio = "<" + mediaName + " width='480' height='320' controls><source src='" + audioSM + "' type='" + mediaType + "'>"
   			       markupFinal += "<br>" + showAudio + "</audio> ";
					 }
			 }
			 //! @(playlist) pulls out the playlist in 'artifactSM' for now...
			 else if (parsedToken.localeCompare("playlist")==0)
			 {
			       var playlist = flow.artifactsSM;
   		       markupFinal += "<br>" + processPlaylist(playlist); 
			 }
			 //! @(slideshow) pulls out the slideshow in 'artifactSM' for now...
			 else if (parsedToken.localeCompare("slideshow")==0)
			 {
			       var slideshow = flow.artifactsSM;
   		       markupFinal += "<br>" + processSlideshow(slideshow); 
			 }
			 // create a table for the SMART Deck.. taken from the code below
			 else if (parsedToken.localeCompare("SMARTDeck")==0)
			 {
       		//! #### The table for the other avatars
      	    // 4.30.23 show the deckSM links in a pulldown
      	    // let it know what the parent starting this..
             let deckSMLinks = getSMDeckLinksArray(flow.deckSM);
       		 let htmlTable = "<br><b>SMART Deck</b><table>";
            	// use the deckSMLinks array created above .. where the avatarURL is set
            	for (let i=0; i< deckSMLinks.length; i++)
            	{
            	   let object = deckSMLinks[i];
            		let thisSM = object.SM;
            		let flowName = object.flowName;
            		let avatarURL = object.avatarURL;

						// grabs the image .. which should already be retrieved
						// this will be base64 image .. with lots of text..
						let semanticMarkerImageHTML = getBase64Image(object.SM);
						if (semanticMarkerImageHTML)
						{

							// note the semanticMarkerHTML ==  the <img> already..
							//<img width=200 src="data:image/png;base64,${msg.merged.toString('base64')}">;

						   // the href=#SM is a link inside this document
            	      htmlTable += "<td style='vertical-align:top'>" + flowName + "<br><a href='#" + thisSM + "'>" +  semanticMarkerImageHTML + "</a>\n";
            	      htmlTable += "<br><a href='#" + thisSM + "'><img width='200' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + thisSM + "\")'></a></td>\n";

						}
						else
						{
      	            htmlTable += "<td>" + flowName + "<br><a href='#" + thisSM + "'><img width='100' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + thisSM + "\")'></a></td>\n";
						}
            	}
            
				//.... doesn't seem to be doing this code.. it's 0:Inherited instead

            	// 5.6.23 if the inherited .. tack the button at the end
               let inheritedSM = flow.inheritedSM;
            	if (inheritedSM && inheritedSM.length > 0)
            	{
            	  // tack on inherited at the end..
            	  let flowName = flowNameOfSM(inheritedSM);
            	  let avatarURL = avatarURLOfSM(inheritedSM);

						// grabs the image .. which should already be retrieved
						// this will be base64 image .. with lots of text..
						let semanticMarkerImageHTML = getBase64Image(inheritedSM);
						if (semanticMarkerImageHTML)
						{

						   // the href=#SM is a link inside this document

            	      htmlTable += "<td><table border='2' cellpadding='4' ><tr style='vertical-align:top'><td bgcolor='grey'>2.Inherited:: " + flowName 
							+ "<br><a href='#" + inheritedSM + "'>" +  semanticMarkerImageHTML + "</a>\n"
            		   + "<br><img width='200' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + inheritedSM + "\")'></a></td>\n";

						}
						else
						{
            	      htmlTable += "<td><table border='2' cellpadding='4' ><tr><td bgcolor='grey'>3.Inherited:: " + flowName 
         		   + "<br><a href='#" + inheritedSM + "'><img width='100' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + inheritedSM + "\")'></a></td>\n";
					   }
            	}
            
            
            	htmlTable += "</tr>\n</table><br>\n";

					console.log(htmlTable);
      
      			markupFinal += htmlTable;
			 }
			 else if (parsedToken.localeCompare("QRAvatar")==0 || parsedToken.localeCompare("avatar")==0)
			 {
   			    markupFinal += "<br><img width='380' src='" + QRAvatarURL + "'>\n";
			 }
			 else if (parsedToken.localeCompare("SM")==0)
			 {
   			    //markupFinal += "<br><img width='380' src='" + QRAvatarURL + "'>\n";
					 //TODO... how to create one on the fly ..?? when the HTML won't have this .. 
					 //your SM.. but it would be nice to show other SM's too..
			 }
			 else if (parsedToken.localeCompare("next")==0)
			 {
			    // add a next pointer.. using URL ..
	           if (nextURL  && nextURL.length > 0 && "undefined".localeCompare(nextURL)!=0)
				  {
				    let nextButton = "<br><a href='" + nextURL +  "'>" + nextURL + "</a>";
   			    markupFinal += nextButton + " ";
				  }
			 }
			 else
			 {
   			 //parsedToken == our SM, lets add  push

				 let thisSMUUID = getUUIDFromSM(parsedToken);
             let thisSMflowNum = getFlowNumFromSM(parsedToken);
             let thisSMFlow = flowOfFlowNum(thisSMUUID, thisSMflowNum);
				 // see if this has been retrieved..
				 //NOTE: potential for a named item .. that is changed later after the async retrieval
				 //Need to try promise: https://www.geeksforgeeks.org/how-to-make-javascript-wait-for-a-api-request-to-return/
				 //TODO..
				 let thisFlowName = thisSMFlow?thisSMFlow.name:parsedToken;

   			 // quote the SM 
				 let showButton = "";
				 // internal is the SMART Button page
				 // external is the web page @(markup)
				 if (isInternalWeb)
   			    showButton = "<input type='button' onclick=\"showSMLinkSM('" + parsedToken + "')\" value='" + thisFlowName + "'/>";
				 else
				    showButton = "<a href='" + _semanticMarkerFlowURL  + "smart?" + thisSMUUID + "&flow=" + thisSMflowNum + "'>" + thisFlowName + "</a>";
   			 markupFinal += showButton + " ";
			 }
		 }
		 else
		    markupFinal += c;

		 // next loop will have c being the c2 spot if no match.
		 // i == last character read (c2 or the ')'
		 // and it's incremented top of this loop

	 }

	 // tidy up the HTML..
	 markupFinal = tidy(markupFinal);
	 console.log("MarkupFINAL = "  + markupFinal);
	 return markupFinal;

}

// sorted by {"uuid":UUID, "flows":JSONFlow}
//NOTE: this might be a subset of the flows (in case when just asking for a single flow)
var _cachedFlowsJSON = [];

//! gets or creates a UUID for existing user "/createuuid"
//! Makes async request for the JSON data
//! NOTE: if flowsSelectId == null then don't update the global, only the cache
function getSMFlows(uuidStringTextId, flowsSelectId)
{
  // the means this is just a retrieval to update the _cache
  let onlyGetFlows = flowsSelectId == null;

  let uuid;
  if (onlyGetFlows)
  {
     uuid = document.getElementById(uuidStringTextId).value;
  }
  else
  {

     // get the selected from the _UUID_Select options, which will be a UUID
     var uuidSelect = document.getElementById('_UUID_Select');
     var uuidSelected = uuidSelect.value;


     //new: 
     uuid = uuidSelected;

     //now update the uuidStringTextId
     document.getElementById(uuidStringTextId).value = uuid;
	}
  
  //TODO: when run as an unnamed user, the username/password isn't needed (but the user can't update)

  // async command
  var command = _semanticMarkerFlowURL + "smart?uuid=" + uuid + "&username=" + _username + "&password=" + _password  + "&format=json";

  var xhttp = new XMLHttpRequest();

  // format=json so this will be json..
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
		//!result is the SM FLOW flows.. [{flow},{flow}]
		var jsonReply = this.responseText;

		if (jsonReply &&  jsonReply.indexOf("error") >= 0)
		{

         alert(jsonReply);
			return;
		}
		if (jsonReply.length == 0 )
		{

         alert("You must login to your agent");
			return;
		}

      var flowsJSON = JSON.parse(jsonReply);

		// 4.30.23
		// push this object, or update the one there..
		var object = {"uuid":uuid,"flows":flowsJSON};
		var found = false;
		for (let i=0; i< _cachedFlowsJSON.length;i++)
		{
		   if (uuid == _cachedFlowsJSON[i].uuid)
			{
				console.log("pushing (updating cashedFlow): " + _cachedFlowsJSON[i].uuid);
				// update the cachedFlow
            _cachedFlowsJSON[i].flows = flowsJSON;
				found = true;
				break;
			}
		}
		// adding a new cachedFlowJSON object
		if (!found)
		{
			console.log("pushing cashedFlow: " + object.uuid);
		   _cachedFlowsJSON.push(object);
		}

		// 4.30.23 .. if null then we are just requesting the UUID, for use by other flowss
		if (onlyGetFlows)
		   return;

		//save globally for the current showSMFlow
      _userFlowsJSON = flowsJSON;

		console.log("getSMFlows updating result _userFlowsJSON");

		var flowsHTML = "";

		//!Try sorting by Category, then Num
		//! https://stackoverflow.com/questions/4833651/javascript-array-sort-and-unique
		//! First find the categories..
		var categories = [];
		var flowNumbers = [];
		var flowNames = [];
      for (var i =0; i< flowsJSON.length; i++)
		{
			var flow = flowsJSON[i];
			categories.push(flow.flowCat);
			flowNumbers.push(flow.flowNum);
			flowNames.push(flow.name);
		}
		//!alphebet sort
		categories.sort();

		//!alphebet sort
		flowNames.sort();

		//! sort numbers so 10 and 100 are in right order (Actually not used as the NAME is the sort)
		//! https://stackoverflow.com/questions/1063007/how-to-sort-an-array-of-integers-correctly
		flowNumbers.sort(function(a,b) { return a-b; });

		// now make them unique (new Set) and back to an array
		categories = Array.from(new Set(categories));
		flowNumbers = Array.from(new Set(flowNumbers));
		flowNames = Array.from(new Set(flowNames));

		//! groups: https://stackoverflow.com/questions/17316540/make-some-options-in-a-select-menu-unselectable
		for (flowCat of categories)
		{
			flowsHTML += "<optgroup label='" + flowCat + "'>" + "\n";

			for (flowName of flowNames)
			{
            for (var i =0; i< flowsJSON.length; i++)
		      {
			      var flow = flowsJSON[i];
					thisFlowName = flow.name;
					thisFlowCat = flow.flowCat;
					thisFlowNum = flow.flowNum;

					// only continue if same flow category
					if (thisFlowCat.localeCompare(flowCat) != 0)
					   continue;

					// only continue if same flow name
					if (thisFlowName.localeCompare(flowName) != 0)
					   continue;

					// now we are the correct flowCategory, and flowName
		         for (flowNum of flowNumbers)
				   {
					   if (thisFlowNum.localeCompare(flowNum) != 0)
						   continue;

						// Finally output an option
			         flowsHTML += "<option value='" + i + "'>" + flow.name + "</option>\n";
			         //flowsHTML += "<option value='" + i + "'>" + flow.name + " (" + flow.flowNum + ")</option>\n";
   
				   }
				}

			}
			flowsHTML += "</optgroup> \n";

		}

		// if no flowsSelectId
		if (flowsHTML.length > 0 && flowsSelectId)
		{
         document.getElementById(flowsSelectId).innerHTML = flowsHTML;

//ISSUE: grabbing a different UUID .. this id will be wrong..
		   // set the first option.. BUT this doesn't fill in the values..
         document.getElementById(flowsSelectId).value = 0;
		}

    }
  };
  xhttp.open("GET",command, true);
  xhttp.send();
}

//! called to get just the parameters of a flow's category
//! flowCatDupID .. is the other Id where the flow is shown
function getCatParms(flowsSelectId, flowsParameterId, flowCatDupId)
{
  // use global id:  
  var selectedFlowIndex = document.getElementById(flowsSelectId).value;
  var flow = _userFlowsJSON[selectedFlowIndex];

  //! grab values from the JSOn flow object 
  var flowName = flow.name;
  var private = flow.private;
  var isdata = flow.isdata;
  var uuid = flow.uuid;
  var flowNum = flow.flowNum;
  var flowCat = flow.flowCat;
  var date = flow.date;


  //! update the duplicate flow category text iD
  document.getElementById(flowCatDupId).value = flowCat;

  //NOTE this will return all the flows just in that cat (TODO).
  var command = _semanticMarkerFlowURL + "smart?uuid=" + uuid + "&username="  + "&flowcat=" + flowCat;

  var xhttp = new XMLHttpRequest();

  // format=json so this will be json..
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
		//!result is the SM FLOW flows.. [{flow},{flow}]
		var jsonReply = this.responseText;

		// array of flows
      var flowsJSON = JSON.parse(jsonReply);


		var flowsHTML = "";
		// for now... since no flownum specified, we have all the flows..
		// SO we have the info to sort by this category ourselves...
		// Eventually, this query will return only those in the category..
		var uniqueParametersArray = [];

      for (var x =0; x< flowsJSON.length; x++)
		{
			var flow = flowsJSON[x];
		   parametersArray = flow.parameters;

			// only for this category
			var category = flow.flowCat;
			if (!category || !flowCat || category.localeCompare(flowCat)!=0)
			   continue;


         //then set the parameter 
         for (var i =0; i< parametersArray.length; i++)
		   {
			   var element = parametersArray[i];

				//check if exists already..
				if (uniqueParametersArray.indexOf(element) >= 0)
				   continue;

				//add otherwise
				uniqueParametersArray.push(element);


			   flowsHTML += "<option value='" + i + "'>" + element + "</option>\n";
		   }
		}

		if (flowsHTML.length > 0)
         document.getElementById(flowsParameterId).innerHTML = flowsHTML;

    } // this.readyState
  };
  xhttp.open("GET",command, true);
  xhttp.send();
}


//!test the POST
function sendJSONAsPOST(flowMetaJSON, uuidStringTextId, flowsSelectId, removeFlow)
{

	 /*
	 var flowMetaJSON = { "name" : "scotty",
								 "uuid" : "uuid",
								 "isdata": "false",
								 "private": "true", 
	                      "flowNum"  : "1",
								 "flowCat"  : "maggie",
								 "date" : "DATE"
								};

*/

    let xhr = new XMLHttpRequest();
    //xhr.open("POST", "http://localhost:1880/smflowpost");

	 if (removeFlow)
       xhr.open("POST", _semanticMarkerFlowURL + "smflowpostremove");
	 else
       xhr.open("POST", _semanticMarkerFlowURL + "smflowpost");

    xhr.setRequestHeader("Accept", "application/json");
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        console.log(xhr.status);
        console.log(xhr.responseText);

		  // call again and get the updated JSON flow (BUT THis is just one UUID ..)
        getSMFlows(uuidStringTextId, flowsSelectId);
      }};


    xhr.send(JSON.stringify(flowMetaJSON));
}


//!test the POST, Only send username and password
function repostToHidePassword()
{
//NOT WORKING.. can't figure out getting past error of duplicate symbols
//https://developer.mozilla.org/en-US/docs/Web/API/Document/write
// Seems document.write() not liked 

	// https://stackoverflow.com/questions/483745/replace-html-page-with-contents-retrieved-via-ajax
   // seems it trys to create duplicate variable '_useFinal'

	 var flowMetaJSON = { "username" : _username,
								 "password" : _password
								};


    let xhr = new XMLHttpRequest();
    //xhr.open("POST", "http://localhost:1880/posttest");
    xhr.open("POST", _semanticMarkerFlowURL + "userpagemessagesPOST");

    xhr.setRequestHeader("Accept", "application/json");
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        console.log(xhr.status);
        //console.log(xhr.responseText);
		  //document.querySelector('html').innerHTML = xhr.responseText;
		  document.open();
        document.write(xhr.responseText);
        document.close();
      }};

    console.log(JSON.stringify(flowMetaJSON));

    xhr.send(JSON.stringify(flowMetaJSON));
}

//! store the uuid, flow of the copied SM
// {"SM":sm, "uuid":uuid, "flowNum":flownum, "flow":flow};
var _lastCopiedSM = null;

//! inherits from the copied SM, user still has to save
//!  Inherit SM
function inheritSM(justClone)
{
   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}
   // dont' use the UUID..
	if (!_lastCopiedSM)
	{
      alert("Please click 'Copy SM' first before the Inherit button");
		return;
	}
	var uuid = _lastCopiedSM.uuid;
	var flowNum = _lastCopiedSM.flowNum;
	if (justClone)
	{
	   // use a unique FlowNum
		flowNum = createFlowNumber();
	}
	var flow = _lastCopiedSM.flow;
	if (flow)
	{
	  //! check if flowNum already used .. in which case the user must choose a different SMART Deck (uuid)
	  for (let i=0; i< _userFlowsJSON.length; i++)
	  {
	      var num = _userFlowsJSON[i].flowNum;
			if (num == flowNum)
			{
			    alert("*** The flowNum already exists in your SMART Deck. \nChoose a different SMART Deck and try again."
				    + "\nFlow name wth same number = " + _userFlowsJSON[i].name + "\nFlow number = " + num);
				 return;
			}
	  }
	  var flowName = flow.name;
	  var flowCat = flow.flowCat;

	  let suggestFlowName = "My_" + flowName;
	  let newFlowName = prompt("Enter your name for " + (justClone?"cloned":"inherited") + " flow name: " + flowName + "\nSuggest: ", suggestFlowName);
	  if (!newFlowName || newFlowName=="")
	  {
	      alert("Cancelled request. Try again later");
			return;
	  }

	  let suggestFlowCat = flowCat + (justClone?"_cloned":"_inherited");
	  let newFlowCat = prompt("Enter your name for " + (justClone?"cloned":"inherited") + " flow cat: " + flowCat + "\nSuggest same: ", suggestFlowCat);
	  if (!newFlowCat || newFlowCat=="")
	  {
	      alert("Cancelled request. Try again later");
			return;
	  }

     let yourUUID = document.getElementById('_uuidStringText').value;
	  if (!confirm((justClone?"Cloning":"Inheriting") + " flow into your SMART Deck with uuid: " + yourUUID + "\nFlowName: " + newFlowName + "\nFlowCat: " + newFlowCat + "\nFlowNum: " + flowNum 
	      + "\n(Note: you must click 'Save Semantic Marker' and confirm overwriting instance"))
	  {
	      alert("Cancelled request. Try again later");
			return;
	  }

	  //todo.. finish.   call setSM()
	  // 1. copy the flow .. and modify the flowCat and flowName and uuid
	  // SOMEONE has to copy the flow ..
	  // if inherit, the flowNum will be the same,
	  // if cloning the flowNum will be unique for this UUID
	  flow.flowNum = flowNum;
	  flow.uuid = yourUUID;
	  flow.name = newFlowName;
	  flow.flowCat = newFlowCat;
	  flow.inheritedSM = _lastCopiedSM.SM;
	  let thisDeckSM = createSM(yourUUID, flowNum);
	  // add to the UUID's flow..
	  _userFlowsJSON.push(flow);
     pushSMLink(thisDeckSM)
	}

}

//! retrieves a SM .. but as it's async .. call back later..
//!  "Retrieve SM"
function retrieveSM(justClone)
{
   // justClone says do all this copying, but use a unique Flow#

   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}
	let SM = prompt("Enter your SM (UUID.flownum):", _lastCopiedSM?_lastCopiedSM.SM:"");
	if (!SM || SM=="")
	{
	  alert("Cancelled request. Try again later");
	  return;
	}

	// check for valid SM
	let parts = SM.split(".");
	if (parts.length != 2)
	{
		alert("Wrong UUID.flownum syntax: " + SM + " - try again");
	   return;
	}

   let uuid = getUUIDFromSM(SM);
	let flowNum = getFlowNumFromSM(SM);
	// store in last copied..
	_lastCopiedSM = {"SM":SM,"uuid":uuid,"flowNum":flowNum, "flow":null};

	//! get the flowName, but it might be null since
	//! async call (if not cached) Call back later..
	let flowName = flowNameOfSM(SM);

	if (flowName)
	{
		// get the flow..
	   _lastCopiedSM.flow = flowOfFlowNum(uuid, flowNum);;
      inheritSM(justClone);
	}
	else
	{
	   alert("Awaiting SM: " + SM + " to be retrieved. Try again soon");
	}
}

//! copySM,  "Copy SM"
function copySM(SM)
{
   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}
  let uuid = getUUIDFromSM(SM);
  let flowNum = getFlowNumFromSM(SM);
  let flow = null;
  for (let i=0; i< _userFlowsJSON.length; i++)
  {
		if (_userFlowsJSON[i].flowNum == flowNum)
		{
			flow = _userFlowsJSON[i];
		   break;
		}
  }
  if (!flow)
  {
     alert("No Flow for SM: " + SM + "\nPlease file bug report");
  }
  else
  {
     var object = {"SM":SM, "uuid": uuid, "flowNum": flowNum, "flow": flow};
     _lastCopiedSM = object;
  }

  // 7.5.23 add to the _savedSMARTDeck
  let smartDeck = document.getElementById('_savedSMARTDeck').value;
  if (smartDeck.length > 0)
     smartDeck += ",";
	smartDeck += SM;
  document.getElementById('_savedSMARTDeck').value = smartDeck;

  // Copy the text inside the text field
  navigator.clipboard.writeText(SM);

  //alert("Copied " + SM);
}

//! creates a flow number (a uuid)
function createFlowNumber()
{
	 var uuid = Date.now();

	 return uuid;
}

//! creates a flow number (a uuid)
function createFlowUUID(flowNumberTextId)
{
	 var uuid = createFlowNumber();

    document.getElementById(flowNumberTextId).value = uuid;
}

//! clears a text area
function clearTextArea(textAreaId)
{
   var currentVal = document.getElementById(textAreaId).value;
	console.log("clearing: " + currentVal);
   document.getElementById(textAreaId).value = "";
}


//! Instructions for adding a field to the FLOW object
/* 
	// maybe a get flow decoded command.
	 3.22.23 

		 KSMatrix - 3a5bab .. 
		 dataSM - location of data information
		 artifactsSM - artifacts
		    NOTE: artifacts could be pointed to from text
		 markup - text or something that might point to the artifacts. Markup language for example
		 languagesSM - info about the language translations..
		 videoSM - link to a video artifact (mp4 ..)
		 isCirularAvatar - whether a circular avatar

	    audioSM -- address of a audio link (or SM)
		    "audioSM
	    locationSMId -- text: id of the string of where this SM was inherited from
		    "locationSM
	    inheritedSMId -- text: id of the string of where this SM was inherited from
		    "inhertedSM
		 X- isDeckId - if a SMART Deck
		    "isDeck
		 deckSMId - a text field of command sepeated addresses
		    "deckSM
		 isMessagingId - if on (set by the owner) then MQTT messagign will ocurr at UUID.flownum topic
		    "whether there are MQTT messages over this Semantic Marker address (UUID.flownum)
       isIndirectSMId - flag if the indirectSm is used (replaces isData)
		    isIndirectSM - flag
		 indirectSMId - if set, then a call will go to this indirect SM 
		    "indirectSM - the address to go to.. the previous isData and nextURL

		 KSWave (address of the Knowledge Shark Wave)
		 bridgeSM (info about the bridge across MQTT Topics
		 future -- placeholder

	inheritedSMId, isDeckId, deckSMId, isMessagingId, isIndirectSMId, indirectSMId))

	msg.flow = {
       "name": msg.payload.name,
       "uuid": msg.payload.uuid,
       "isdata": msg.payload.isdata,
       "private": msg.payload.private,
       "flowNum": msg.payload.flowNum,
       "flowCat": msg.payload.flowCat,
       "date": msg.payload.date,
       "parameters": msg.payload.parameters,
       "desc": msg.payload.desc,
       "QRAvatarURL": msg.payload.QRAvatarURL,
       "nextFlowURL": msg.payload.nextFlowURL,
       "flow": msg.payload.flow,

        //3.22.23
        "audioSM": msg.payload.audioSM,

        "locationSM": msg.payload.locationSM,
        "inheritedSM" : msg.payload.inheritedSM,
        "isDeck": msg.payload.isDeck,
        "deckSM":msg.payload.deckSM,
        "isMessaging":msg.payload.isMessaging,
        "isIndirectSM": msg.payload.isIndirectSM,
        "indirectSM": msg.payload.indirectSM


         //3.25.23
         "videoSM": msg.payload.videoSM,
         "dataSM": msg.payload.dataSM,
         "KSMatrix": msg.payload.KSMatrix,
         "KSWave" : msg.payload.KSWave,
         "bridgeSM": msg.payload.bridgeSM,
         "future": msg.payload.future,
         "artifactsSM":msg.payload.artifactsSM,
         "languagesSM":msg.payload.languagesSM,
         "isCircularAvatar":msg.payload.isCircularAvatar,
         "markup":msg.payload.markup

   }

	//delete node:

	   //!UNfortunately these are manual, so each JSON update, must update these too..
    //!remove these
    delete msg.payload.isdata;
    delete msg.payload.private;
    delete msg.payload.flowNum;
    delete msg.payload.flowCat;
    delete msg.payload.parameters;
    delete msg.payload.desc;
    delete msg.payload.QRAvatarURL;
    delete msg.payload.flow;
    delete msg.payload.flows;
    delete msg.payload.uuid;
    delete msg.payload.name;

    delete msg.payload.nextFlowURL;

    //3.22.23
    delete msg.payload.audioSM;
    delete msg.payload.locationSM;
    delete msg.payload.inheritedSM;
    delete msg.payload.isDeck;
    delete msg.payload.deckSM;
    delete msg.payload.isMessaging;
    delete msg.payload.isIndirectSM;
    delete msg.payload.indirectSM;

    //3.25.23
    delete msg.payload.videoSM;
    delete msg.payload.dataSM;
    delete msg.payload.KSMatrix;
    delete msg.payload.KSWave;
    delete msg.payload.bridgeSM;
    delete msg.payload.future;
    delete msg.payload.artifactsSM;
    delete msg.payload.languagesSM;
    delete msg.payload.isCircularAvatar;
    delete msg.payload.markup;


	#then for the "Grab just the flownum ..

	
	msg.payload.flowJSON2 = JSON.stringify(flow);
    msg.payload.flowJSON = flow;
    msg.payload.uuid = flow.uuid;
    msg.payload.desc = flow.desc;
    msg.payload.flowNum = flow.flowNum;
    msg.payload.flowCat = flow.flowCat;
    msg.payload.flow = JSON.stringify(flow.flow);
    msg.payload.parameters = JSON.stringify(flow.parameters);
    //outer payload.name == username
    // flow.name
    msg.payload.username = msg.payload.name;
    msg.payload.name = flow.name;

    msg.payload.isdata = flow.isdata;
    msg.payload.QRAvatarURL = flow.QRAvatarURL;
    msg.payload.nextFlowURL = flow.nextFlowURL;
    msg.payload.private = flow.private;

    //3.25.23
    msg.payload.videoSM = flow.videoSM;
    msg.payload.dataSM = flow.dataSM;
    msg.payload.KSMatrix = flow.KSMatrix;
    msg.payload.KSWave = flow.KSWave;
    msg.payload.bridgeSM = flow.bridgeSM;
    msg.payload.future = flow.future;
    msg.payload.artifactsSM = flow.artifactsSM;
    msg.payload.languagesSM = flow.languagesSM;
    msg.payload.isCircularAvatar = flow.isCircularAvatar;
    msg.payload.markup = flow.markup;

    //3.22.23
    msg.payload.audioSM = flow.audioSM;

    msg.payload.locationSM = flow.locationSM;
    msg.payload.inheritedSM = flow.inheritedSM;
    msg.payload.isDeck = flow.isDeck;
    msg.payload.deckSM = flow.deckSM;
    msg.payload.isMessaging = flow.isMessaging;
    msg.payload.isIndirectSM = flow.isIndirectSM;
    msg.payload.indirectSM = flow.indirectSM;



	 //in xcode
	 //!3.22.23
    [_orderedFlowKeys addObject:@"locationSM"];
    [_orderedFlowKeys addObject:@"inheritedSM"];
    //[_orderedFlowKeys addObject:@"isDeck" ];
    [_orderedFlowKeys addObject:@"deckSM"];
    [_orderedFlowKeys addObject:@"isMessaging"];
    [_orderedFlowKeys addObject:@"isIndirectSM" ];
    [_orderedFlowKeys addObject:@"indirectSM"];
    [_orderedFlowKeys addObject:@"audioSM"];

	 [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"locationSM"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"inheritedSM"];
    //[_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"isDeck" ];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"deckSM"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"isMessaging"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"isIndirectSM" ];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"indirectSM"];

	 //! 3.25.23
    [_orderedFlowKeys addObject:@"videoSM"];
    [_orderedFlowKeys addObject:@"dataSM" ];
    [_orderedFlowKeys addObject:@"KSMatrix"];
    [_orderedFlowKeys addObject:@"KSWave"];
    [_orderedFlowKeys addObject:@"bridgeSM"];
    [_orderedFlowKeys addObject:@"future" ];
    [_orderedFlowKeys addObject:@"artifactsSM"];
    [_orderedFlowKeys addObject:@"isCircularAvatar"];
    [_orderedFlowKeys addObject:@"markup"];

	 [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"videoSM"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"dataSM" ];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"KSMatrix"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"KSWave" ];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"bridgeSM"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"future"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"artifactsSM" ];
    [_flowsToTableViewCell setValue:[KSBLEFlowsJSONTableViewCell class] forKey:@"isCircularAvatar"];
    [_flowsToTableViewCell setValue:[KSBLEFlowsTextTableViewCell class] forKey:@"markup"];
*/


//! From: https://jsfiddle.net/user2314737/z437nxaq/
//! update from: https://stackoverflow.com/questions/2109205/open-window-in-javascript-with-html-inserted
//! sends the HTMl element to the printer..
function printDiv(htmlText) 
{
   var handheld = false;
   if (confirm("CANCEL - normal web broser, a new window shows up\n\nOK - if using a handheld device\n"))
	  handheld = true;


   if (!handheld)
   {
	  // first parameters is '' === about:blank
     let mywindow = window.open('', 'SMARTConeTree', 'height=650,width=900,top=100,left=150');
     let title = "SMARTConeTree";

	  //try.. https://stackoverflow.com/questions/1197575/can-scripts-be-inserted-with-innerhtml
	  if (true)
	  {
		  //! TODO.. add this layer of javascript into the generated code (basically what it takes
		  //  to get the inline code to work (like 'playEnded()  and other..., The Slideshow for example)
		  //!!!!! THIS IS WORKING !!!!
  
        let header = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\"" +
           "\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">" +
             "<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n";
        var resultConeTree = header + "<title>SMART Cone Tree</title>\n";

		  //! https://html.spec.whatwg.org/multipage/semantics.html
		  //! elements of HTML:
		  //   1. document element (html)
		  //  2. document (head, title, base, link (media, type, link), meta, style)

		  // html 
		  //NO: Gets error: 
		  //Blocked a frame with origin "null" from accessing a cross-origin frame. 
		  // protocols, domains, and ports must match
		  if (false)
		  {
	        var newHtml = mywindow.document.createElement("html");
		     var htmlText = "lang='en'";
	        newHeader.innerHTML = headerText;
	        mywindow.document.html.appendChild(newHtml);
		  }

		  // link header
	     var newLink = mywindow.document.createElement("link");
		  var linkText = "rel='SHORTCUT ICON' href='https://idogwatch.com/iDogWatch.png' type='image/png'";
	     newLink.innerHTML = linkText;
	     mywindow.document.head.appendChild(newLink);

		  //!https://html.spec.whatwg.org/multipage/dom.html#the-document-object
		  // title header
	     var newTitle = mywindow.document.createElement("title");
		  var titleText = "SMART Cone Tree";
	     newTitle.innerHTML = titleText;
	     mywindow.document.head.appendChild(newTitle);

		  //!SM script
	     var newStyle = mywindow.document.createElement("style");
	     var styleText = "@media print{h3 {page-break-before:always}}";
	     newStyle.innerHTML = styleText;
	     mywindow.document.head.appendChild(newStyle);

		  // script header
	     var newScript = mywindow.document.createElement("script");
	     var scriptText = " function playEnded(num) { alert('PlayEnded'); } ";
	     newScript.innerHTML = scriptText;
	     mywindow.document.head.appendChild(newScript);
		  
		  //!SM script
	     newScript = mywindow.document.createElement("script");
	     scriptText = "src='https://SemanticMarker.org/SemanticMarker.js?v=1'"; 
	     newScript.innerHTML = scriptText;
	     mywindow.document.head.appendChild(newScript);

	  }

	  // rest of the text
	  mywindow.document.body.innerHTML = htmlText;
   
     //mywindow.document.close(); // necessary for IE >= 10
     //mywindow.focus(); // necessary for IE >= 10*/
   
   //  mywindow.print();
   //  mywindow.close();
   
   }
   else
   {

	  //keep:
     document.body.innerHTML = htmlText;
   }

  return true;
}

//! 4.26.23 Added start of document printout
//! to stop recursion when  not wanted
//! List of all SM's, from the root out.. 
//! { SM, SMFlow }
var _requestedSMs = [];

//! pass in the ID.. to start with.. This will have a parent=SMART
function traverseSMARTDeck(uuidStringTextId, flowNumId)
{
   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}

  let uuidSelect = document.getElementById(uuidStringTextId);
  let uuid = uuidSelect.value;

  let flowNum = document.getElementById(flowNumId).value;
  if (!flowNum || flowNum.length==0)
  {
      alert("Select a Flow and click 'Show SM Flow'");
	   return;

  }


  //!reset the _base64Images too??
  //NO: lets keep them cached..
  //! 6.27.23  reset the _base65Images too..
  // but let's do it by only deleting those empty..
  //! https://stackoverflow.com/questions/5767325/how-can-i-remove-a-specific-item-from-an-array-in-javascript
  //! use splice
  //!  You can simplify this solution by counting down instead of up:
  for (var i =_base64Images.length - 1; i >= 0; i--)
  {
     // smflow is a JSON object {name, ...}
     let object = _base64Images[i];
     let SM = object.SM;
     let img = object.img;

     if (!img)
     {
        console.log("Removing element:" + i + " SM=" + SM);
        _base64Images.splice(i,1);
     }
  }



  //alert
  alert("Collecting SMART Deck Tree starting at: " + uuid + "." + flowNum
   + "\n\nWait for the number below to go to 0 \nbefore clicking 'Show SMART Cone Tree'"
	+ "\nIf 0 never shows up try to 'Collect' again, or contact support");

    //DARN.. the _requestedSMs is the tree .. so if we don't clean it out .. then the result is not changed.. but appended.. 
	 //TODO.. add a _cachedSMs[] which are the results of the _requestedSMs[] .. unless the cache is out of date .. 
   if (false)
   {
     // check if should clean out the requests..
     var allFinished = allRequestedSMsFinished()
     //if (_requestedSMs.length > 0)
     if (!allFinished)
     {
       if (confirm("Sometimes, web calls fail.\nOK -  clean out the web requests? \nCancel - keep waiting for a request"))
       {
          //reset the array
          _requestedSMs = [];
   
   		 //update the count too
          changeWaitingCount();
        }
     }
   }
   else
   {
          _requestedSMs = [];
   
   		 //update the count too
          changeWaitingCount();
   }
  
  // now recursively traverse starting with this uuid and flowNum
  traverseSMARTDeckFlow(uuid, flowNum, 0, "START");
}

// the resulting cone tree, in order
//    {"SM":thisSM, "smflow":[], "depth": depth, "parentSM":parentSM};
var _coneTree = [];

//! recurse..
/*
call: findChildren(0, "START")

printChildren(depth, parent)
   foreach i at results
      node = results[i]
	   if (node.depth == depth &&
		   node.parent == parent)
			   print(node)
            printChildren(depth+1, node)
		endif
	end
*/

// (1) returns a TEXT of the tree
// (2) creates a _coneTree array with the same order
//    {"SM":thisSM, "smflow":[], "depth": depth, "parentSM":parentSM};
//    
function createConeTreeHTML(depth, parentSM)
{

  //! base case..
  let result = "\n<br>";
  for (let i=0; i< _requestedSMs.length; i++)
  {
    let request = _requestedSMs[i];
    let SM = request.SM;

	 //! at depth requested (the next one down)
	 if (depth == request.depth 
	    && parentSM.localeCompare(request.parentSM)==0)
	 {

		 let uuid = getUUIDFromSM(SM);
		 let flowNum = getFlowNumFromSM(SM);
       let flow = flowOfFlowNum(uuid, flowNum);
    
		 //! get the flowName, but it might be null since
		 //! async call (if not cached) Call back later..
	    let flowName = flow.name; // flowName (but name in JSON0
		 let desc = flow.desc;

		 //! get the markup
		 let markup = flow.markup;
		 let QRAvatarURL = flow.QRAvatarURL;
		 let webAddress = _semanticMarkerFlowURL  + "smart?uuid=" + uuid + "&flow=" + flowNum;

		 result += "<br><h3 id='" + SM + "'>";
		 // print the node (just SM for now)
       for (var x=0; x< depth; x++)
       {
          result += "....";
       }
		 if (flowName)
		    result += flowName;
       result += " (" + SM + ")\n";


		 result += "</h3>\n";
       result += "Links: <a href='#_tableOfContents'>" + "Home" + "</a>\n" ;
       result += "<br><a href='" + webAddress + "'>" + "(Invoke SMART Button - or touch Semantic Marker)" + "</a><br>\n" ;
		 result += "<p>" + desc + "</p><br>\n";

		 //!grab the SM  .. this is from the /getSM web call and is in base64 already
		 for (let z=0;z<_base64Images.length;z++)
		 {

			 let object = _base64Images[z];
		    if (SM.localeCompare(object.SM)==0)
			 {
			    let imageHtml = object.img;
				 //result += "<br>" + imageHtml + "<br>\n";
             result += "<br><a href='" + webAddress + "'>" + imageHtml + "</a><br>\n" ;
			 }

		 }

		 //! draw the QRAvatar
		 result += "<img width='200' src='" + QRAvatarURL + "'</a><br>\n";
		 result += "<br>\n";

		 //! draw the markup
		 //result += markup?markup:"";
		 // if the @(SMARTDeck) is there .. then set this flag
		 let markupHasSMARTDeck = false;
		 if (markup)
		 {
			 // set the flag..
		    markupHasSMARTDeck = markup.includes("@(SMARTDeck)");
			 // finish the markup by replacing links..
		    let finalMarkup = replaceSMLinks(markup, flow, true);
			 result += finalMarkup;
		 }
		 result += "<br>\n";

       // WE can automatically show this .. or for now only if @(SMARTDeck) isn't included, so a web page can be pure
       if (!markupHasSMARTDeck)
       {
    		   //! #### The table for the other avatars
   	      // 4.30.23 show the deckSM links in a pulldown
   	      // let it know what the parent starting this..
            let deckSMLinks = getSMDeckLinksArray(flow.deckSM);
    		   let htmlTable = "<br><b>SMART Deck</b><table>";

         	// use the deckSMLinks array created above .. where the avatarURL is set
         	for (let i=0; i< deckSMLinks.length; i++)
         	{
         	   let object = deckSMLinks[i];
         		let thisSM = object.SM;
         		let flowName = object.flowName;
         		let avatarURL = object.avatarURL;
         	   htmlTable += "<td>" + flowName + "<br><a href='#" + thisSM + "'><img width='100' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + thisSM + "\")'></a></td>\n";
         	}
         
         	// 5.6.23 if the inherited .. tack the button at the end
            let inheritedSM = flowInheritedSMOfSM(SM);
         	if (inheritedSM && inheritedSM.length > 0)
         	{
         	  // tack on inherited at the end..
         	  let flowName = flowNameOfSM(inheritedSM);
         	  let avatarURL = avatarURLOfSM(inheritedSM);

						// grabs the image .. which should already be retrieved
						// this will be base64 image .. with lots of text..
						let semanticMarkerImageHTML = getBase64Image(inheritedSM);
						if (semanticMarkerImageHTML)
						{

						   // the href=#SM is a link inside this document

            	      htmlTable += "<td><table border='2' cellpadding='4' ><tr style='vertical-align:top'><td bgcolor='grey'>Inherited:: " + flowName 
							+ "<br><a href='#" + inheritedSM + "'>" +  semanticMarkerImageHTML + "</a>\n"
            		   + "<br><img width='200' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + inheritedSM + "\")'></a></td>\n";

						}
						else
						{
         	   htmlTable += "<td><table border='2' cellpadding='4' ><tr><td bgcolor='grey'>0.Inherited:: " + flowName 
         		   + "<br><a href='#" + inheritedSM + "'><img width='100' src='" + avatarURL + "' onClick='showSMLinkSM(\"" + inheritedSM + "\")'></a></td>\n";
						}
         	}
         
         
         	htmlTable += "</tr>\n</table><br>\n";
   
   			result += htmlTable;
      		//!NOTE: if the inherited isn't in the table of contents .. then grab it??
       }
 		 //! #### The table for the other avatars

		 //eventually the full USER manual can get generated..
       //! the request is only the the table of contents later..
		 _coneTree.push(request);

		 //now recurse
		 result += createConeTreeHTML(depth+1, SM);
    }
  }
  return result;
}

/*
SMART Deck Cone Tree
QHmwUurxC3.1682633601348 (p=START)
....QHmwUurxC3.100 (p=QHmwUurxC3.1682633601348)
....QHmwUurxC3.1675634815884 (p=QHmwUurxC3.1682633601348)
....QHmwUurxC3.1674080763255 (p=QHmwUurxC3.1682633601348)
........QHmwUurxC3.120 (p=QHmwUurxC3.100)
........QHmwUurxC3.1674080763255 (p=QHmwUurxC3.100)
........QHmwUurxC3.1674080468387 (p=QHmwUurxC3.100)

Requests are IN ORDER (at the same depth)
Replies are in async order
   
SHOULD BE:
0 QHmwUurxC3.1682633601348 (p=START)
1 ....QHmwUurxC3.100 (p=QHmwUurxC3.1682633601348)
2 .......QHmwUurxC3.120 (p=QHmwUurxC3.100)
2 .......QHmwUurxC3.1674080763255 (p=QHmwUurxC3.100) (REPEAT)
2 .......QHmwUurxC3.1674080468387 (p=QHmwUurxC3.100)
1 ....QHmwUurxC3.1675634815884 (p=QHmwUurxC3.1682633601348)
1 ....QHmwUurxC3.1674080763255 (p=QHmwUurxC3.1682633601348)

so at same depth, serach for all depth+1
   and pull under self..
*/

//!show the full deck "Show SMART Cone Tree"
function showFullSMARTDeckTreeHTML()
{
   if (!_userFlowsJSON)
	{
      alert("Please click 'Get User SM Flows' to initialize your SMART Buttons");
	   return;
	}
   if (_requestedSMs.length == 0)
	{
      alert("Please click 'Collect Full SMART Deck Tree' to initialize your SMART Cone Tree");
	   return;
	}

   if (!allRequestedSMsFinished())
	   return;


	//! try to fix the about:blank ???
	//! https://www.freecodecamp.org/news/about-blank-what-does-about-blank-mean-and-why-is-it-blocked-in-chrome-and-firefox/
	//! https://stackoverflow.com/questions/1197575/can-scripts-be-inserted-with-innerhtml

  // empty
  _coneTree = [];
  //!see https://stackoverflow.com/questions/1664049/can-i-force-a-page-break-in-html-printing
   let header = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\"" +
        "\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">" +
        "<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n";
  var resultConeTree = header + "<title>SMART Cone Tree</title>\n";
  resultConeTree += "<" + "head><" + "style>@media print{h3 {page-break-before:always}}<" + "/style><" + "/head>\n";
  //try to add some script:
  resultConeTree += "<" + "script>function playEnded(num) { alert('PlayEnded'); } <" + "/script>\n";
  resultConeTree += "<h1>SMART <a href='https://davis.wpi.edu/~matt/courses/trees/'>Cone Tree</a> - generated by Semantic Marker&trade;</h1>\n";

  //!TODO::  this <script> is not getting executed... playEnded() not found..
  //NOTE: the keywords script if shows with <> will break the javascript parser.. I think and think  it's for this code, not the 
  // generated code...

  //! now recurse
  let coneTree = createConeTreeHTML(0,"START");

  // id so others can get back..
  resultConeTree += "<h2 id='_tableOfContents'>Table of Contents</h2>\n";
  //! draw a table of contents..
  for (let i=0; i< _coneTree.length; i++)
  {
		let object = _coneTree[i];
		let name = object.smflow.name;
		let SM = object.SM;
		let depth = object.depth;
		// href links
		for (let x=0;x < depth; x++)
		{
		   resultConeTree += ".....";
		}
      resultConeTree += "<a href='#" + SM + "'>" + name + "</a><br>\n" ;
  }
  resultConeTree += "<br>\n";

  // append the cone tree
  resultConeTree += coneTree;

	  
	  //!TODO:
	  //  create a set of Semantic Markers with some text .. which is
	  // mini manual..

  console.log(resultConeTree);

//  return resultConeTree;
  // now print into an HTML window
  printDiv(resultConeTree);

}

//TODO...
//! traverses the _requestedSMs to see if any 'smflow' still []
function allRequestedSMsFinished()
{
  var allFinished = true;
  //TODO.. collect ths list and show to the user in 1 message
  for (var i =0; i< _requestedSMs.length; i++)
  {
	  // smflow is a JSON object {name, ...}
     let smflow = _requestedSMs[i].smflow;
     let SM = _requestedSMs[i].SM;
	  console.log("request " + SM + "(flow= " + smflow?smflow.name:"*still requested*" + ")");
	  if (!smflow || smflow.length == 0)
	  {
		  alert("Still waiting requestedSM to finish: " + SM);
		  allFinished = false;
		  // exit on first empty..
		  break;
	  }
  }
  for (var i =0; i< _base64Images.length; i++)
  {
	  // smflow is a JSON object {name, ...}
     let object = _base64Images[i];
     let SM = object.SM;
	  let img = object.img;
	  if (!img)
	  {
		  alert("Still waiting SM image to finish: " + SM);
		  allFinished = false;
		  // exit on first empty..
		  break;
	  }
  }
  return allFinished;
}

//!images: https://www.web3.lu/image-manipulations-with-javascript/

//!get just the uuid from the SM (uuid.flownum)
//! return NULL if nothing (wrong syntax)
function getUUIDFromSM(SM)
{
  SM = stripSpaces(SM);
  let SMparts = SM.split(".");
  if (SMparts.length == 2)
  {
    let uuid = SMparts[0];
	 return uuid;
	}
	return null;
}

//!get just the flownum from the SM (uuid.flownum)
//! return NULL if nothing (wrong syntax)
function getFlowNumFromSM(SM)
{
  SM = stripSpaces(SM);
  let SMparts = SM.split(".");
  if (SMparts.length == 2)
  {
    let flowNum = SMparts[1];
	 return flowNum;
	}
	return null;
}

//! add if the SM's UUID isn't there..
//! But the flow will be a singleton.. [flow]
function addToCachedFlow(SM, flowJSON)
{
  // get the uuid
  var uuid = getUUIDFromSM(SM);
  var flowNum = getFlowNumFromSM(SM);

  // look in _cachedFlowsJSON .. if not there then add this single flow
  // if there .. see if flowNum is there .. add to flows
  // 5.1.23
  // push this object, or update the one there..
  var object = {"uuid":uuid,"flows":[flowJSON]};
  var found = false;
  for (let i=0; i< _cachedFlowsJSON.length;i++)
  {
     if (uuid == _cachedFlowsJSON[i].uuid)
	  {
			// look for this flowNum in potentially sparse flows array
			let flowsJSON = _cachedFlowsJSON[i].flows;
			for (let x=0; x < flowsJSON.length; x++)
			{
			   //now look in the flows to see if same flownum
				if (flowsJSON[x].flowNum == flowNum)
				{
				   found = true;
					break;
				}
			}
         // adding a new flowJSON to existing cachedFlowJSON object
         if (!found)
         {
            console.log("pushing cashedFlow(1): " + object.uuid + "." + flowNum);
            _cachedFlowsJSON[i].flows.push(flowJSON);
         }
		}
	}
	if (!found)
	{
      
       console.log("pushing cashedFlow(2): " + object.uuid + "." + flowNum);
		 _cachedFlowsJSON.push(object);
	}
}

//! 5.22.23 try incrementing and decrement the waiting count
function changeWaitingCount()
{
  var count = 0;
  for (var i =0; i< _requestedSMs.length; i++)
  {
	  // smflow is a JSON object {name, ...}
     let smflow = _requestedSMs[i].smflow;
	  if (!smflow || smflow.length == 0)
	  {
	     count++;
	  }
  }
  for (var i =0; i< _base64Images.length; i++)
  {
	  // smflow is a JSON object {name, ...}
     let object = _base64Images[i];
     let SM = object.SM;
	  let img = object.img;
	  if (!img)
	  {
	     count++;
	  }
  }

   console.log("changingWaitingCount: " + count);
   var object = document.getElementById('_waitingCount');
   object.value = count;
   object.style = (count > 0)? "color:red;":"color:green;";
}

//! 4.27.23 start traversing a SMART Deck 
//! 4.29.23 depth is how deep..
//! Recursive 5.7.23 .. add placeholder for Markup
function traverseSMARTDeckFlow(uuid, flowNum, depth, parentSM)
{
  console.log("traverseSMARTDeckFlow(" + uuid + "." + flowNum + " depth=" + depth + " parentSM=" + parentSM + ")");

  let thisSM = createSM(uuid, flowNum);

  // no flow yet..
  let object = {"SM":thisSM, "smflow":[], "depth": depth, "parentSM":parentSM};

  // check if already requested.. if so, then don't request again, but fill it in..
  for (var i =0; i< _requestedSMs.length; i++)
  {
	   let SM = _requestedSMs[i].SM;
	   let smflow = _requestedSMs[i].smflow;
		//console.log("Checking thisSM=" + thisSM + " - against '" + SM + " = " + thisSM.localeCompare(SM));
		if (thisSM.localeCompare(SM) == 0)
		{
			// push .. but reuse the smflow (versus GET web call)
         // NOTE: the requested smflow might still be empty..
			object.smflow = smflow;

			//pushing .. but not requesting again. THis way we see the tree..
         console.log("pushing1 (already requested): " + thisSM  + " depth=" + depth  + " smflow=" + smflow?smflow.name:"still-empty");
         _requestedSMs.push(object);

			// already visited
			return;
		}
	}
   console.log("pushing2 (new request): " + thisSM  + " depth=" + depth  + " smflow=" + object.smflow.length);
   _requestedSMs.push(object);


	//! 5.9.23
	//!new: call the getSM which fills _base64Images JSON array
  requestBase64Image(uuid, flowNum)

  // the address to retrieve. use format=json to get it as well
  let command = _semanticMarkerFlowURL + "smart"
	    + "?uuid=" + uuid + "&flow=" + flowNum  + "&format=json";

  // NOW make an async call .. so the replies are at different times
  // Store the results in the _requestedSMs array
  let xhttp = new XMLHttpRequest();

  // try changing the waiting count..
  changeWaitingCount(); 

  // format=json so this will be json..
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
		//!result is the SM FLOW flows.. [{flow},{flow}]
		let jsonReply = this.responseText;

		//check for error..
		if (jsonReply.indexOf("error") >= 0)
		{
			console.log("ERROR: "+ jsonReply);
         alert("Error retrieving: "+ uuid + "." + flowNum + "\n" + jsonReply);
			return;
		}

		// parse the result look for uuid/flownum and deckSM (the tree)
      let flowJSON = JSON.parse(jsonReply);
		let retrievedSM = createSM(flowJSON.uuid, flowJSON.flowNum);

     // look for the placeholder .. then fill it with the flowJSON
	  for (let i=0; i<_requestedSMs.length; i++)
	  {
		  let SM = _requestedSMs[i].SM;
	     if (SM.localeCompare(retrievedSM)==0)
		  {
			 // potentially add to the cached flows
		    addToCachedFlow(SM, flowJSON);

			 console.log("pushing3: updating instance: " + SM + " smflow : " + flowJSON.name);
		    // update this instance, but only the JSOn smflow {smflow}
			 // flowJSON == fill JSON object {.. name, ...}
			 _requestedSMs[i].smflow = flowJSON;
		  }

	  }

      // try changing the waiting count..
      changeWaitingCount(); 

		// now look for the deckSMs which are the reference to related in this SMART deck 
		// This creates the TREE/GRAPH of the SMART Deck
		let deckSMs = flowJSON.deckSM;
		if (deckSMs && deckSMs.length>0)
		{
		  // now parse the deckSMs, comma seperated
		  deckSMs = stripSpaces(deckSMs);

		  //should be list of UUID.flownum, UUID.flownum
		  let deckSMAddresses = deckSMs.split(",");

		  if (deckSMAddresses && deckSMAddresses.length>0)
		  {
			  // the result if itself if no ','
		     for (let i=0; i< deckSMAddresses.length; i++)
			  {
				  let thisDeckSM = deckSMAddresses[i];
              let deckSMuuid = getUUIDFromSM(thisDeckSM);
              let deckSMflowNum = getFlowNumFromSM(thisDeckSM);

			       // now recurse.. and increment the depth
              traverseSMARTDeckFlow(deckSMuuid, deckSMflowNum, depth+1, thisSM);

					//note the return will be fast, but it's from the async return
			  }
		  }
		}
    }
  };

  // async..
  //get the command, smart?uuid=x&flow=y
  xhttp.open("GET",command, true);
  xhttp.send();

}

//! 5.29.23 Memorial Day, after 2 teams of Draft Horses in Yellow Field Plowing (Sod Busting)

function failed(e) {
   // video playback failed - show a message saying why
   switch (e.target.error.code) {
     case e.target.error.MEDIA_ERR_ABORTED:
       alert('You aborted the video playback.');
       break;
     case e.target.error.MEDIA_ERR_NETWORK:
       alert('A network error caused the video download to fail part-way.');
       break;
     case e.target.error.MEDIA_ERR_DECODE:
       alert('The video playback was aborted due to a corruption problem or because the video used features your browser did not support.');
       break;
     case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
       alert('The video could not be loaded, either because the server or network failed or because the format is not supported.');
       break;
     default:
       alert('An unknown error occurred.');
       break;
   }
}

//!NOTE: Tricky for the generated cone tree which is HTML .. but doesn't have any
//! of this javascript (such as playEnded).   Can it be added?

// json:  {name, url}
var _musicListURL = [];

// num is the player that finished
function playEnded(num)
{
	//num is player that finished..
	num++;
	if (num >= _musicListURL.length)
	{
      alert("**** Finished Playing Playlist ****");
	}
	else
	{
      var playerName = "_audio_" + num;
      var player = document.getElementById(playerName);
		player.play();
   }
}

//! creates the music player
//! add an edded event: https://stackoverflow.com/questions/5092266/is-there-an-oncomplete-event-for-html5-audio
//! https://html.spec.whatwg.org/#media-resource
//! fire events: https://developer.mozilla.org/en-US/docs/Web/Events/Creating_and_triggering_events
//! https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener
//! https://www.w3schools.com/tags/ref_eventattributes.asp
function createMusicPlayer(musicListURLArray)
{

	var htmlString = "";

	for (var i=0; i< musicListURLArray.length; i++)
	{
		var last = (i+1 == musicListURLArray.length);
	   var videoSMJSON = musicListURLArray[i];
		var name = videoSMJSON.name;
		var url = videoSMJSON.url;
		var videoSM = url;
      var mediaName = "audio";
      var mediaType = "audio/mpeg";
		var audioName = "_audio_" + i;

      //htmlString += "<h2>SemanticMarker.org &trade; " + name  + "</h2>\n";
      
      htmlString += "<" + mediaName + " id='" + audioName 
		   + "' width='480' height='320' controls" 
			+ " onended='playEnded(" + i + ")'"
			+ " onerror='failed(event)'>\n";
      htmlString += "<source src='" + videoSM + "' type='" + mediaType + "'>\n";
      
      htmlString += "Sorry, your broswer doesn't support this " + mediaName + ", try this <a href='" + videoSM + "'>link</a>\n";
      htmlString += "</" + mediaName + ">  " + name + "\n";
      htmlString += "<br>";
	}

   return  htmlString;
}

//! creates a slideshow
function createSlideshow(slideshowListURLArray)
{

	var htmlString = "";

	for (var i=0; i< slideshowListURLArray.length; i++)
	{
		var last = (i+1 == slideshowListURLArray.length);
	   var videoSMJSON = slideshowListURLArray[i];
		var name = videoSMJSON.name;
		var url = videoSMJSON.url;

      htmlString += "<img width=50% src='" + url  + "'><br>" + name + "\n";
      
      htmlString += "<br>";
	}

   return  htmlString;
}

var _slideshowListURL = [];

//!parse the field with the playlist..
//! 5.30.23 using artifactsSM for now.
//! return HTML 
function processSlideshow(artifactSM)
{
	// empty
   _slideshowListURL = [];

	var slideshowListURLArray = processToken(artifactSM, "@slideshow");
   var htmlString = createSlideshow(slideshowListURLArray);

	//store globally since the 'next' uses the list..
	_slideshowListURL = slideshowListURLArray;

	return htmlString;
}

//!parse the field with the playlist..
//! 5.29.23 using artifactsSM for now.
//! return HTML 
function processPlaylist(artifactSM)
{
	// empty
   _musicListURL = [];

	var musicListURLArray = processToken(artifactSM, "@playlist");
   var htmlString = createMusicPlayer(musicListURLArray);

	//store globally since the 'next' uses the list..
	_musicListURL = musicListURLArray;

	return htmlString;

}

//!parse the field with the @slideshow(), @playlist() .. as many as desired.
//! 5.30.23 using artifactsSM for now.
//! the resultURL array is the return value
//! token == @playlist or @slideshow
function processToken(artifactSM, token)
{
	var resultURLArray = [];
	// empty
	// -1 if not found
   while (artifactSM.indexOf(token) >= 0)
	{
	  var startToken = artifactSM.indexOf(token);
	  // move pointer
	  artifactSM = artifactSM.substring(startToken);

	  // good to go.. parse this
	  //currently  @playlist("SONG",url,"SONG",url..)
	  //currently  @playlist("title",url,"title",url..)
	  var parenIndex = artifactSM.indexOf("(");
	  parenIndex++;
	  var lastParenIndex = artifactSM.indexOf(")");
	  // start up to the end (but not including the end)
	  var playlistString = artifactSM.substring(parenIndex,lastParenIndex);
	  let playlists = playlistString.split(",");

     //NOTE: Check to be sure the callers' variable for artifactSM isn't modified...
	  //set up the artifactsSM for use again in case there are more @playlist() 
	  // eat up the ')'
	  artifactSM = artifactSM.substring(lastParenIndex+1);

	  if (playlists.length % 2 > 0)
	  {
	     // bad format.. try more..
		  continue;
	  }
	  for (var i=0; i< playlists.length;i=i+2)
	  {

          var name = playlists[i];
			 var URL =  playlists[i+1];
	       //songName.replace(/\"/g, "")

			 var object = {"name":name,"url":URL}; 
          resultURLArray.push(object);
     }
	}
	return resultURLArray;
}

//!! START COOKIE
//! https://www.w3schools.com/js/tryit.asp?filename=tryjs_cookie_username
//! https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie
//! https://www.tutorialspoint.com/javascript/javascript_cookies.htm
//! https://stackoverflow.com/questions/16842226/setting-multiple-cookies-in-javascript
/*
It's counter-intuitive, but setting document.cookie does not overwrite already set cookies, except the one cookie with the same name, if it exists. And the way to remove a cookie, is to set its expiry date to the past. I recommend experimenting in the developer tools of your browser!
*/

//!   This will be name=value
//!   For preferences, this will be 

//! writeCookie appends to document,cookie
function writeCookie(name, value)
{
	  //! add expiration
	  var now = new Date();
     now.setMonth( now.getMonth() + 3 );

	  var cookie = name + "=" + encodeURIComponent(value);
     cookie += ";expires=" + now.toUTCString() + ";"

	  console.log("writeCookie: " + cookie);

     document.cookie = cookie;
     //document.cookie = "expires=" + now.toUTCString() + ";"
}

// {"name":name, "value":value}
var _cookieValues = [];

//! reads the cookies, will set the documentID if valid (Note this is called 2 times on startup..)
function readCookies()
{
    var allcookies = document.cookie;

    // Get all the cookies pairs in an array
    cookiearray = allcookies.split(';');

    // Now take key value pair out of this array
    for (var i=0; i<cookiearray.length; i++)
	 {
		   console.log("readCookie: " + cookiearray[i]);
         name = cookiearray[i].split('=')[0];
		   name = name.trim();
         value = decodeURIComponent(cookiearray[i].split('=')[1]);

		   var object = {"name":name,"value":value};
		   _cookieValues.push(object);

		  if (name.localeCompare("_username")==0)
		  {
	        var val = object.value;
			  _username = val;
		  }

		  else if (name.localeCompare("_password")==0)
		  {
	        var val = object.value;
			  _password = val;;
		  }
		  else
		  {
		    // the hidden cookies 

         let isHidden = value;
	   	if (isHidden.localeCompare("true")==0)
			 {
		       // start with 1 cookie "SMARTButton = true/false)
		       if (name.localeCompare("_SMRecordDevice")==0)
		       {
                hideShowMarkup(['_SMRecordDevice','_m88.1','_m88.2','_m88.3','_m88.4','_m88.5','_m88.6','_markupTextID','markupText']);
				 }
		       // start with 1 cookie "SMARTButton = true/false)
		       else if (name.localeCompare("_m5Commands")==0)
		       {
                hideShowMarkup(['_m5Commands']);
				 }
				 //add:
				 else
				 {
          //      hideShowMarkup([name]);
				 }
			 }
			}

     }
}

//! writes the cookies
//! This reads the _parameters which are elementId's
function saveCookies()
{

	 var cookieNames = ['_SMRecordDevice','_m5Commands','_password','_username', '_GroupCommands'];

	 for (var i = 0; i < cookieNames.length; i++)
	 {
	    var cookieName = cookieNames[i];


		 // OR?? can the _username of the cookiename be used?
		 //var val = cookieNames[i];
	    // lets start with the SMART Button IoT set..
		  if (cookieNames[i].localeCompare("_username")==0)
		  {
	        var object = {"name":cookieName,"value":_username};
	        writeCookie(object.name, object.value);
		  }
		  else if (cookieNames[i].localeCompare("_password")==0)
		  {
	        var object = {"name":cookieName,"value":_password};
	        writeCookie(object.name, object.value);
		  }
		  else
		  {
		    //hidden fields
	        // lets start with the SMART Button IoT set..
           var isHidden = document.getElementById(cookieName).hidden;
    
	         var object = {"name":cookieName,"value":isHidden};
				console.log("saveCookie: " + JSON.stringify(object));
	         writeCookie(object.name, object.value);
		  }

	 }
	 // THis will take the _username and _password and save them..
    setSemanticMarkerUserPasswordValues();
}


//!! END COOKIE



//! 6.12.23 reload by calling lookupuser with our known user-name and password
function reloadUserAgent()
{

   // _rootBotURL = "https://iDogWatch.com/bot";

  // the address to retrieve. use format=json to get it as well
  let command = _rootBotURL + "/lookupuser/"
	    +  _username + "/" + _password;

  console.log("reloadUserAgent: " + command);

  // NOW make an async call .. so the replies are at different times
  // Store the results in the _requestedSMs array
  let xhttp = new XMLHttpRequest();

  // format=json so this will be json..
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
		//!result is the SM FLOW flows.. [{flow},{flow}]
		let jsonReply = this.responseText;

		//check for error..
		var errors = ["error","Invalid","Wrong password"];
		for (let i =0; i< errors.length;i++)
		{
		   if (jsonReply.indexOf(errors[i]) >= 0)
		   {
			   console.log("ERROR: "+ jsonReply);
            if (confirm("Error retrieving: " + _username + "\n\nTry again?"))
				{
					logout();
				}
				else
				{
					_username = "";
				   initWebPage();
	            document.getElementById("_Login").hidden = false;
				}
			   return;
			}
		}

		console.log("REPLY = " + jsonReply);
		 
		// parse into JSON
      var userJSON = JSON.parse(jsonReply);

		//set the guest password 
		_word = userJSON.guestPassword;

		// set the global for the devices right now
		_devicesJSON = userJSON.devices;

		// it's the devices that can change..
		// Update the Options of devices and devicesToPair
      createDeviceListOptions('devices');
      createDeviceListOptions('devicesToPair');

// NEW .. add to smart.html version *********
		//! NEW: 
		_groupsJSON = userJSON.groups;

		if (!_groupsJSON)
		   _groupsJSON = {"groups":[]};

      createGroupsListOptions("_groups");
   
      createGroupDeviceListOptions("_groups", "_groupDevices");

// **** THIS IS A PLACE TO update when ther..
if (!_useOldSMARTDeck)
{
      getSMSmartDecks(null);
}
else
{
		// grab smartDecks
		_smartDecks = userJSON.smartDecks;

		//! 10.3.23 can be NULL or undefined
		if (!_smartDecks)
		{
		   alert("First Time UUID Creation. No SMART Decks yet.");
		   _smartDecks = [];
		}

		var uuid = userJSON.uuid;

	   // update the deck options  (Call from getSMUserUUID...
      parseSmartDecks(uuid);
}

    }
  };

  // async..
  xhttp.open("GET",command, true);
  xhttp.send();
}

//!https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript`
function getParameterByName(name, url = window.location.href) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

//!check query parms for username password
//!https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript`
// support:  ?username=NAME&password=P
function checkQueryParms()
{
   var username = getParameterByName('username'); // "lorem"
   var password = getParameterByName('password'); // "" (present with empty value)
   var guestpassword = getParameterByName('guestpassword'); // "" (present with empty value)
	if (username)
	{
	   _username = username;
	   _password = password;
		_word = guestpassword;
      saveCookies();
	}
}

/* **************************** GROUPS ************************ */
// the groups JSON that will be retrieved from the agents "group" field
var _groupsJSON = 

    [{"group":"atlasDogs",
         "devices":[{ "dev":"ScoobyDoo","display":"Scott.ScoobyDoo", "color":"green"} ,
                     { "dev":"PumpkinUno",    "display": "Scott.PumpkinUno",  "color":"orange"},
                     { "dev":"Wilma",    "display": "Kristina.Wilma",  "color":"red"}
                    ] },
      {"group":"houndDogs", "devices": [] }
    ];

//!create the list of devices.. Fill in the idDeviceListOptions (which has the select already formed)
function createGroupsListOptions(idGroupListOptions)
{

  var htmlSelect = "";
  htmlSelect += "<option value='NO_GROUP'>NO_GROUP</option>";
  htmlSelect += "\n";

  // used for sorting later..
  var groupNames = [];

  var groupsArray = _groupsJSON;
  console.log(groupsArray);

  // go through list, but dont include GENERIC and DEFAULT
  for (var i =0; i< groupsArray.length; i++)
  {
		  // key = group name

			  var groupJSON = groupsArray[i];
		     var groupName = groupJSON.group;

		     // how to get the name
		     //Not sorting yet..
          //if ("_GENERIC_".localeCompare(deviceName)!=0 && "_DEFAULT_".localeCompare(deviceName) != 0)
           {
			    groupNames.push(groupName);
		     }
	}

	//now sort
	groupNames.sort();
   for (var i =0; i< groupNames.length; i++)
   {
     let deviceName = groupNames[i];

	  // create option for the deviceName
     htmlSelect += "<option value='" + deviceName + "'>" + deviceName + "</option>";
     htmlSelect += "\n";
   }

  document.getElementById(idGroupListOptions).innerHTML = htmlSelect;
}

//!create the list of devices.. Fill in the idDeviceListOptions (which has the select already formed)
function createGroupDeviceListOptions(idGroupListOptions, idGroupDeviceListOptions)
{

  // The current selected group name
  // Only show devices from this group
  var selectedGroupName = document.getElementById(idGroupListOptions).value;

  var htmlSelect = "";
  htmlSelect += "<option value='--ALL--'>--ALL--</option>";
  htmlSelect += "\n";

  // used for sorting later..
  var groupDeviceNames = [];

  var groupsArray = _groupsJSON;
  console.log(groupsArray);

  // go through list, but dont include GENERIC and DEFAULT
  for (var i =0; i< groupsArray.length; i++)
  {
		  // key = group name

			  var groupJSON = groupsArray[i];
		     var groupName = groupJSON.group;
			  var devicesArray = groupJSON.devices;

			  if (groupName != selectedGroupName)
			     continue;

			  for (var k=0; k< devicesArray.length; k++)
			  {
			     var device = devicesArray[k];
				  //  dev, display, color
              //"devices":[{ "dev":"ScoobyDoo","display":"Scott.ScoobyDoo", "color":"green"} ,
				  var dev = device.dev;
				  var display = device.display;
				  var color = device.color;

	           // create option for the deviceName
              htmlSelect += "<option value='" + dev + "'>" + display + "</option>";
              htmlSelect += "\n";

			  }
	}

  document.getElementById(idGroupDeviceListOptions).innerHTML = htmlSelect;
}

//! wraps the command no args
function sendGroupMessage(idGroups, idGroupDevices, idCmd)
{
	// the command. NOTE: there are some that use the "send" syntax still 5.4.23
	var cmd = document.getElementById(idCmd).value;
	var group = document.getElementById(idGroups).value;
	var groupDevice = document.getElementById(idGroupDevices).value;

	// if group == "NO_GROUP" then do nothing..
	if (group == "NO_GROUP")
	{
      alert("Please specify a group to send message to");
		return;
	}

	var deviceSpecified = true;
	if (groupDevice == "--ALL--")
	{
	   deviceSpecified = false;
	}

   var command = _rootBotURL + "/";
	var userInfo = _username + "/" + _password;


	if (cmd == "status")
	   command += "statusgroup/" + userInfo + "/" + group;
	else if (cmd == "capture")
	   command += "capturegroup/" + userInfo + "/" + group;
	else if (cmd == "feed")
	{
      if (deviceSpecified)
	      command += "feeddevicegroup/" + userInfo + "/" + groupDevice + "/" + group;
		else
	      command += "feedgroup/" + userInfo + "/" + group;
	}

  console.log(command);

  // NOW make an async call .. so the replies are at different times
  sendGETCommand(command);
}

//! wraps the command no args
function sendAddNewUser(idUser, idUserPassword, idGuestPassword, idToken)
{
   sendURL("adduser", [idUser, idUserPassword, idGuestPassword, idToken]);
}

//! wraps changeuserpassword
function sendChangeYourPassword(idChangeYourPasswordUserName,idChangeYourPassword,idChangeYourNewPassword)
{
   sendURL("changeuserpassword", [idChangeYourPasswordUserName,idChangeYourPassword,idChangeYourNewPassword]);
}

//! aggregator of the send URL call
//! valueArray already have the values 
function sendURLValues( commandName, valueArray)
{
   
	// add user to group topic
   var command = _rootBotURL + "/" + commandName;

	// go through the idArray
	for (var i =0; i< valueArray.length;i++)
	{
      var parm = valueArray[i];

		command += "/" + parm;

	}
   console.log(command);

   if (confirm(command))
   {
     // NOW make an async call .. so the replies are at different times
      callGetCommandReload(command);
   }

}

//! aggregator of the send URL call
//! idArray is array of id's to document.getElementById()
function sendURL( commandName, idArray)
{

   var valArray = []
	// go through the idArray
	for (var i =0; i< idArray.length;i++)
	{
      var id = idArray[i];
	   var parm = stripSpaces(document.getElementById(id).value);
		valArray.push(parm);
	}
	sendURLValues(commandName, valArray);

}

//! wraps updateuser
function sendUpdateUser(idUpdateUserName, idUpdateUserPassword, idUpdateUserGuestPassword, idTokenUpdateUser)
{
   sendURL("updateuser", [idUpdateUserName, idUpdateUserPassword, idUpdateUserGuestPassword, idTokenUpdateUser]);
}

//! wraps changeguestpassword
function sendChangeGuestPassword(idChangeGuestPasswordUserName,idChangeGuestPassword,idChangeGuestPasswordGuestPassword)
{
   sendURL("changeguestpassword", [idChangeGuestPasswordUserName,idChangeGuestPassword,idChangeGuestPasswordGuestPassword]);
}

//! wraps the command no args
function sendAddUserToGroup(idGroups, idUser, idToken)
{
	// the command. NOTE: there are some that use the "send" syntax still 5.4.23
	var group = stripSpaces(document.getElementById(idGroups).value);

	// if group == "NO_GROUP" then do nothing..
	if (group == "NO_GROUP")
	{
      alert("Please specify a group to send message to");
		return;
	}

   sendURL("addusertogrouptopic", [idGroups, idUser, idToken]);
}


//! add new group to the agents JSON
function addNewGroup(idNewGroupName)
{
   var groupName = stripSpaces(document.getElementById(idNewGroupName).value);

	var values = [_username, _password, groupName];
	sendURLValues("addgroup",values);
}

//! remove group to the agents JSON
function removeGroup(idGroupName)
{
   var groupName = stripSpaces(document.getElementById(idGroupName).value);
	if (groupName == "NO_GROUP")
	{
	  alert("A Group name must be specified");
	  return;
	}

	var values = [_username, _password, groupName];
	sendURLValues("removegroup",values);

}
 
//! add new device to specified group to the agents JSON (if ALL then don't do it..)
function addNewGroupDevice(idGroups, idNewGroupDeviceName, idNewGroupDisplayDeviceName)
{
   var groupName = stripSpaces(document.getElementById(idGroups).value);
   var groupDeviceName = stripSpaces(document.getElementById(idNewGroupDeviceName).value);
   var groupDisplayDeviceName = stripSpaces(document.getElementById(idNewGroupDeviceName).value);
	var color = "unused";

	//note: this string compare works.. forget that localeCompare
	if (groupName == "NO_GROUP")
	{
	  alert("A Group name must be specified");
     return;
	}

	if (groupName.length == 0 || groupDeviceName.length == 0 || groupDisplayDeviceName.length ==0)
	{

	  alert("Group Device names cannot be empty");
	  return;
	}

   var values = [_username, _password, groupDeviceName, groupDisplayDeviceName, color, groupName];
	sendURLValues("adddevicetogroup", values);
}

//! 7.27.23 .. heading to hike Tolmie Peak on a nice day
function subscribeGroups(idDevices, idSubscribeGroupNames)
{
   // use the 'set' syntax
	// names can have command and #  (is # allowed on url??)
	var groupNames = stripSpaces(document.getElementById(idSubscribeGroupNames).value);

	// parse for valid "," etc..
	var groupNamesString = "";
	// same as C:  strchr(groupNames,'.') != NULL)
	const groupNamesArray = groupNames.split(',');
	for (var i=0;i<groupNamesArray.length;i++)
	{
	   if (i > 0)
	      groupNamesString += ", ";
		   
	   groupNamesString += groupNamesArray[i];
	}
	
	if (!confirm("Subscribing to groups: " + groupNamesString))
	{
	   return;
	}
   


   groupNames = groupNames.replace(/[#]/g, "%23");

	var anySetCommand = "groups";
	var anySetVal = groupNames;


   //!  set:cmd, val:arg
   //! THese use the values passed in for 2nd and 3rd parm
   sendAnySetCommand2(idDevices, anySetCommand, anySetVal)

}

//TODO.. get the RUN SemanticMarkers working...
//! make web get call
function callGetCommandReload(url)
{
   var xhttp = new XMLHttpRequest();

	//!https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/readystatechange_event
   xhttp.onreadystatechange = function() {
		// called when open is finished
      if (this.readyState == 4 && this.status == 200)
	   {
		    let jsonReply = this.responseText;
		    if (jsonReply)
			 {
			    if (jsonReply.indexOf("Wrong") >= 0
				 ||
			        jsonReply.indexOf("Invalid") >= 0
				 )
			    {
			       alert(jsonReply);
			    }
			 }
      }
		//reload the agent
      reloadUserAgent();
   };
   //! shows the command at this element
   document.getElementById('_messageId').innerHTML = url;

   xhttp.open("GET", url, true);
   xhttp.send();
}

/* **************************** END GROUPS ************************ */

// creates a help button, looking at all the HelpClass items
function createHelpButtons()
{

  var allHelpClassArray = document.getElementsByClassName("HelpClass");
  for (int i=0; i< allHelpClassArray.length; i++)
  {
      var helpObject = allHelpClassArray[i];

//TODO.. 
  }

}

//! load with the selectOptionId
//! NOTE: accessing 'device' scope tricky: 
//! https://www.javatpoint.com/javascript-onload
window.onload = function()
{

   checkQueryParms();

	//! 6.13.23 if not supplied then request user login
	//requestLoginWindow(true);
	// 9.5.23 change
	requestLoginWindow(false);

	//if valid .. then perform the rest of this initialization
   initWebPage();

//	createHelpButtons();

}

// the rest of the init code .. this can be called with empty values..
function initWebPage()
{
	// all that want to register
   initRegisteredDevices();

	// update the 2 places where devices are shown
   createDeviceListOptions('devices');
   createDeviceListOptions('devicesToPair');
   var htmlText = "User Page for <a href='https://idogwatch.com/bot/userpage/" + _username + "/" + _password + "'>" + _username + "</a>";
   htmlText += " ";
   //htmlText += "<a href='https://idogwatch.com/bot/userpage2/" + _username + "/" + _password + "'>" + " (NewPage) " + "</a>";
   htmlText += "<a href='https://idogwatch.com/userpage/userpage.html?username=" + _username + "&password=" + _password + "'>" + " (NewPage) " + "</a>";
   document.getElementById('userId').innerHTML = htmlText;

	// grab the UUID as well
   getSMUserUUID('_uuidStringText');

	// update the deck options  (Call from getSMUserUUID...
   //parseSmartDecks();

	 // cookies stores the state of the hidden..
	 // This deals with _SMRecordDevice  and the 
	 readCookies();

	 //start with hidden fields..
    hideShowMarkup(['m2.1','m3.1','m10.1','m1Note','m2Note']);

    // the OTA
    hideShowMarkup(['mOTA.1','_RevertToMainOTA','mOTA.2','_QAOTA','mOTA.3','_DevOTA']);
    hideShowMarkup(['_m99.1']);

    hideShowMarkup(['_UserAccounts']);

//    hideShowMarkup(['_GroupCommands']);

	 // The smart buttons
    //hideShowMarkup(['_SMRecordDevice','_m88.1','_m88.2','_m88.3','_m88.4','_m88.5','_m88.6','_markupTextID','markupText']);
}
</script>

<script src="https://SemanticMarker.org/SemanticMarker.js?v=1"></script>

<body>
<!-- HTML   BODY  -->
<h1 class="H1">SMART Clicker and Semantic Marker&#x2122; Messaging (EU&#xae;)</h1>
<img src="https://idogwatch.com/pettutor/iDogWatch.png"  width="200">
<img src="https://idogwatch.com/pettutor/PetTutor.jpeg" width="500">
<img src="https://SemanticMarker.org/SemanticMarker.png" width=200">
<br>
<h2 id="userId">user</h2>
<br>

<!--
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
  onClick="alert(' ')" />
   <span class="tooltiptext">
  
  </span>
</div>
-->

<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
  onClick="alert('Click on headers to expand or contract that section. Send messages to your devices. And create SMART Buttons.' )" />
   <span class="tooltiptext">
  Click on headers to expand or contract that section. Send messages to your devices. And create SMART Buttons.
  </span>
</div>

<input type="button" class="HELPButton" value="M5 Display Help" onClick="invokeURL('https://idogwatch.com/bot/help')" />
<input type="button" class="HELPButton" value="Logout" onClick="logout()" />
<input type="button" class="M5button" value="Login" id="_Login" hidden=1 name="_Login" onClick="login()" />
<p class="label"">Click on headers to expand or contract
<br>

<!----------------------------------------------------------------------->
<h2 class="H2" >1. Messages</h2>
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
  onClick="alert('Message sent to your agents over MQTT' )" />
   <span class="tooltiptext">
Message sent to your agents over MQTT
  </span>
</div>
<p class="label" id="_messageId">
Message..</p>
<br>


<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('List of your devices \nwhich the messages below use as addresses\n--ALL-- sends to all your devices\nOtherwise sent to specific name\nNO_ONE is good for message testing\n(No operations happen)')" />
   <span class="tooltiptext">
List of your devices which the messages below use as addresses--ALL-- sends to all your devices. Otherwise sent to specific name NO_ONE is good for message testing (No operations happen)
  </span>
</div>

<label class="label" for="devices">Device Name:</label>
<select name="devices"  id="devices" class="select btnB" onchange="devicesChanged('devices')">x</select>

<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Reloads device names')" />
<input type="button" class="button" id="buttonReload" value="Reload Agent" onClick="reloadUserAgent();" />

<!--
<select name="devices" id="devices">
  <option value="NO_ONE">NO_ONE</option>
  <option value="--ALL--">--ALL--</option>
  <option value="ScoobyDoo">ScoobyDoo</option>
  <option value="DukeGEN3">DukeGEN3</option>
  <option value="GreyGoose">GreyGoose</option>
  <option value="HowieFeeder">HowieFeeder</option>
  <option value="PumpkinUno">PumpkinUno</option>
  <option value="M55">M55</option>
</select>
-->

<!----------------------------------------------------------------------->
<h2 class="H2" id="_CommandsToYourDevice" name="_CommandsToYourDevice" onClick="hideShowMarkup(['m1.1','m2.1','m3.1'])">2. Commands to your Device</h2>
<p class="label" id="m1.1"> 
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('Send commands to your device(s)')" />
   <span class="tooltiptext">
Send commands to your device(s). Select the command using the pulldown.
  </span>
</div>
<input type="button" class="button" id="buttonNoArgs" value="Send Message" onClick="sendNoArgs('devices','commandNoArg')" />
<label class="label" for="commandNoArg">Command:</label>
<select class="select label" name="commandNoArg" id="commandNoArg">
  <option value="feed">feed</option>
  <option value="status">status</option>
  <option value="powerOff">poweroff</option>
  <option value="wifi">wifi</option>
  <option value="swapwifi">swapwifi</option>
  <option value="readspiff">readspiff</option>
  <option value="help">help</option>
  <option value="temp">temp</option>
  <option value="capture">capture</option>
  <option value="reboot">reboot</option>
</select>

</br>
</br>
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('Send commands as a guest to your device(s)')" />
   <span class="tooltiptext">
Send commands as a guest to your device(s). Select the command using the pulldown.
  </span>
</div>
<input type="button" class="button" id="buttonNoArgs" value="Send Message" onClick="sendNoArgsGuest('devices','commandNoArgGuest')" />
<label class="label" for="commandNoArgGuest">Command:</label>
<select class="select label" name="commandNoArgGuest" id="commandNoArgGuest">
  <option value="feedguest">Guest Feed</option>
</select>


<br>
<br>
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('Send commands to your device(s) using on/off flag')" />
   <span class="tooltiptext">
Send commands to your device(s) using on/off flag
  </span>
</div>
<input type="button" class="button" id="buttonBooleanArgs27" value="Send Message" onClick="sendBooleanArgs('devices','commandBoolean27','boolArgValue27')" />
<label class="label" for="commandBoolean">Command:</label>
<select class="select label"  name="commandBoolean27" id="commandBoolean27">
  <option value="tilt">Set Tilt</option>
  <option value="buzz">Set Buzzer</option>
  <option value="gateway">Set GEN3 Gateway</option>
  <option value="gen3only">Use Only GEN3 Device</option>
  <option value="bleclient">BLEclient</option>
  <option value="bleserver">BLEserver</option>
  <option value="bleusedevicename">BLE use devicename</option>
  <option value="bleusepaireddevicename">BLE use paired devicename</option>
  <option value="subdawgpack">Subscribe to Dawgpack topic</option>
  <option value="ble+wifi">Send WIFI with BLE feed</option>
  <option value="usegroups">Use GROUPS if a group member</option>
</select>

<label class="label" for="boolArgValue27">Flag:</label>
<select class="select label"  name="boolArgValue27" id="boolArgValue27">
  <option value="on">on</option>
  <option value="off">off</option>
</select>

<br>

<br>
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('Select type of feeder:\nUNO is 16\nTumbler is taller')" />
   <span class="tooltiptext">
Select type of feeder:UNO is 16, Tumbler is taller
  </span>
</div>
<input type="button" class="button" id="stringTextArgsCanister" value="Send Message" onClick="sendTextArgs('devices','argCanister','stringArgCanister')" />
<label class="label" for="commandBoolean">Command:</label>
<select class="select label"  name="argCanister" id="argCanister">
  <option value="stepper">Canister Type</option>
</select>
<select class="select label"  name="stringArgCanister" id="stringArgCanister">
  <option value="UNO">UNO</option>
  <option value="Tumbler">Tumbler</option>
</select>

<br>
<br>
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('Help Guiness World Record\nRecord your location \n(city, state, country, GPS if you want)')" />
   <span class="tooltiptext">
Help us set a Guiness World Record. Record your location (city, state, country, GPS if you want)
  </span>
</div>

<input type="button" class="button" id="stringTextArgs" value="Send Message" onClick="sendTextArgs('devices','stringArgCommand','stringArgText')" />
<label class="label" for="stringArgCommand">Command:</label>
<select class="select label"  name="stringArgCommand" id="stringArgCommand">
  <option value="location">Set Location in World (spaces allowed)</option>
  <option value="device">Name Your Device</option>
  <option value="pairdev">Pair with GEN3 or ESP Device</option>
</select>


<input class="text" name="stringArgText" id="stringArgText" length="64" type="text"/>


<!----------------------------------------------------------------------->

<h2 class="H2" id="_TimerCommands" name="_TimerCommands" onClick="hideShowMarkup(['m2.1','m3.1'])">2.2 Timer Commands to your device</h2>
<p class="label" id="m2.1"> 
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Select a timer to run on the device')" />
<input type="button" class="button" id="intBooleanArgsTimer" value="Send Message" onClick="sendTextArgs('devices','intArgCommandTimer','intArgTextTimer')" />
<label class="label" for="intArgCommandTimer">Timer Interval:</label>
<select class="select label"  name="intArgCommandTimer" id="intArgCommandTimer">
  <option value="timerdelay">Timer delay in seconds</option>
</select>

<input class="text" name="intArgTextTimer" id="intArgTextTimer" length="64" type="number" min=0 max=3000 value=0>
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Select turning on/off the timer')" />
<input type="button" class="button" id="buttonBooleanArgsTimer" value="Send Message" onClick="sendBooleanArgs('devices','commandBooleanTimer','boolArgValueTimer')" />
<label class="label" for="commandBooleanTimer">Timer Command:</label>
<select class="select label"  name="commandBooleanTimer" id="commandBooleanTimer">
  <option value="starttimer">Start Timer</option>
</select>

<label class="label" for="boolArgValueTimer">Value:</label>
<select class="select label"  name="boolArgValueTimer" id="boolArgValueTimer">
  <option value="on">on</option>
  <option value="off">off</option>
</select>


<!----------------------------------------------------------------------->


<h2 class="H2" id="_DeviceNamesManagedByBot" name="_DeviceNamesManagedByBot" onClick="hideShowMarkup(['m3.1'])">2.3 Device Names managed by your Agent (bot)</h2>
<p class="label" id="m3.1"> 
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Note: these are not sent to the devices,\njust to your agent bot.\nThe DeviceName pulldown will change on refresh.')" />

Note: these are not sent to the devices, just to your agent bot.  
The DeviceName pulldown will change on refresh.
<br>

<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Adds the device name you enter')" />
<input type="button" class="button" id="button_addDeviceNameBot" value="Add Device" onClick="addDeviceNameBot('addDeviceNameBot_string')" />
<label class="label">Add Device to your agent(bot)</label>
<input class="text" name="addDeviceNameBot_string" id="addDeviceNameBot_string" length="64" type="text"/>
<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Remove the device selected\nIn devices above')" />

<input type="button" class="button" id="button_removeDeviceNameBot" value="Remove Device" onClick="removeDeviceNameBot('devices')" />
<label class="label">Remove Device managed by your agent(bot), use above device names</label>
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Rename the device selected above\nTo the name you enter')" />
<input type="button" class="button" id="button_renameDeviceNameBot" value="Rename Device" onClick="renameDeviceNameBot('devices', 'renameDeviceNameBot_string')" />
<label class="label">Rename Device managed by your agent(bot), use above device names</label>
<input class="text" name="renameDeviceNameBot_string" id="renameDeviceNameBot_string" length="64" type="text"/>

<br>
<!----------------------------------------------------------------------->
<h2 class="H2" id="_manageActualDevice" name="_manageActualDevice" onClick="hideShowMarkup(['m1Note','m2Note'])" >2.4 Manage Actual Device</h2>
<p id="m1Note" class="label">
Note: these are messages sent directly to the devices in the above pulldown (without your agent(bot) knowing).
<p id="m2Note" class="label">There is a seperate step previously (just above) called "Device Names Managed by your agent" to inform your agent(bot).
<br>
<input type="button" class="HELPButton" id="m2HELPButton" value="?" onClick="alert('Rename the device you enter\n(if not in devices list)\nTo New Deivce you enter')" />
<input type="button" class="button" id="renameDeviceId" value="Rename Device" onClick="sendRenameDevice('currentDeviceName','newDeviceName')" />
<label class="label">Current Device Name (if not in above list):</label>
<input class="text" name="currentDeviceName" id="currentDeviceName" length="64" type="text">
<label class="label">New Device Name:</label>
<input class="text" name="newDeviceName" id="newDeviceName" length="64" type="text">
<br>
<br>
<input type="button" class="HELPButton" id="m3HELPButton" value="?" onClick="alert('Rename device in pulldown\nTo name entered')" />
<input type="button" class="button" id="renameDeviceId2" value="Rename Device" onClick="sendRenameDevice('devices','newDeviceName2')" />
<label class="label">Use Device Name Pulldown:</label>
<label class="label">New Device Name:</label>
<input class="text" name="newDeviceName2" id="newDeviceName2" length="64" type="text">

<br>
<br>
<input type="button" class="HELPButton" id="m4HELPButton" value="?" onClick="alert('Set any JSON to the value entered')" />
<input type="button" class="button" id="setCommand" value="setCommand" onClick="sendAnySetCommand('devices','anySetCommand','anySetVal')" />
<label class="label">Any Set Command:</label>
<input class="text" name="anySetCommand" id="anySetCommand" length="64" type="text">
<label class="label">Val: (spaces allowed, but nothing like "/")</label>
<input class="text" name="anySetVal" id="anySetVal" length="64" type="text">

<br>
<br>
<input type="button" class="HELPButton" id="m5HELPButton" value="?" onClick="alert('Set any JSON to any value including / ')" />
<input type="button" class="button" id="setCommand64" value="setCommand64" onClick="sendAnySetCommand64('devices','anySetCommand64','anySetVal64')" />
<label class="label">Any Set Command:</label>
<input class="text" name="anySetCommand64" id="anySetCommand64" length="64" type="text">
<label class="label">Val: (any URL allowed)</label>
<input class="text" name="anySetVal64" id="anySetVal64" length="64" type="text">
<br>

<!-- New QUERY Base64 name and argument-->
<br>
<input type="button" class="HELPButton" id="m6HELPButton" onClick="alert('Use wildcard to send the setCommand64 to those device. For example *M5* is all the M5 devices only')" value="?" />
<input type="button" class="button" id="stringTextArgsQuery" value="Device=Query" onClick="sendAnySetCommand64Both('stringArgTextQuery','anySetCommand64','anySetVal64',true)" />
<input class="text" name="stringArgTextQuery" id="stringArgTextQuery" length="64" type="text"/>

devices<br>
* inwork


<!--
<input type="button" class="HELPButton" id="m7HELPButton" value="?" onClick="alert('Let your agent know your SSID info')" />

<input type="button" class="button" id="addWifiId" value="Add WIFI Credentials" onClick="sendAddWIFITextArgs('devices','ssidArg','passwordArg')" />
<label class="label">WIFI SSID:</label>
<input class="text" name="ssidArg" id="ssidArg" length="64" type="text">
<label class="label">WIFI Password:</label>
<input class="text" name="passwordArg" id="passwordArg" length="64" type="text">
-->

<!------------ GROUPS ----------------------------------------------------------->
<h1 class="H1" id="_GroupCommandsTab" name="_GroupCommandsTab" onClick="hideShowMarkup(['_GroupCommands'])" >GROUP Messaging</h1>
<p class="label" id="_GroupCommands">
Manages sending messages to specific message groups, which allows for multiple different users accounts to share feed and status commands.
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('The Groups you and your devices are members of. And optionally a set of devices of yours and others in the group.')" />
<label class="label" for="_groups">Groups:</label>
<!-- see: https://stackoverflow.com/questions/647282/is-there-an-onselect-event-or-equivalent-for-html-select -->
<select name="_groups"  id="_groups" onfocus="this.selectedIndex = -1;"  class="select btnB" 
      onchange="createGroupDeviceListOptions('_groups', '_groupDevices');"
>x</select>

<label class="label" for="_groupDevices">Devices:</label>
<select name="_groupDevices"  id="_groupDevices" class="select btnB" >x</select>
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sends a message to the group, or an individual device in the group, potentially another users device')" />
<input type="button" class="button" id="_buttonCommandNoArgGroup" value="Send Group Message" onClick="sendGroupMessage('_groups','_groupDevices', '_commandNoArgGroup')" />
<label class="label" for="_commandNoArgGroup">Command:</label>
<select class="select label" name="_commandNoArgGroup" id="_commandNoArgGroup">
  <option value="feed">feed</option>
  <option value="status">status</option>
  <option value="capture">capture</option>
</select>

<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Add a a group to your user. This requires that group to be known to the MQTT messaging system (using addUserToGroup below)')" />
<input type="button" class="button" id="_buttonAddNewGroup" value="Add New Group" onClick="addNewGroup('_newGroupName')" />
<input class="text" name="_newGroupName" id="_newGroupName" length="40" type="text" value="" />
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Remove a group from our user.')" />
<input type="button" class="button" id="_buttonRemoveGroup" value="Remove Group" onClick="removeGroup('_groups')" />
<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Add a device (yours or others) where you provide the device name, and a name to help you know whos device it is - such as Scotts.ScoobyDoo'. To delete devices, use delete group.)" />
<input type="button" class="button" id="_buttonAddGroupDevice" value="Add Device to Group" onClick="addNewGroupDevice('_groups','_newGroupDeviceName','_newGroupDisplayDevicename')" />
<label class="label" for="_newGroupDeviceName">Device Name:</label>
<input class="text" name="_newGroupDeviceName" id="_newGroupDeviceName" length="40" type="text" value="" />

<label class="label" for="_newGroupDisplayDeviceName">Display Device Name:</label>
<input class="text" name="_newGroupDisplayDeviceName" id="_newGroupDisplayDeviceName" length="40" type="text" value="" />

<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Subscribe to specific groups. Syntax: # or empty, revers to all, otherwise comma seperated (eg. atlasDogs,houndDogs) spaces allowed.')" />
<input type="button" class="button" id="_buttonSubscribeGroups" value="Subscribe Groups" onClick="subscribeGroups('devices','_subscribeGroupNames')" />
<label class="label" for="_subscribeGroupNames">Group Names:</label>
<input class="text" name="_subscribeGroupNames" id="_subscribeGroupNames" length="40" type="text" value="#" />



<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Send to your device(s)\nUsing on/off flag')" />
<input type="button" class="button" id="buttonBooleanArgs97" value="Send Message" onClick="sendBooleanArgs('devices','commandBoolean97','boolArgValue97')" />
<label class="label" for="commandBoolean">Command:</label>
<select class="select label"  name="commandBoolean97" id="commandBoolean97">
  <option value="usegroups">Use GROUPS if a group member</option>
</select>

<label class="label" for="boolArgValue97">Flag:</label>
<select class="select label"  name="boolArgValue97" id="boolArgValue97">
  <option value="on">on</option>
  <option value="off">off</option>
</select>

<br>
<br>
<!----------------------------------------------------------------------->

<h2 class="M5button" id="_M5SpecificCommands" name="_M5SpecificCommands" onClick="hideShowMarkup(['_m5Commands'])" >3. M5 Specific Commands</h2>
<p class="label" id="_m5Commands">
Message mostly managing the M5 Display or functions the M5 smart clicker manages with the other IoT devices
<br>
<!--NOTE: These have to be in sync with mainModule.h -->
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Send commands without an argument')" />
<input type="button" class="M5button" id="buttonNoArgsM5" value="Send Message" onClick="sendNoArgs('devices','commandNoArgM5')" />
<label class="label" for="commandNoArgM5">Command:</label>
<select class="select label"  name="commandNoArgM5" id="commandNoArgM5">
  <option value="feed">feed</option>
  <option value="status">status</option>
  <option value="powerOff">poweroff</option>
  <option value="wifi">wifi</option>
  <option value="swapwifi">swapwifi</option>
  <option value="readspiff">readspiff</option>
  <option value="help">help</option>
  <option value="temp">temp</option>
  <option value="capture">capture</option>
  <option value="reboot">reboot</option>
</select>


<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Send messages using a number argument')" />
<input type="button" class="M5button" id="intBooleanArgs" value="Send Message" onClick="sendTextArgs('devices','intArgCommand','intArgText')" />
<label class="label" for="intArgCommand">Command:</label>
<select class="select label"  name="intArgCommand" id="intArgCommand">
  <option value="screencolor">screencolor</option>
  <option value="stepperangle">stepperangle</option>
  <option value="screentimeout">screentimeout</option>
  <option value="noclick">noclick 10000=always on</option>
  <option value="timerdelay">Timer delay in seconds</option>
</select>

<input class="text" name="intArgText" id="intArgText" length="64" type="number" min=0 max=3000 value=0>
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Cycle the banner color \non the M5 screen')" />
<input type="button" class="M5button" id="cycleM5ScreenColors" value="Cycle M5 Screen Colors" onClick="cycleM5ScreenColors('devices','intArgCommand','intArgText')" />

<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Change the M5 Page')" />
<input type="button" class="M5button" id="buttonM5NoArgsPage" value="Send Message" onClick="sendNoArgsM5('devices','commandNoArgM5Page')" />
<label class="label" for="commandNoArgM5Page">M5 Change Page</label>
<select class="select label"  name="commandNoArgM5Page" id="commandNoArgM5Page">
  <option value="sm0">Mini Page: Tilt</option>
  <option value="sm1">Mini Page: Buz</option>
  <option value="sm2">Mini Page: Feed</option>
  <option value="sm3">Menus Page</option>

  <option value="sm4">Smart Clicker</option>
  <option value="sm5">Status</option>
  <option value="sm6">WIFI SSID</option>
  <option value="sm7">Guest Page</option>
  <option value="sm8">AP MODE</option>
  <option value="sm9">Guest Feed</option>
  <option value="sm10">Pair Device</option>
  <option value="sm11">Help</option>
  <option value="sm12">DOC FOLLOW</option>
  <option value="sm13">Timer</option>
  <option value="sm14">Reboot</option>
</select>


<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Cycle the M5 Page \nto the next one')" />
<input type="button" class="M5button" id="cycleM5Page" value="Cycle M5 Pages" onClick="cycleM5Pages('devices','commandNoArgM5Page')" />
<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Messages that use a boolean value ')" />
<input type="button" class="M5button" id="buttonBooleanArgsM5" value="Send Message" onClick="sendBooleanArgs('devices','commandBooleanM5','boolArgValueM5')" />
<label class="label" for="commandBooleanM5">M5 Command:</label>
<select class="select label"  name="commandBooleanM5" id="commandBooleanM5">
  <option value="minMenu">minMenu: Minimize the menus</option>
  <option value="maxMenu">maxMenu: Show all the menus</option>
  <option value="gen3only">gen3only: Only Pair with GEN3</option>
  <option value="bleclient">bleclient: Enable BLE Client</option>
  <option value="bleserver">bleserver: Enable BLE Server</option>
  <option value="gateway">gateway: Act as a Gateway to GEN3</option>
  <option value="tilt">tilt: Set Tilt On/Off</option>
  <option value="buzz">buzzer: Set buzzer On/Off</option>
  <option value="blankscreen">blankscreen: Blank the M5 Screen</option>
  <option value="docfollow">docfollow: Turn on DOCFOLLOW</option>
  <option value="usespiff">usespiff: Use the SPIFF mode</option>
  <option value="ble+wifi">Send WIFI with BLE feed</option>
  <option value="factoryreset">Factory Reset: Reset the device</option>
  <option value="pairnow">BLE pairnow: Pair the device</option>
  <option value="DiscoverM5PTClicker">Discover M5 PTClicker</option>
  <option value="restartmodels">Restart the Models</option>
  <option value="usegroups">Use GROUPS if a group member</option>
  <option value="devOnlySM">Only Display SM if to device</option>
</select>

<label class="label" for="boolArgValueM5">Value:</label>
<select class="select label"  name="boolArgValueM5" id="boolArgValueM5">
  <option value="on">on</option>
  <option value="off">off</option>
</select>


<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sends the Semantic Marker')" />
<input type="button" class="M5button" id="buttonBooleanArgsM5-SM" value="Send Message" onClick="sendBooleanArgs('devices','commandBooleanM5-SM','boolArgValueM5-SM')" />
<select class="select label"  name="commandBooleanM5-SM" id="commandBooleanM5-SM">
  <option value="zoomSM">Show SemanticMarker&#x2122;</option>
</select>

<label class="label" for="boolArgValueM5-SM">Value:</label>
<select class="select label"  name="boolArgValueM5-SM" id="boolArgValueM5-SM">
  <option value="off">Show SM</option>
  <option value="on">Hide SM</option>
</select>

<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Messages to iDogWatch app that use a boolean value ')" />
<input type="button" class="button" id="buttonBooleanArgsIoSApp" value="Send Message" onClick="sendBooleanArgs('devices','commandBooleanIoSApp','boolArgValueIoSApp')" />
<label class="label" for="commandBooleanIoSApp">IoS App Command:</label>
<select class="select label"  name="commandBooleanIoSApp" id="commandBooleanIoSApp">

<!--
//! These definitions are what show up in the Pulldown..
//These are known settings settable by parameters on semantic markers (eg. widgets?animals=yes&images=no
// widgets?SMSharing=yes&SMSharingLeader=yes&isLAN=no&SemanticWidgets=yes ...
-->
<option value="SemanticWidgets">SemanticWidgets:: Turn on/off the semantic widgets</option>
<option value="HUD">HUD:: Turns on/off the Starwars HUD Display</option>
<option value="pause">pause:: Pauses the AR in place so the original SM can be seen</option>
<option value="pdf">pdf:: Goes to the PDF page</option>
<option value="SM_ReplaceUUID">SM_ReplaceUUID:: For Inheritance, use the Replaced UUID</option>
<!--
//others we know about for now.. hard wired
//! draw the Semantic Marker Instance (the QR Code but instantiated, 11.8.22) eg. replace USERNAME, PASSWORD
-->
<option value="SM_Instance_Image">SM_Instance_Image:: Show the semantic widgets</option>
<option value="animals">animals:: Use Animals for the AR overlay</option>
<!-- //! draw other (like mountain) -->
<option value="images">image:: Draw non-animals, like mountains</option>
<option value="matrix">matrix:: Show the 'Matrix'</option>
<option value="SMFocusCapture">SMFocusCapture:: Will screen capture when in-focus (depreciated)</option>
<option value="SM_FocusCapture">SM_FocusCapture:: Will screen capture when in-focus</option>
<option value="SM_AR_Minimal">SM_AR_Minimal:: Sets the AR Overlay options</option>
<option value="SM_AR_Zoom">SM_AR_Zoom:: Zooms the AR Overlay</option>
<option value="SM_VisionLinker">SM_VisionLinker:: Starts up the Vision Linker</option>
<option value="CaptureSetting">CaptureSetting:: Defines what to do when an 'capture' message arrives</option>
<option value="SM_WebPage">SM_WebPage:: invoke the web site</option>
<option value="SM_UseCropImage">SM_UseCropImage:: Use last cropped image as the AR</option>
<option value="SM_QRAvatar">SM_QRAvatar:: Show the AR specified above</option>
<option value="SM_VideoPlayback">SM_VideoPlayback:: Set a default video playback</option>
<option value="SM_PlaySound">SM_PlaySound:: Plays Audio/video sound</option>
<option value="SM_Haptics">SM_Haptics:: Turn on/off haptics(todo)</option>
<option value="SM_ShowLabels">SM_ShowLabels:: Show Semantic Marker labels in realtime</option>
<option value="SM_PrintStack">SM_PrintStack:: Used in debugging to set breakpoint</option>
<option value="SM_FlipRotate">SM_FlipRotate:: Flip/Rotate image internally</option>
<option value="SM_Flip">SM_Flip:: Flip Image for recognition</option>
<option value="isLAN">isLan:: Sets LAN or WAN</option>
<option value="SMSharing">SMSharing:: Starts DOCFOLLOW SM Sharing</option>
<option value="SMSharingLeader">SMSharingLeader:: Sets DOCFOLLOW Sharing Leader or Follower</option>

</select>

<label class="label" for="boolArgValueIoSApp">Value:</label>
<select class="select label"  name="boolArgValueIoSApp" id="boolArgValueIoSApp">
  <option value="yes">yes</option>
  <option value="no">no</option>
</select>

<!-- Sets the _uuidStringText value and sends as 'set/replaceUUID/<uuid>' -->
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sets selected SMART Deck UUID as Inheritance Replacement UUID: ' + document.getElementById('_uuidStringText').value)" />
<input type="button" class="button" id="stringTextArgs"  value="ReplaceUUID" onClick="sendTextArgs('devices','stringArgCommandReplaceUUID','_uuidStringText')" />
<label class="label" for="stringArgCommandReplaceUUID">Command:</label>
<select class="select label"  name="stringArgCommandReplaceUUID" id="stringArgCommandReplaceUUID">
  <option value="replaceUUID">Use the UUID </option>
</select>

<!-- END -->

<!--
Default ON: (trouble is these are the defines, not the string values

_settingKeys = @[SEMANTIC_WIDGETS_SETTING, SEMANTIC_VISION_SHARING_SETTINGS, SEMANTIC_VISION_LEADER_SETTINGS, SEMANTIC_MARKER_INSTANCE_SETTINGS, ANIMALS_SETTINGS, IMAGES_SETTINGS, ISLAN_SETTINGS, MATRIX_MOVIE_SETTINGS, CAPTURE_FOCUSED_SM_SETTINGS, SM_AR_MINIMAL_SETTINGS, SM_AR_ZOOM_SETTINGS, SM_VISION_LINKER_SETTINGS, SM_WEB_PAGE_SETTINGS, SM_USE_CROP_IMAGE_SETTINGS, SM_REPLACE_UUID_SETTINGS, SM_VIDEO_PLAYBACK_SETTINGS, SM_SHOW_QRAVATAR_SETTINGS, SM_HAPTICS_SETTINGS, SM_SHOW_LABELS_SETTINGS, SM_PRINT_STACKTRACE_SETTINGS, SM_PLAY_SOUND_SETTINGS, SM_FLIP_ROTATE_SETTINGS, SM_FLIP_SETTINGS];
-->

<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sets to pair ONLY with device named')" />
<input type="button" class="M5button" id="stringTextArgs"  value="Pair" onClick="sendTextArgs('devices','stringArgCommandPair','devicesToPair')" />
<label class="label" for="stringArgCommandPair">Command:</label>
<select class="select label"  name="stringArgCommandPair" id="stringArgCommandPair">
  <option value="pairdev">Pair with GEN3 or ESP Device</option>
</select>
<label class="label" for="devicesToPair">Pair with Device Named:</label>
<select class="select label"  id="devicesToPair" >x</select>

<!--    Button Press START --->
<!--
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('devices')" />
<input type="button" class="M5button" id="callButtonCommand" value="Press Button" onClick="sendAnySetCommand('devices','commandButtonsM5','valButtonsM5')" />
<label class="label" for="commandButtonsM5">M5 Button Press:</label>
<select class="select label"  name="commandButtonsM5" id="commandButtonsM5">
  <option value="ButtonA">ButtonA</option>
  <option value="ButtonB">ButtonB</option>
</select>
<select class="select label"  name="valButtonsM5" id="valButtonsM5">
  <option value="shortPress">shortPress</option>
  <option value="longPress">longPress</option>
</select>

-->
<br>
<div id="btnContainer">
  <button class="btnA" onclick="sendAnySetCommand2('devices','ButtonA','shortPress')"><i class="fa fa-th-large"></i> A Short Press</button>
  <button class="btnB" onclick="sendAnySetCommand2('devices','ButtonB','shortPress')"><i class="fa fa-bars"></i> B Short Press</button>
</div>
<div id="btnContainer">
  <button class="btnA" onclick="sendAnySetCommand2('devices','ButtonA','longPress')"><i class="fa fa-th-large"></i> A Long Press</button>
  <button class="btnB" onclick="sendAnySetCommand2('devices','ButtonB','longPress')"><i class="fa fa-bars"></i> B Long Press</button>
</div>
<br>

<!--    Button Press END --->

<!----------------------------------------------------------------------->

<h1 class="H1" 
onClick="hideShowMarkup(['_SMRecordDevice','_m88.1','_m88.2','_m88.3','_m88.4','_m88.5','_m88.6','_markupTextID','markupText'])">
<img src="https://SemanticMarker.org/images/SM-Circle-R.png" width="50">
SMART Button IoT Recording via Semantic Marker&#x2122; Flows</h2>

<p class="label" id="_m88.1">
<label class="label" id="_SMRecordDevice" name="_SMRecordDevice">Dev</label>
<br>
<!-- https://www.w3schools.com/tags/tag_textarea.asp -->
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('A couple simple commands, and Clear')" />
<label class="label" for="recordedMessages">Recorded Messages:</label>
<input type="button" class="button" id="recordedMessagesClear" value="Clear" onClick="clearTextArea('_recordedMessages');" />
<input type="button" class="button" id="sendCaptureButton" value="Capture" onClick="sendCommandToDevice('devices','capture')" />
<input type="button" class="button" id="sendCaptureButton" value="Feed" onClick="sendCommandToDevice('devices','feed')" />

<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Send commands as SM too')" />
<label class="label" for="_boolArgValueRepeatSM">Repeat as SemanticMarker&#x2122;:</label>
<select class="select label"  name="_boolArgValueRepeatSM" id="_boolArgValueRepeatSM">
  <option value="off">off</option>
  <option value="on">on</option>
</select>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Send commands only as SM')" />
<label class="label" for="_boolArgValueOnlySM">Send only SemanticMarker&#x2122;:</label>
<select class="select label"  name="_boolArgValueOnlySM" id="_boolArgValueOnlySM">
  <option value="off">off</option>
  <option value="on">on</option>
</select>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Setup Flow Capture')" />
<input type="button" class="button" id="setupFlowCapture" value="Setup SM&#x2122; Flows" onClick="setupFlowCapture('_recordedMessages','_uuidStringText','_flowNumberText', '_boolArgValueRepeatSM', '_boolArgValueOnlySM','flowsSM')" />

<br>
<textarea class="label" id="_recordedMessages" name="_recordedMessages" rows="10" cols="100">
</textarea>
<br>

<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Temporary SMART Deck. Copy to your SMART Deck or delete, etc')" />
<textarea  id="_savedSMARTDeck" name="_savedSMARTDeck" rows="3" cols="120">
</textarea>
<br>

<!-- This will grab all the commands from the text recorded messages and base64 them .. and send as 1 message 
   https://SemanticMarker.org/bot/sm/saveflow/FLOW64?uuid=UUID&p=10    where p == procedure number
	Then to run:
	https://SemanticMarker.org/bot/smart?uuid=UUID&p=10
	// maybe a get flow decoded command.
-->
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Create unique Flow #')" />
<input type="button" class="button" id="CreateUUID" value="Create New SMART Flow#" onClick="createFlowUUID('_flowNumberText')"/>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Copy current SM:'+ currentlyShownSM() + '\nPaste other places, like SMART Deck SM')" />
<input type="button" class="button" id="copySMbutton" value="Copy SM" onClick="copySM(currentlyShownSM())"/>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Inherit a Semntic Marker SMART Button, but renaming with your UUID. The Flow# is the same but other values can be user updated including the QRAvatar')" />
<input type="button" class="button" id="retrieveSMbutton" value="Inherit SMART Button" onClick="retrieveSM(false)"/>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Clone a Semntic Marker SMART Button, but renaming with your UUID and a unique Flow#. This works well to point to another SMART Deck, and go to it's flow which can be updated by that SMART Deck's owner, and you get the updates.')" />
<input type="button" class="button" id="cloneSMbutton" value="Clone SMART Button" onClick="retrieveSM(true)"/>

<!-- these are placeholders so the showSMFlow works for now.. 4.30.23 -->
<input type="hidden" class="text" name="_selectedFlowIndex" id="_selectedFlowIndex" length="10" type="text" /></td>
<input type="hidden" class="text" name="_hiddenUUID" id="_hiddenUUID" length="10" type="text" /></td>
<input type="hidden" class="text" name="_hiddenFlowNum" id="_hiddenFlowNum" length="10" type="text" /></td>
<br>
<br>

<!-- Start  of the new table -->
<p id='_m88.4'>
<div class="row" >
  <div class="column1" style="background-color:lightgrey">

  <table class='style1' id='_m88.2'>
	 <tr>
<td>    <h2>QRAvatar</h2> </td>
	 </tr>
	<tr>
	<td>
	<!--  where the QRAvatar will go.. -->
   <img width="80%" id="_QRAvatarId2" name="_QRAvatarId2" src="https://SemanticMarker.org/images/SM-Circle-R.png" > </td>
	 <tr>
     <td><h2>SemanticMarker&#x2122;</h2> </td>
	 </tr>
	</tr>
	<tr>

	<!--  where the SemnticMarker will go.. -->
	<td>
   <p id="otherSM">https://SemanticMarker.org</p>
	</td>
	</tr>

	<td>
<div class="tooltip">
  <input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('Invokes (Runs) the Semantic Marker in a new Web Page')"/>
   <span class="tooltiptext">
Invokes (Runs) the Semantic Marker in a new Web Page
  </span>
</div>
   <input type="button" class="HELPButton" id="invokeSMId" value="Invoke Semantic Marker" onClick="invokeSemanticMarker('flowSMName');" />
	</td>

	</table>
  </div>
  <div class="column2" style="background-color:white">
    <h1>Semantic Marker&trade; SMART Button</h1>
	 <table class='style1' id='_m88.3'>
	    <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Name of your SMART Button. No spaces, but underscore allowed.')"/>
	      <b>SMART Button Name</b></td>
<td><input class="text" name="flowNameText" id="flowNameText" size="70" type="text" /></td>
	    </tr>

		 <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Name of your SMART Button Category. No spaces, but underscore allowed.')"/>
	      <b>SMART Category</b></td>
<td><input class="text" name="flowCatText" id="flowCatText" size="70" type="text" /></td>
       </tr>

        <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('The UUID of this SMART Deck, and this Flow Number, Flow Name and Flow Category are all part of this SMART Deck. Create a new SMART Deck with the buttons later')"/>
<b>UUID</b></td>
<td><input class="text" name="_uuidStringText" id="_uuidStringText" size="64" type="text" readonly value="soIZ1iH7FK" />
		     </td>
        </tr>
       <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('The Flow number of your SMART Button. These are auto generated by Create New SMART Flow# button. Flow=0 is a root flow. Note for inheritance, the flow# will be same as inherited SMART Button.')"/>
<b>Flow#</b></td>
<td><input class="text" name="_flowNumberText" id="_flowNumberText" size="40" type="text"/>
       </td>
		 </tr>

      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('The Semantic Marker (SM) Address is a UUID.FlowNumber - which is unique in the SMART System')"/>
<b>My SM Address</b></td>
<td><input class="text" readonly name="_mySMLink" id="_mySMLink" size="70"  type="text" />
       </td>
     </tr>


       <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('The generated full Semantic Marker address you can share with others.')"/>
<b>Full Semantic Marker&#x2122;</b></td>
<td><input class="text" name="flowSMName" id="flowSMName" size="70" type="text" readonly value="" />
         </td>
       </tr>


      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('URL Address of the QRAvatar image to use inside your Semantic Marker')"/>
		   <b>QRAvatar URL</b></td>
<td><input class="text" name="flowQRAvatarURLText" id="flowQRAvatarURLText" size="70" type="text" />
		   </td>
      </tr>

      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('If Circular set the QRAvatar inside the Semantic Marker will be circular, otherwise it will be landscape.')"/>
<b>Is Circular QRAvatar</b></td>
<td><select class="select label"  name="boolArgValueIsCircularAvatar" id="boolArgValueIsCircularAvatar">
  <option value="false">false</option>
  <option value="true">true</option>
</select>
        </td>
      </tr>

		<tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('SMART Deck is ordered collection of SMART Buttons comma seperated, such as UUID.flow1,UUID,flow2. Use the Copy SM button above to grab another and place it here (using copy paste of the browser)')"/>
<b>SMART Deck SM's</td>
<!--
<td><input class="text" name="deckSMText" id="deckSMText" size="70" type="text" />
-->
<td><textarea class="label" id="deckSMText" name="deckSMText" rows="3" cols="100">
</textarea>
        </td>
      </tr>

		<!-- add links -->
      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Buttons the show the selected link, or traverse to the previous link. The SMART Buttons below also support clicking on them to traverse this Cone Tree rooted in this SMART Button')"/>
<b>SMART Deck Links</b></td>
<td>
<input type="button" class="select label" id="_showLinkButton" value="Show SM&#x2122; Link" onClick="showSMLink('_SMARTDeckLinks')">
<input type="button" class="select label" id="_previousLinkButton" value="Previous Link" onClick="showPreviousLink()">
<select class="select label"  name="_SMARTDeckLinks" id="_SMARTDeckLinks">
</select>
        </td>
      </tr>

	  <!-- IMAGES for Deck links  -->
	  <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('History of SMART Buttons as you traverse the Cone Tree. This includes the inherited as well.')"/>
	    <b>SMART Buttons</b></td>
		 <td id="_SMARTButtonsDeckImages">
	<!-- modify document.getElementById("_SMARTButtonsDeckImages").innerHTML
	      <table>
		     <tr>
	          <td><img width="100" src="https://SemanticMarker.org/images/M5/M5Menu.jpg">
	          <td><img width="100" src="https://user-images.githubusercontent.com/5956266/219514302-25c41a8a-f3fd-41de-88fe-be675cb7e5e1.jpeg">
	          <td><img width="100" src="https://user-images.githubusercontent.com/5956266/221418254-a93d02bf-31b4-46fa-b740-bfde510c43aa.jpeg">
	          <td><img width="100" src="https://SemanticMarker.org/users/QHmwUurxC3/LauraSki.jpg">
				</tr>
			</table>
	  -->
	  </tr>
	  <!-- end IMAGES for Deck links  -->


		<!-- add links DONE-->
      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Inherited SMART Button address. Use the Inherit SM button above')"/>
<b>Inherited SM Address</b></td>
<td><input class="text" name="inheritedSMText" id="inheritedSMText" size="70" type="text" />
       </td>
     </tr>

      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('The Next Flow URL - which can be used to create the hard coded execution of the SMART Button (without using the parameters below)')"/>
<b>Next Flow URL</b></td>
<td><input class="text" name="nextFlowURLText" id="nextFlowURLText" size="70"  type="text" value=""/>
         </td>
		</tr>

      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Date last saved')"/>
<b>Flow Date</b></td>
<td><input class="text" readonly name="flowDateText" id="flowDateText" size="35" length="35" type="text" />
       </td>
		</tr>

      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Set if some elements of your SMART button are private')"/>
<b>Is Private</b></td>
<td>
<select class="select label"  name="boolArgValuePrivate" id="boolArgValuePrivate">
  <option value="false">false</option>
  <option value="true">true</option>
</select>
        </td>
      </tr>
      
		<!--
		<tr>
<td><b>Semantic Marker&#x2122;</b></td>
<td><input class="text" name="flowSMName" id="flowSMName" size="70" type="text" readonly value="" />
        </td>
      </tr>
		-->

      <tr>
<td>
<input type="button" class="HELPButton2" value="?" onClick="alert('use @(markup) to direct to markup as your web page')"/>
<b>Is Indirect SM</b></td>
<td>
<select class="select label"  name="boolArgValueIsIndirectSM" id="boolArgValueIsIndirectSM">
  <option value="false">false</option>
  <option value="true">true</option>
</select>
        </td>
      </tr>

      <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('URL of final web page, or use @(markup) to direct this SMART Button  markup as your web page')"/>
<b>Indirect SM Link</b></td>
<td><input class="text" name="_indirectSMText" id="_indirectSMText" size="70"  type="text" />
       </td>
     </tr>


      <tr id="_locationSMTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Enter a location you wish to share. It can be a city, state, country - or as low as GPS coordinates')"/>
<b>Location of SM in world</b></td>
<td><input class="text" name="locationSMText" id="locationSMText" size="70" type="text" />
       </td>
     </tr>


      <tr id="_audioSMTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Audio artifact SM web address')"/>
<b>Audio SM Address</b></td>
<td><input class="text" name="audioSMText" id="audioSMText" size="70" type="text" />
       </td>
     </tr>


       <tr>
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Future concept where the SMART Button provides the parameter values')"/>
		   <b>Is Data</b></td>
			<td>
<select class="select label"  name="boolArgValueIsData" id="boolArgValueIsData">
  <option value="false">false</option>
  <option value="true">true</option>
        </td>
		</tr>

      <tr id="_dateSMTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Future concept where the SMART Button provides the parameter values')"/>
<b>Data SM Address</b></td>
<td><input class="text" name="dataSMText" id="dataSMText" size="70" type="text" />
       </td>
     </tr>

      <tr id="_artifactsSMTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('5.29.23 Used for @playlist(songName,url,song2,url) and @slideshow() same name,url without quotes, and sets seperated by comma ','')"/>
<b>Artifacts SM Address</b></td>
<!--
<td><input class="text" name="artifactsSMText" id="artifactsSMText" size="70" type="text" />
<td><textarea class="label" id="artifactsSMText" name="artifactsSMText" rows="3" cols="100">
using small text...
-->
<td><textarea  id="artifactsSMText" name="artifactsSMText" rows="3" cols="100">
</textarea>
       </td>
     </tr>

      <tr id="_videoSMTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Video artifact SM web address')"/>
<b>VideoSM Address</b></td>
<td><input class="text" name="videoSMText" id="videoSMText" size="70" type="text" />
       </td>
     </tr>


      <tr id="_KSMatrixTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Knowledge Shark Matric Address for this SMART Button. This is a matrix address like 3a5b8a')"/>
<b>Knowledge Shark Matrix</b></td>
<td><input class="text" name="KSMatrixText" id="KSMatrixText" size="70" type="text" />
       </td>
     </tr>

      <tr id="_KSWaveTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Knowledge Shark Wave  Address for this SMART Button. This is a URL to a Wave bundle for loading into the Knowledge Shark app. Catch-the-wave')"/>
<b>Knowledge Shark Wave Address</b></td>
<td><input class="text" name="KSWaveText" id="KSWaveText" size="70" type="text" />
       </td>
     </tr>

      <tr id="_futureTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('5.23.23 @remap(URL) will remap that existing QR to this Smart Button Semantic Marker when scanned with a Semantic Marker aware tool')"/>
<b>Future Text Area</b></td>
<!--
<td><input class="text" name="_futureText" id="_futureText" size="70" type="text" />
-->
<td><textarea class="label" id="_futureText" name="_futureText" rows="3" cols="100">
</textarea>
       </td>
     </tr>


      <tr id="_languagesSMTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('How this SMART Button can translate to other languages')"/>
<b>Language Translations</b></td>
<td><input class="text" name="languagesSMText" id="languagesSMText" size="70" type="text" />
       </td>
      </tr>

      <tr id="_MQTTMessagingTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Future where this SMART Button communicates on an MQTT topic')"/>
<b>SMART Messaging</b></td>
<td>
<select class="select label"  name="boolArgValueIsMessaging" id="boolArgValueIsMessaging">
  <option value="false">false</option>
  <option value="true">true</option>
</select>
        </td>
       </tr>

      <tr id="_bridgeSMTextTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('Future where this SMART Button communicates on an MQTT topic')"/>
<b>Bridge MQTT Topic Info</b></td>
<td><input class="text" name="bridgeSMText" id="bridgeSMText" size="70" type="text" />
       </td>
     </tr>

       <tr id="_parameterValuesSMTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('The Parameter names from the SMART Button flows')"/>
<b>Parameters</b></td>
<td><select class="select label"  name="parameterValuesSM" id="parameterValuesSM">x</select>
         </td>
       </tr>

       <tr id="_flowValuesSMTR">
<td><input type="button" class="HELPButton2" value="?" onClick="alert('The SMART Button flows')"/>
<b>Flows</b></td>
<td><select class="select label"  name="_flowValuesSM" id="_flowValuesSM">x</select>
		    </td>
       </tr>

<tr>
<td>
<!-- pass an array .. so we can expand.. -->
<input type="button" class="select label" value="Hide/Show Markup" onClick="hideShowMarkup(['markupText','_SMARTMarkup', '_locationSMTextTR', '_audioSMTextTR', '_dateSMTextTR', '_artifactsSMTextTR', '_videoSMTextTR','_bridgeSMTextTR','_flowValuesSMTR','_parameterValuesSMTR','_MQTTMessagingTR', '_KSMatrixTextTR','_KSWaveTextTR', '_futureTextTR','_languagesSMTR','_markupTextID', '_SMARTMarkupTableID' ])"/>
</td>
</tr>

		</table>
  </div>
</div>

	<!-- try an image if specified .. -->
	<table border="2" id="_SMARTMarkupTableID">
	<tr>
	  <td><p class="label" id="_SMARTMarkup">
	  </td>
	</tr>
	</table>
<br>
<label class="label" id="_markupTextID" for="markupText">Markup (simple) html text. @(header),  @(uuid.flowNum) to include link, @(audio), @(video), @(playlist), @(SMARTDeck), @(QRAvatar), @(SM),  @(next)</label>
<br>
<textarea class="label" id="markupText" name="markupText" rows="15" cols="100">
</textarea>
<br>
<br>
<!-- end 3.22.23 -->
<br>
<label class="label" for="descriptionText">Description</label>
<br>
<textarea class="label" id="descriptionText" name="descriptionText" rows="5" cols="100">
</textarea
<br>
<br>
<p class="label" id="_m88.6">
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Saves the Semantic Marker&#x2122; flow \nwith your agent, asking to \nupdate if one already exists')" />
<input type="button" class="H1green" id="buttonSaveFlow" value="Save Semantic Marker&#x2122; Flow" onClick="sendSavedFlow('_recordedMessages','_uuidStringText','_flowNumberText', 'flowNameText', 'flowCatText', 'boolArgValuePrivate','flowsSM','boolArgValueIsData','descriptionText','flowDateText','flowQRAvatarURLText', 'parameterValuesSM','nextFlowURLText', 'KSMatrixText', 'dataSMText', 'artifactsSMText', 'markupText', 'languagesSMText', 'videoSMText', 'boolArgValueIsCircularAvatar', 'audioSMText', 'locationSMText', 'inheritedSMText', 'deckSMText', 'boolArgValueIsMessaging', 'boolArgValueIsIndirectSM','_indirectSMText', 'KSWaveText', 'bridgeSMText', '_futureText')" /> 
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Remove the Semantic Marker&#x2122; flow \nwith your agent, asking to \nupdate if one already exists')" />
<input type="button" class="M5button" id="buttonRemoveFlow" value="Remove SM" onClick="sendRemoveFlow('_recordedMessages','_uuidStringText','_flowNumberText', 'flowNameText', 'flowCatText', 'boolArgValuePrivate','flowsSM','boolArgValueIsData','descriptionText','flowDateText','flowQRAvatarURLText', 'parameterValuesSM','nextFlowURLText', 'KSMatrixText', 'dataSMText', 'artifactsSMText', 'markupText', 'languagesSMText', 'videoSMText', 'boolArgValueIsCircularAvatar', 'audioSMText', 'locationSMText', 'inheritedSMText', 'deckSMText', 'boolArgValueIsMessaging', 'boolArgValueIsIndirectSM','_indirectSMText', 'KSWaveText', 'bridgeSMText', '_futureText')" /> 
<br>
<br>
<!-- push a SM -->
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Paste in a SM (uuid.flownum) to load another users SMART Button. You could even inherit or clone this SM')" />
<input type="button" class="H2green" value="Paste another SM (UUID.flownum):"
onClick="pushSMLink(document.getElementById('_testSMText').value)"/>
<input class="text" name="_testSMText" id="_testSMText" size="30" type="text" />
<br>
<!--
<p class="label"> 
*This overrides or renames same named flow
<br>
NOTE: Flows are used when multiple commands are recorded for future playback. 
Otherwise a single SemanticMarker 
<br>
can be sent which will be Base64 encoded (and self contained). 
<br>
Although this is being deprecated.
<br>
Use 'Setup' to create flows with a number and a name.
<br> 
When a flow is selected below, the same info is added above, and can be edited. The Save Flow will update the information.

-->

<br>
<h2 class="H2" onClick="hideShowMarkup(['mSM.2','sm1','_sm11','_sm12'])"><img src="https://SemanticMarker.org/images/SM-Circle-R.png" width="50" >Current Semantic Marker&#x2122; Flows</h2>
<p class="label" id="mSM.2"> 
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Get the known SM Flows \bfrom your agent')" />
<input type="button" class="H1" id="buttonSMFlow" value="Get User SM&#x2122; Flows" onClick="getSMFlows('_uuidStringText','flowsSM')" />

<!-- FOR NOW .. a seperate button for the other UUID's -->
<!--
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Get the known SM Flows \bfrom your agent')" />
<input type="button" class="H1" id="buttonSMFlow" value="2-Get User SM&#x2122; Flows" onClick="getSMFlows('_uuidStringText','flowsSM')" />
-->

<label class="label" for="_UUID_Select">Choose SMART Deck</label>
<select class="select label"  name="_UUID_Select" id="_UUID_Select"
onChange="getSMFlows('_uuidStringText','flowsSM')" />x</select>
<br>
<br>


<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Show selected SM Flow')" />
<input type="button" class="H1" value="Show SM&#x2122; Flow" onClick="showSMFlow('flowsSM','parameterValuesSM','_flowValuesSM','_flowNumberText','flowNameText','flowCatText','boolArgValuePrivate','flowSMName','boolArgValueIsData','descriptionText','_recordedMessages','flowDateText','flowQRAvatarURLText','sm1','sm1Command','nextFlowURLText','KSMatrixText', 'dataSMText', 'artifactsSMText', 'markupText','languagesSMText','videoSMText', 'boolArgValueIsCircularAvatar', 'audioSMText', 'locationSMText', 'inheritedSMText',  'deckSMText', 'boolArgValueIsMessaging',  'boolArgValueIsIndirectSM','_indirectSMText', 'KSWaveText', 'bridgeSMText', '_futureText','_QRAvatarId2','otherSM')">
<label class="label" for="flowsSM">Flows</label>
<select class="select label"  name="flowsSM" id="flowsSM" 
onChange="showSMFlow('flowsSM','parameterValuesSM','_flowValuesSM','_flowNumberText','flowNameText','flowCatText','boolArgValuePrivate','flowSMName','boolArgValueIsData','descriptionText','_recordedMessages','flowDateText','flowQRAvatarURLText','sm1','sm1Command','nextFlowURLText','KSMatrixText', 'dataSMText', 'artifactsSMText', 'markupText','languagesSMText','videoSMText', 'boolArgValueIsCircularAvatar', 'audioSMText', 'locationSMText', 'inheritedSMText',  'deckSMText', 'boolArgValueIsMessaging',  'boolArgValueIsIndirectSM','_indirectSMText', 'KSWaveText', 'bridgeSMText', '_futureText','_QRAvatarId2','otherSM')">x</select>
<br>

<!-- OOPS .. these flows are GENERIC and need parameters in order to run.. 
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Runs this flow using delay amount')" />
<button  type="button" class="button"
onclick="runSemanticMarker('_flowValuesSM')">Run Semantic Marker&#x2122;</button>
<label class="label" for="_delayAmount">Delay Between Runs:</label>
<select class="select label" name="_delayAmountId" id="_delayAmountId">
  <option value="1">1 sec</option>
  <option value="5">5 sec</option>
  <option value="10">10 sec</option>
</select>
<br><label class="label" for="_commandRunText">Command Run:</label>
  <input class="label" size="100" type="text" id="_commandRunText" name="_commandRunText">

<br>
-->

<!-- Cone Tree -->
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Collects full SMART Deck Cone Tree. When finished, click \'Show SMART Cone Tree\' to create a new window and a PDF for printing or saving')" />

<input type="button" class="H1" id="buttonTraverseSMARTDeck" value="Collect Full SMART Deck Cone Tree" onClick="traverseSMARTDeck('_UUID_Select','_flowNumberText')" />
<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Creates and displays the SMART Cone Tree')" />
<input type="button" class="OrangeButton" id="_buttonShowSMARTDeckTree" value="Show SMART Cone Tree" onClick="showFullSMARTDeckTreeHTML()" />
<input type="button" class="OrangeButton" id="_waitingCount" value="0" onClick="alert('Count of outstanding web calls to create the Cone Tree.\nWait to see 0 before clicking on Show SMART Cone Tree')" />

<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Dispay the flow in a new window\nCustomized for the individual user')" />
<input type="button" class="H1green" id="buttonRunFlow" value="Invoke SM&#x2122; Flow in New Window" onClick="invokeSavedFlow('_recordedMessages','_uuidStringText','_flowNumberText','boolArgValuePrivate')" />
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sends this flow address \nas a Semantic Marker to your users')" />
<input type="button" class="button" id="buttonSMFlow" value="Send SemanticMarker&#x2122; as DOCFOLLOW" onClick="sendFlowSM('_uuidStringText','_flowNumberText','flowNameText','flowCatText')" />

<br>
<br>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sends this flow as JSON to users specified')" />
<input type="button" class="button" id="buttonSMFlow" value="Send SMARTButton as JSON" onClick="sendSMARTButtonJSON('_uuidStringText','_flowNumberText','flowNameText','flowCatText')" />

<br>

<!--
<p>
IsData is a future plan where the Parameters will be actual names 
of data elements, and each flow item
will be a value (or a web address to get a value). 
<br>
Syntax something like:  Parameters = value.
<br>
Thus to get values, knowing the flow, 
one calls smart?uuid=U&flow=F&format=json&isdata=true
<br>
-->
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Gets the parameters of \ncurrent flow category. (aggregating all the parameters in all the flows of that category) call: smart?uuid=U&flowcat=CAT')')" />
<input type="button" class="button" id="buttonGetCatParms" value="Get Category Parameters" onClick="getCatParms('flowsSM','parameterCatValuesSM','flowCatDup')" />
<label class="label" for="flowCatDup">Flow Category</label>
<input class="label" name="flowCatDup" id="flowCatDup" length="20" type="text" readonly value="" />
<br>
<label class="label" id="_sm11"for="parameterCatValuesSM">Parameters</label>
<select class="select label"  name="parameterCatValuesSM" id="parameterCatValuesSM">x</select>

<br>
<br>
<p style="margin-left:100px; margin-right:50px;" id="sm1"></p>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Web Page is flow you run\nJSON is the definition of that flow')" />
<button type="button" class="button" onclick="invokeURLid('flowSMName')">Web Page</button>
<button type="button" class="button" onclick="invokeURLid2('flowSMName','&format=json')">JSON</button>
<input class="text" size="100" type="text" id="sm1Command" name="sm1Command">
<br>

<br>
<!-- start create a new SMART DECK -->

<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Create a new SMART Deck UUID\nThis helps organize and scale your SMART Decks by creating separate namespaces using the category and name. The sorting will be by category.')" />
<input type="button" class="H1" id="createSMARTDeck" value="Create SMART Deck" onClick="createSmartDeck('smartDeckCategory','smartDeckName','smartDeckPassword')" />

<br>
<label class="label" id="_sm12' for="smartDeckCategory">Category</label>
<input class="text" name="smartDeckCategory" id="smartDeckCategory" length="20" type="text" value="" />
<br>
<label class="label" for="smartDeckName">Name</label>
<input class="text" name="smartDeckName" id="smartDeckName" length="20" type="text" value="" />
<br>
<label class="label" for="smartDeckPassword">Password</label>
<input class="text" name="smartDeckPassword" id="smartDeckPassword" length="20" type="text" value="" />
<br>
<!-- calls: /adddeckuuid/:NAME/:PASSWORD/:DECKNAME/:DECKPASSWORD/:DECKCAT -->



<!-- end create a new SMART DECK -->
<!----------------------------------------------------------------------->
<!--
<h2 class="H2" id="_DOCFOLLOWMessages" name="_DOCFOLLOWMessages">DOCFOLLOW SemanticMarker&#x2122; Example Messages</h2>
-->
<h2 class="H2" id="_DOCFOLLOWMessages" name="_DOCFOLLOWMessages" onClick="hideShowMarkup(['m10.1'])" > DOCFOLLOW SemanticMarker&#x2122; Example Messages</h2>
<p class="label" id="m10.1">
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sends a Semantic Marker on the DOCFOLLOW topic')" />
<input type="button" class="button" id="setSMCommand64" value="setSMCommand64" onClick="sendAnySetCommand64('devices','smCommand64','smSetVal64')" />
<label class="label">DOCFOLLOW Command:</label>
<input class="text" name="smCommand64" id="smCommand64" length="64" type="text" value="SemanticMarker">
<label class="label">Val: (any URL allowed)</label>
<input class="text" name="smSetVal64" id="smSetVal64" size="64" type="text">

<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sends a Semantic Marker on the DOCFOLLOW topic')" />
<input type="button" class="button" id="setSMCommand64-2" value="setSMCommand64-2" onClick="sendAnySetCommand64('devices','smCommand64','commandArgSM')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Cycles through Semantic Marker examples')" />
<input type="button" class="button" id="cycleDocfollowExample" value="Cycle DOC FOLLOW Examples" onClick="cycleDOCFOLLOW('devices','smCommand64','commandArgSM','smWebAddress')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Specific DOCFOLLOW messages for the Knowledge Shark Book')" />
<label class="label" for="commandArgSM">DOCFOLLOW for KnowledgeShark book</label>
<select class="select label"  onchange="docFollowChanged('commandArgSM','smWebAddress')" name="commandArgSM" id="commandArgSM">

<option value="https://knowledgeshark.me/red/ks/jitl.kshark/cat/dhtml">jitl.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/book/cat/uuid">book</option>
<option value="https://KnowledgeShark.me/red/ks/genre.kshark/name/uuid">genre</option>
<option value="https://KnowledgeShark.me/red/ks/stakeholder.kshark/name/uuid">stakeholder.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/matrix.kshark/name/uuid">matrix.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/elevator.kshark/name/uuid">elevator.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/story.kshark/name/uuid">story.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/deathstar.kshark/name/uuid">deathstar.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/iceberg.kshark/name/uuid">iceberg.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/labyrinth.kshark/name/uuid">labyrinth.kshark</option>
<option value="https://KnowledgeShark.me/red/ks/knowledgeshark.me/name/uuid">knowledgeshark.me</option>
<option value="https://KnowledgeShark.me/red/ks/neutra/name/uuid">neutra</option>
<option value="https://KnowledgeShark.me/red/ks/howie.idogwatch/name/uuid">howie.idogwatch</option>

<option>--KnowledgeShark Book---</option>
<option value="https://KnowledgeShark.me/red/ks/concurrency/name/uuid">concurrency</option>
<option value="https://KnowledgeShark.me/red/ks/discovery/name/uuid">discovery</option>
<option value="https://KnowledgeShark.me/red/ks/binding/name/uuid">binding</option>
<option value="https://KnowledgeShark.me/red/ks/protocols/name/uuid">protocols</option>
<option value="https://KnowledgeShark.me/red/ks/routing/name/uuid">routing</option>
<option value="https://KnowledgeShark.me/red/ks/dissemination/name/uuid">dissemination</option>
<option value="https://KnowledgeShark.me/red/ks/operations/name/uuid">operations</option>
<option value="https://KnowledgeShark.me/red/ks/language/name/uuid">language</option>
<option value="https://KnowledgeShark.me/red/ks/performance/name/uuid">performance</option>
<option value="https://KnowledgeShark.me/red/ks/security/name/uuid">security</option>
<option value="https://KnowledgeShark.me/red/ks/maintenance/name/uuid">maintenance</option>
<option value="https://KnowledgeShark.me/red/ks/accessability/name/uuid">accessability</option>

<option>--Dog Feeding Info---</option>

<option value="https://KnowledgeShark.me/red/ks/idogwatch/howie/uuid">howie</option>
<option value="https://KnowledgeShark.me/red/ks/idogwatch/frankie/uuid">frankie</option>
<option value="https://KnowledgeShark.me/red/ks/idogwatch/sunny/uuid">sunny</option>
<option value="https://KnowledgeShark.me/red/ks/idogwatch/lacie/uuid">lacie</option>
<option value="https://KnowledgeShark.me/red/ks/idogwatch/scooby/uuid">scooby</option>
<option value="https://KnowledgeShark.me/red/ks/idogwatch/maggie/uuid">maggie</option>

<option>--Biking And Images---</option>
<option value="https://KnowledgeShark.me/red/ks/august/name/uuid">august</option>

<option value="https://KnowledgeShark.me/red/ks/biking/name/uuid">biking</option>


<option value="https://KnowledgeShark.me/red/ks/biking.da3/name/uuid">biking.da3</option>
<option value="https://KnowledgeShark.me/red/ks/biking.groupMud/name/uuid">biking.groupMud</option>
<option value="https://KnowledgeShark.me/red/ks/biking.bobsam/name/uuid">biking.bobsam</option>
<option value="https://KnowledgeShark.me/red/ks/biking.jeffjohn/name/uuid">biking.jeffjohn</option>
<option value="https://KnowledgeShark.me/red/ks/biking.lauraolga/name/uuid">biking.lauraolga</option>
<option value="https://KnowledgeShark.me/red/ks/biking.rainier/name/uuid">biking.rainier</option>
<option value="https://KnowledgeShark.me/red/ks/biking.baloon/name/uuid">biking.baloon</option>

<option>--QRAvatar---</option>
<option value="https://KnowledgeShark.me/red/ks/qravatar/name/uuid">qravatar</option>
<option value="https://KnowledgeShark.me/red/ks/qravatar/Music/uuid">Music)</option>
<option value="https://KnowledgeShark.me/red/ks/qravatar/ifLaura/uuid">#ifLaura</option>
<option value="https://KnowledgeShark.me/red/ks/qravatar/KnowledgeShark/uuid">KnowledgeShark</option>
<option value="https://KnowledgeShark.me/red/ks/qravatar/docfollow/uuid">docfollow</option>

</select>
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Invokes the DOCFOLLOW message')" />
<input type="button" class="button" id="invokeWebAddress" value="Invoke DOCFOLLOW via web" onClick="invokeWebSite('smWebAddress')" />
<label class="label">SemanticMarker&#x2122; address: </label>
<input name="smWebAddress" id="smWebAddress" maxlength=100 size="64" type="text">

<br>
<!-- dawgpackTopicId used in the sendAnySetCommand64 --->
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Changes whether the Semantic Marker\nis sent on the dawgpack party line, \nor your own topic')" />
<label class="label">DOCFOLLOW Topic:</label>
<select class="select label"  name="dawgpackTopicId" id="dawgpackTopicId">
  <option value="dawgpack">Send on Dawgpack topic</option>
  <option value="user" selected>Send on User Topic topic</option>
</select>

<!-- repeated here -->
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Sends the Semantic Marker')" />
<input type="button" class="button" id="buttonBooleanArgsM5-SM" value="Send Message" onClick="sendBooleanArgs('devices','commandBooleanM5-SM','boolArgValueM5-SM')" />
<select class="select label"  name="commandBooleanM5-SM" id="commandBooleanM5-SM">
  <option value="zoomSM">Show SemanticMarker&#x2122;</option>
</select>

<label class="label" for="boolArgValueM5-SM">Value:</label>
<select class="select label"  name="boolArgValueM5-SM" id="boolArgValueM5-SM">
  <option value="off">Show SM</option>
  <option value="on">Hide SM</option>
</select>
<br>
<!----------------------------------------------------------------------->
<h1 class="H1" onClick="hideShowMarkup(['mOTA.1','_RevertToMainOTA','mOTA.2','_QAOTA','mOTA.3','_DevOTA'])" >OTA Over the Air Updates</h1>

<h2 class="H2green" id="_RevertToMainOTA" name="_RevertToMainOTA" >Revert to MAIN OTA</h2>
<p class="label" id="mOTA.1">
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an M5 device to the main tested OTA version')" />
<input type="button" class="HELPButton" id="MAIN_OTATestM5" value="MAIN OTA M5 update" onClick="updateOTATest('devices','MAIN_M5')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an M5 device to the main tested OTA version')" />
<input type="button" class="HELPButton" id="MAIN_OTATestESPBoard" value="MAIN OTA ESP-board update" onClick="updateOTATest('devices','MAIN_ESP-BOARD')" />

<!----------------------------------------------------------------------->

<h2 class="H2orange" id="_QAOTA" name="_QAOTA" >QA OTA Test Updates</h2>
<p class="label" id="mOTA.2">
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an M5 device to the main tested OTA version')" />
<input type="button" class="OrangeButton" id="QA_OTATestM5" value="QA OTA Test M5 update" onClick="updateOTATest('devices','QA_M5')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an ESP32 Feeder device to the main tested OTA version')" />
<input type="button" class="OrangeButton" id="QA_OTATestESPBoard" value="QA OTA Test ESP-board update" onClick="updateOTATest('devices','QA_ESP-BOARD')" />

<!----------------------------------------------------------------------->

<h2 class="H2" id="_DevOTA" name="_DevOTA" >DEV OTA Test Updates</h2>
<p class="label" id="mOTA.3">
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an M5 device to the in work dev OTA version')" />
<input type="button" class="OTHERbutton" id="OTATestM5" value="OTA Test M5 update" onClick="updateOTATest('devices','M5')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an ESP32 with board PTFeeder device to the in work dev OTA version')" />
<input type="button" class="OTHERbutton" id="OTATestESPBoard" value="OTA Test ESP-board update" onClick="updateOTATest('devices','ESP-BOARD')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an original esp-32 feeder to the in work dev OTA version')" />
<input type="button" class="OTHERbutton" id="OTATestESPOrig" value="OTA Test ESP-orig update" onClick="updateOTATest('devices','ESP-ORIG')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an M5 Camera device to the in work dev OTA version')" />
<input type="button" class="OTHERbutton" id="OTATestESPM5Camera" value="OTA Test M5 Camera update" onClick="updateOTATest('devices','M5Camera')" />
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates an M5 QRReader device to the in work dev OTA version')" />
<input type="button" class="OTHERbutton" id="OTATestESPM5QRReader" value="OTA Test M5 QRReader update" onClick="updateOTATest('devices','M5QRReader')" />


<!------------ USER ACCOUNTS  ----------------------------------------------------------->
<h1 class="M5button" id="_UserAccountsTab" name="_UserAccountsTab" onClick="hideShowMarkup(['_UserAccounts'])" >USER and GROUP Account Setup</h1>
<p class="label" id="_UserAccounts">
The following messages are system password protected so ask your administrator at PetTutor or iDogWatch for updates
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Adds a user to a group. This reuires a password token that only group administrators will pocess. Removing users isnt automated yet. Contact the administrators. \nGROUP = ' + document.getElementById('_groups').value)" />
<input type="button" class="button" id="_buttonAddUserToGroup" value="Add User to MQTT Group" onClick="sendAddUserToGroup('_groups','_UserToAdd', '_TokenGroups')" />
<br>
<label class="label" for="_UserToAdd">User Name:</label>
<input class="text" name="_UserToAdd" id="_UserToAdd" length="40" type="text" value="" />
<br>
<label class="label" for="_TokenGroups">Token:</label>
<input class="text" name="_TokenGroups" id="_TokenGroups" length="40" type="password" value="" />

<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Adds new user to system. This reuqires a password token that only group administrators will pocess.  Contact the administrators.')" />
<input type="button" class="M5button" id="_buttonAddNewUser" value="Add New User to System" onClick="sendAddNewUser('_NewUserToAdd','_NewUserPassword','_NewUserGuestPassword', '_TokenNewUser')" />
<br>
<label class="label" for="_NewUserToAdd">User Name:</label>
<input class="text" name="_NewUserToAdd" id="_NewUserToAdd" length="40" type="text" value="" />
<br>
<label class="label" for="_NewUserPassword">User Password:</label>
<input class="text" name="_NewUserPassword" id="_NewUserPassword" length="40" value="" />
<br>
<label class="label" for="_NewUserGuestPassword">Guest Password:</label>
<input class="text" name="_NewUserGuestPassword" id="_NewUserGuestPassword" length="40" value="" />

<br>
<label class="label" for="_TokenNewUser">Token:</label>
<input class="text" name="_TokenNewUser" id="_TokenNewUser" length="40" type="password" value="" />

<!--
function sendUpdateUser(idUpdateUserName, idUpdateUserPassword, idUpdateUserGuestPassword, idTokenUpdateUser)
{
  // calls updateuser
}
-->
<!-- updateuser  'sendUpdateUser' password etc -->
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Updates user information. This requires a password token that only group administrators will pocess.  Contact the administrators.')" />
<input type="button" class="button" id="_buttonUpdateUser" value="Update User" onClick="sendUpdateUser('_UpdateUserName','_UpdateUserPassword','_UpdateUserGuestPassword', '_TokenUpdateUser')" />
<br>
<label class="label" for="_UpdateUserName">Existing User Name:</label>
<input class="text" name="_UpdateUserName" id="_UpdateUserName" length="40" type="text" value="" />
<br>
<label class="label" for="_UpdateUserPassword">User Password:</label>
<input class="text" name="_UpdateUserPassword" id="_UpdateUserPassword" length="40" value="" />
<br>
<label class="label" for="_UpdateUserGuestPassword">Guest Password:</label>
<input class="text" name="_UpdateUserGuestPassword" id="_UpdateUserGuestPassword" length="40" value="" />

<br>
<label class="label" for="_TokenUpdateUser">Token:</label>
<input class="text" name="_TokenUpdateUser" id="_TokenUpdateUser" length="40" type="password" value="" />

<!-- changeguestpassword  password etc -->
<!--
function endChangeGuestPassword(idChangeGuestPasswordUserName,idChangeGuestPassword,idChangeGuestPasswordGuestPassword)
{
// calls changeguestpassword
}
-->
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Changes your guest password')" />
<input type="button" class="button" id="_buttonChangeGuestPassword" value="Change Your Guest Password" onClick="sendChangeGuestPassword('_ChangeGuestPasswordUserName','_ChangeGuestPassword','_ChangeGuestPasswordGuestPassword')" />
<br>
<label class="label" for="_ChangeGuestPasswordUserName">User Name:</label>
<input class="text" name="_ChangeGuestPasswordUserName" id="_ChangeGuestPasswordUserName" length="40" type="text" value="" />
<br>
<label class="label" for="_ChangeGuestPassword">User Password:</label>
<input class="text" name="_ChangeGuestPassword" id="_ChangeGuestPassword" length="40" value="" />
<br>
<label class="label" for="_ChangeGuestPasswordGuestPassword">Guest Password:</label>
<input class="text" name="_ChangeGuestPasswordGuestPassword" id="_ChangeGuestPasswordGuestPassword" length="40" value="" />

<!-- changeuserpassword  password etc -->
<!--
function sendChangeYourPassword(idChangeYourPasswordUserName,idChangeYourPassword,idChangeYourNewPassword)
{
//calls changeuserpassword
}
-->
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Changes your password')" />
<input type="button" class="button" id="_buttonChangeYourPassword" value="Change Your Password" onClick="sendChangeYourPassword('_ChangeYourPasswordUserName','_ChangeYourPassword','_ChangeYourNewPassword')" />
<br>
<label class="label" for="_ChangeYourPasswordUserName">User Name:</label>
<input class="text" name="_ChangeYourPasswordUserName" id="_ChangeYourPasswordUserName" length="40" type="text" value="" />
<br>
<label class="label" for="_ChangeYourPassword">User Password:</label>
<input class="text" name="_ChangeYourPassword" id="_ChangeYourPassword" length="40" value="" />
<br>
<label class="label" for="_ChangeYourNewPassword">New Password:</label>
<input class="text" name="_ChangeYourNewPassword" id="_ChangeYourNewPassword" length="40" value="" />

<!----------------------------------------------------------------------->


<h2 class="H2" onClick="hideShowMarkup(['_m99.1'])">Connect to Access Point (AP) - wifi 192.168.4.1</h2>
<p class="label" id="_m99.1">
<input type="button" class="HELPButton" id="HELPButton" value="?" 
onClick="alert('After changing to WIFI of PTFeeder\nTakes browser to 192.168.4.1\nThe AP mode of the device')" />
<input type="button" class="OTHERbutton" onClick="invokeURL('http://192.168.4.1')" value="Device Credential Web Page"/>
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Displays a Help Web Document')" />
<input type="button" class="OTHERbutton" onClick="invokeURL('https://idogwatch.com/bot/help')" value="Help Information"/>
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Shows the World Wide Feeding Statistics todate')" />
<input type="button" class="OTHERbutton" onClick="invokeURL('https://idogwatch.com/bot/ui/#!/2?socketid=Gyd2JwbXTLu_z_KXAAAA')" value="Feeding Statistics"/>



<h1 class="H1">Semantic Marker&#x2122;</h1>
<p class="label">Create your own <a href="https://SemanticMarker.org">Semantic Marker</a>&#x2122; for feeding any of your named devices. 
if device is --ALL- then it's /feeedguest/pass/guestpass  but if specific name then  /feedguestdevice/pass/guestpass/dev
Provide a URL of an image, and that will be used inside your SemanticMarker&#x2122;
<br>
This will also be your guest feed so your main password is protected.
<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Specify a QRAvatar URL to customize your Semantic Marker&#x2122;')" />
<input type="button" class="H1green" id="createSM" value="Create Feeding Semantic Marker&#x2122;" onClick="createSemanticMarker('devices','semanticMarkerAvatarURL','finalSemanticMarkerImage','semanticMarkerURLId')" />
<label class="label">QRAvatar Image URL:</label><input name="semanticMarkerAvatarURL" id="semanticMarkerAvatarURL" size="64" type="text">
<p style="margin-left:100px; margin-right:50px;" id="finalSemanticMarkerImage"></p>

<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('Whether QRAvatar is Circular or Square')" />
<label class="label" for="boolArgValueCircular">QRAvatar Image Kind:</label>
<select class="select label"  name="boolArgValueCircular" id="boolArgValueCircular">
  <option value="on">Circular</option>
  <option value="off">Square</option>
</select>

<br>
<br>
<input type="button" class="HELPButton" id="HELPButton" value="?" onClick="alert('URL of the Semantic Marker to create')" />
<input type="button" class="button" id="createSMAny" value="Create Semantic Marker&#x2122;" onClick="createSemanticMarkerPathId('semanticMarkerURL','semanticMarkerAvatarURL','finalSemanticMarkerImage','semanticMarkerURLId')" />
<label class="label">Any Semantic Marker&#x2122; Address</label><input name="semanticMarkerURL" id="semanticMarkerURL" size="64" type="text">
<p class="label" id="semanticMarkerURLId">url</p>
<br><br>
<br>

<br><br>
<img src="https://KnowledgeShark.me/images/KCNewLabel600-small.png" width="500"></a>
<br><br>
&#169;2023 <a href="https://KonaCurrents.com">KonaCurrents</a>, LLC

<h3>10.2.23 v9.8 MQTT Groups & M5QRCodeReader & dev for SM & SMART Decks first time</h3>
